<!DOCTYPE html>
<html lang="pt-br" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroScript - Suíte Clínica Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        navy: { 950: '#0B101B', 900: '#141C2F', 800: '#1E293B' },
                        // Cores personalizadas baseadas na foto
                        'cardio-red': '#991b1b', 
                        'score-blue': '#1e40af',
                        'lipid-brown': '#9a3412',
                        'dark-slate': '#334155'
                    },
                    boxShadow: {
                        'glow-pink': '0 4px 15px -3px rgba(236, 72, 153, 0.4)',
                        'glow-blue': '0 4px 15px -3px rgba(59, 130, 246, 0.4)',
                        'glow-green': '0 4px 15px -3px rgba(16, 185, 129, 0.4)',
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; transition: background-color 0.3s ease; -webkit-tap-highlight-color: transparent; }
        .dark body { background-color: #0B101B; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .dark .glass-panel { background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .dark .glass-nav { background: rgba(20, 28, 47, 0.9); border: 1px solid rgba(255, 255, 255, 0.05); }

        /* Botões Padronizados */
        .btn-action-pill { 
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; 
            padding: 0 16px; height: 42px; border-radius: 12px; 
            font-size: 11px; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; color: white; 
            transition: all 0.2s ease; white-space: nowrap; flex: 1; min-width: 80px;
        }
        .btn-action-pill:active { transform: scale(0.96); filter: brightness(0.9); }
        
        /* Cards IA - Estilo "App Nativo" Sólido */
        .ai-btn-card { 
            height: 75px; border-radius: 16px; display: flex; align-items: center; padding: 0 16px; 
            transition: transform 0.2s, filter 0.2s; width: 100%; position: relative; overflow: hidden; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .ai-btn-card:active { transform: scale(0.98); }
        .dark .ai-btn-card { box-shadow: 0 2px 8px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); }

        /* Ícone de lápis decorativo no card (estilo da foto) */
        .card-edit-icon { position: absolute; top: 10px; right: 10px; opacity: 0.3; width: 14px; height: 14px; }

        .tab-content { display: none; animation: fadeIn 0.2s ease-out; }
        .tab-content.active { display: flex; flex-direction: column; height: 100%; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .nav-item.active { color: #4f46e5; }
        .dark .nav-item.active { color: #818cf8; }
        
        .prose h1, .prose h2, .prose h3 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin: 1em 0; }
        .prose strong { color: #4f46e5; }
        .dark .prose strong { color: #818cf8; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <header class="h-14 glass-panel flex items-center justify-between px-5 z-40 shrink-0">
        <div class="flex items-center gap-2.5">
            <div class="w-7 h-7 bg-gradient-to-br from-indigo-600 to-blue-600 rounded-lg flex items-center justify-center text-white shadow-md">
                <i data-lucide="brain-circuit" class="w-4 h-4"></i>
            </div>
            <h1 class="text-lg font-bold tracking-tight text-slate-800 dark:text-white">Neuro<span class="text-indigo-600 dark:text-indigo-400">Script</span></h1>
        </div>
        <button onclick="app.openModal('configModal')" class="p-2 text-slate-400 hover:text-slate-600 dark:hover:text-white transition relative rounded-full hover:bg-slate-100 dark:hover:bg-white/5">
            <i data-lucide="settings" class="w-5 h-5"></i>
            <span id="configDot" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white dark:border-navy-900"></span>
        </button>
    </header>

    <main class="flex-1 flex overflow-hidden relative pb-24">
        <div id="mainPanel" class="flex-1 flex flex-col min-w-0 bg-slate-50 dark:bg-navy-950 transition-colors duration-300 relative z-10">
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-5">
                
                <div id="view-patient" class="tab-content active space-y-4">
                    <div class="bg-white dark:bg-navy-900 rounded-2xl p-5 shadow-sm border border-slate-200/60 dark:border-navy-800">
                        <div class="flex flex-col gap-3 mb-6">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xs font-bold uppercase tracking-widest text-slate-400 dark:text-slate-500 flex items-center gap-2">
                                    <i data-lucide="file-text" class="w-4 h-4"></i> Prontuário
                                </h2>
                                <button onclick="app.clearData()" class="text-[10px] text-slate-400 hover:text-red-500 transition flex items-center gap-1 bg-slate-100 dark:bg-navy-800 px-2 py-1 rounded"><i data-lucide="trash-2" class="w-3 h-3"></i> Limpar</button>
                            </div>

                            <div class="flex justify-end gap-2 w-full mt-1">
                                <button onclick="app.openModal('obstetricModal')" class="btn-action-pill bg-gradient-to-r from-pink-600 to-rose-600 shadow-glow-pink">
                                    <i data-lucide="baby" class="w-4 h-4"></i> IG
                                </button>
                                <button onclick="app.openMagicSoap()" class="btn-action-pill bg-gradient-to-r from-indigo-600 to-blue-700 shadow-glow-blue">
                                    <i data-lucide="wand-2" class="w-4 h-4"></i> Magic
                                </button>
                                <button onclick="app.openFlowchartModal()" class="btn-action-pill bg-gradient-to-r from-emerald-600 to-teal-700 shadow-glow-green" style="flex: 1.2;"> <i data-lucide="git-merge" class="w-4 h-4"></i> Fluxo
                                </button>
                            </div>
                        </div>

                        <div class="mb-5 relative group">
                            <input id="patientName" oninput="app.updateDoc()" class="w-full text-lg font-bold bg-slate-50 dark:bg-navy-950/50 rounded-xl px-3 py-3 border border-slate-200 dark:border-navy-800 outline-none focus:border-indigo-500 dark:text-white placeholder-slate-300" placeholder="Nome do Paciente...">
                        </div>

                        <div class="grid gap-3">
                            <div class="bg-slate-50 dark:bg-navy-950/50 rounded-xl border border-slate-100 dark:border-navy-800 focus-within:border-indigo-500 transition-all">
                                <label class="text-[10px] font-bold text-indigo-500 uppercase px-3 pt-2 block">S - Subjetivo</label>
                                <textarea id="soapS" class="w-full bg-transparent p-3 text-sm outline-none resize-none h-20 dark:text-slate-200 placeholder-slate-400"></textarea>
                            </div>
                            <div class="bg-slate-50 dark:bg-navy-950/50 rounded-xl border border-slate-100 dark:border-navy-800 focus-within:border-emerald-500 transition-all">
                                <label class="text-[10px] font-bold text-emerald-500 uppercase px-3 pt-2 block">O - Objetivo</label>
                                <textarea id="soapO" class="w-full bg-transparent p-3 text-sm outline-none resize-none h-24 dark:text-slate-200 placeholder-slate-400"></textarea>
                                <div id="imagePreviewArea" class="px-3 pb-2 flex gap-2 flex-wrap"></div>
                            </div>
                            <div class="bg-slate-50 dark:bg-navy-950/50 rounded-xl border border-slate-100 dark:border-navy-800 focus-within:border-orange-500 transition-all">
                                <label class="text-[10px] font-bold text-orange-500 uppercase px-3 pt-2 block">A - Avaliação</label>
                                <textarea id="soapA" class="w-full bg-transparent p-3 text-sm outline-none resize-none h-20 dark:text-slate-200 placeholder-slate-400"></textarea>
                            </div>
                            <div class="bg-slate-50 dark:bg-navy-950/50 rounded-xl border border-slate-100 dark:border-navy-800 focus-within:border-blue-500 transition-all">
                                <label class="text-[10px] font-bold text-blue-500 uppercase px-3 pt-2 block">P - Plano</label>
                                <textarea id="soapP" class="w-full bg-transparent p-3 text-sm outline-none resize-none h-20 dark:text-slate-200 placeholder-slate-400"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-ai" class="tab-content space-y-4">
                    <div class="sticky top-0 bg-slate-50/95 dark:bg-navy-950/95 backdrop-blur z-10 pb-2 pt-1">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400"></i>
                            <input oninput="app.renderAITools(this.value)" class="w-full bg-white dark:bg-navy-900 border border-slate-200 dark:border-navy-800 rounded-2xl py-3 pl-12 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white shadow-sm" placeholder="Buscar ferramenta (Ex: Risco, ECG...)">
                        </div>
                        <div class="flex gap-2 overflow-x-auto py-2 no-scrollbar mt-1">
                            <button onclick="app.filterAI('Cardiologia')" class="px-3 py-1.5 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 text-xs font-bold whitespace-nowrap">Cardio</button>
                            <button onclick="app.filterAI('Pediatria')" class="px-3 py-1.5 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-xs font-bold whitespace-nowrap">Pediatria</button>
                            <button onclick="app.filterAI('Emergência')" class="px-3 py-1.5 rounded-lg bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 text-xs font-bold whitespace-nowrap">Emergência</button>
                             <button onclick="app.filterAI('Geral')" class="px-3 py-1.5 rounded-lg bg-slate-200 dark:bg-slate-800 text-slate-700 dark:text-slate-300 text-xs font-bold whitespace-nowrap">Todos</button>
                        </div>
                    </div>
                    <div id="aiToolsGrid" class="grid grid-cols-2 gap-3 pb-20"></div>
                </div>

                <div id="view-pharmacy" class="tab-content space-y-4">
                    <div class="text-center text-slate-400 mt-10">Módulo de Farmácia (Em breve)</div>
                </div>
                <div id="view-exams" class="tab-content space-y-4">
                     <div class="text-center text-slate-400 mt-10">Módulo de Exames (Em breve)</div>
                </div>

            </div>
        </div>
    </main>

    <div class="fixed bottom-6 left-0 right-0 flex justify-center z-50 pointer-events-none no-print">
        <nav class="glass-nav shadow-nav-float dark:shadow-nav-float-dark rounded-full px-2 py-2 flex items-center gap-1 pointer-events-auto transition-all duration-300">
            <button onclick="app.switchTab('patient')" id="nav-patient" class="nav-item w-12 h-12 rounded-full flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-slate-100 dark:hover:bg-white/10 transition-all active"><i data-lucide="user-circle-2" class="w-8 h-8"></i></button>
            <button onclick="app.switchTab('ai')" id="nav-ai" class="nav-item w-12 h-12 rounded-full flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-slate-100 dark:hover:bg-white/10 transition-all"><i data-lucide="sparkles" class="w-8 h-8"></i></button>
            <button onclick="app.switchTab('pharmacy')" id="nav-pharmacy" class="nav-item w-12 h-12 rounded-full flex items-center justify-center text-slate-400 hover:text-emerald-600 hover:bg-slate-100 dark:hover:bg-white/10 transition-all"><i data-lucide="pill" class="w-8 h-8"></i></button>
            <button onclick="app.switchTab('exams')" id="nav-exams" class="nav-item w-12 h-12 rounded-full flex items-center justify-center text-slate-400 hover:text-orange-600 hover:bg-slate-100 dark:hover:bg-white/10 transition-all"><i data-lucide="microscope" class="w-8 h-8"></i></button>
        </nav>
    </div>

    <div id="magicSoapModal" class="hidden fixed inset-0 z-[100] bg-navy-950/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white dark:bg-navy-900 w-full max-w-lg rounded-3xl shadow-2xl p-6 border border-slate-200 dark:border-navy-800">
            <h3 class="text-xl font-bold mb-4 dark:text-white flex items-center gap-2 text-indigo-600"><i data-lucide="wand-2" class="w-6 h-6"></i> Magic SOAP AI</h3>
            <p class="text-xs text-slate-500 mb-4">Transcreva áudio ou manuscritos para estruturar o prontuário.</p>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <label class="flex flex-col items-center justify-center p-4 bg-slate-50 dark:bg-navy-950 border border-dashed border-slate-300 dark:border-navy-700 rounded-xl cursor-pointer hover:bg-indigo-50 dark:hover:bg-navy-800 transition">
                    <i data-lucide="mic" class="w-6 h-6 text-slate-400 mb-2"></i><span class="text-xs font-bold text-slate-500">Enviar Áudio</span>
                    <input type="file" accept="audio/*" class="hidden" onchange="app.handleMagicUpload(this, 'audio')">
                </label>
                <label class="flex flex-col items-center justify-center p-4 bg-slate-50 dark:bg-navy-950 border border-dashed border-slate-300 dark:border-navy-700 rounded-xl cursor-pointer hover:bg-emerald-50 dark:hover:bg-navy-800 transition">
                    <i data-lucide="file-edit" class="w-6 h-6 text-slate-400 mb-2"></i><span class="text-xs font-bold text-slate-500">Manuscrito</span>
                    <input type="file" accept="image/*" class="hidden" onchange="app.handleMagicUpload(this, 'image')">
                </label>
            </div>
            <textarea id="magicInput" class="w-full h-32 bg-slate-50 dark:bg-navy-950 rounded-2xl p-4 text-sm border border-slate-200 dark:border-navy-800 outline-none mb-4 dark:text-white resize-none" placeholder="Ou digite o caso clínico..."></textarea>
            <div class="flex gap-3"><button onclick="app.processMagicSoap()" id="btnMagic" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">Processar (Gemini 1.5)</button><button onclick="app.closeModal('magicSoapModal')" class="px-6 bg-slate-100 dark:bg-navy-800 text-slate-600 rounded-xl font-bold">Cancelar</button></div>
        </div>
    </div>

    <div id="flowchartModal" class="hidden fixed inset-0 z-[100] bg-navy-950/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white dark:bg-navy-900 w-full max-w-lg rounded-3xl shadow-2xl p-6 border border-slate-200 dark:border-navy-800">
            <h3 class="text-xl font-bold mb-4 dark:text-white flex items-center gap-2 text-emerald-600"><i data-lucide="git-merge" class="w-6 h-6"></i> Fluxograma Clínico</h3>
            <textarea id="flowchartInput" class="w-full h-32 bg-slate-50 dark:bg-navy-950 rounded-2xl p-4 text-sm border border-slate-200 dark:border-navy-800 outline-none mb-4 dark:text-white resize-none" placeholder="Descreva o protocolo (ex: Manejo de Sepse)..."></textarea>
            <div class="flex gap-3"><button onclick="app.generateFlowchartDirect()" id="btnFlowchart" class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg">Gerar Diagrama</button><button onclick="app.closeModal('flowchartModal')" class="px-6 bg-slate-100 dark:bg-navy-800 text-slate-600 rounded-xl font-bold">Cancelar</button></div>
        </div>
    </div>

    <div id="configModal" class="hidden fixed inset-0 z-[100] bg-navy-950/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white dark:bg-navy-900 w-full max-w-sm rounded-3xl shadow-2xl p-6 border border-slate-200 dark:border-navy-800">
            <h3 class="text-lg font-bold dark:text-white mb-4">Configurações</h3>
            <div class="flex items-center justify-between bg-slate-50 dark:bg-navy-950 p-3 rounded-xl mb-4"><span class="text-sm font-bold text-slate-600 dark:text-slate-300"><i data-lucide="moon" class="inline w-4 h-4 mr-2"></i>Modo Escuro</span><button onclick="app.toggleTheme()" class="w-11 h-6 bg-slate-200 dark:bg-indigo-600 rounded-full relative"><span class="block w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-all dark:left-6"></span></button></div>
            <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">API Key (Google Gemini)</label>
            <input id="apiKey" type="password" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-navy-950 border border-slate-200 dark:border-navy-800 text-sm dark:text-white outline-none mb-4" placeholder="Cole sua API Key aqui">
            <button onclick="app.saveConfig()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm">Salvar</button>
            <p class="text-[10px] text-center mt-2 text-slate-400">A chave é salva apenas no seu navegador.</p>
        </div>
    </div>

    <div id="aiModal" class="hidden fixed inset-0 z-[100] bg-navy-950/80 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white dark:bg-navy-900 w-full max-w-3xl rounded-3xl shadow-2xl border border-slate-200 dark:border-navy-800 flex flex-col max-h-[85vh]">
            <div class="p-6 border-b border-slate-100 dark:border-navy-800 flex justify-between items-center"><h3 id="aiModalTitle" class="text-xl font-bold dark:text-white">Resultado</h3><button onclick="app.closeModal('aiModal')"><i data-lucide="x" class="w-5 h-5 dark:text-white"></i></button></div>
            <div class="p-8 overflow-y-auto custom-scrollbar bg-slate-50/50 dark:bg-navy-950/50 flex-1">
                <div id="aiContent" class="prose prose-sm dark:prose-invert max-w-none text-slate-700 dark:text-slate-300"></div>
                <div id="flowchartArea" class="hidden mt-8 text-center"><div id="genImagePlaceholder"></div></div>
            </div>
        </div>
    </div>

    <div id="obstetricModal" class="hidden fixed inset-0 z-[100] bg-navy-950/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white dark:bg-navy-900 w-full max-w-md rounded-3xl shadow-2xl p-6 border border-slate-200 dark:border-navy-800">
             <h3 class="text-xl font-bold mb-6 dark:text-white flex items-center gap-2 text-pink-600"><i data-lucide="baby" class="w-6 h-6"></i> Calculadora Obstétrica</h3>
             <div class="bg-pink-50 dark:bg-pink-900/10 p-4 rounded-2xl mb-4">
                 <label class="block text-xs font-bold text-pink-600 mb-2 uppercase">DUM</label>
                 <input type="date" id="calcDum" onchange="app.calcObs()" class="w-full p-3 rounded-xl border border-pink-200 dark:border-pink-900 text-sm outline-none dark:bg-navy-950 dark:text-white">
             </div>
             <div class="flex justify-between items-end mb-4"><span class="text-xs font-bold text-slate-400">IG:</span> <span id="resIg" class="text-2xl font-bold dark:text-white">--</span></div>
             <div class="flex justify-between items-end mb-6"><span class="text-xs font-bold text-slate-400">DPP:</span> <span id="resDpp" class="text-lg font-bold dark:text-white">--</span></div>
             <div class="flex gap-3"><button onclick="app.pasteIg()" class="flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold">Inserir no SOAP</button><button onclick="app.closeModal('obstetricModal')" class="px-4 bg-slate-100 dark:bg-navy-800 rounded-xl font-bold text-slate-600">Fechar</button></div>
        </div>
    </div>

    <script>
        const GEMINI_MODEL = "gemini-1.5-flash"; 
        
        const AI_CATEGORIES = {
            'Cardiologia': ['Risco CV (SBC)', 'Score CHA2DS2-VASc', 'Score HAS-BLED', 'Interpretação ECG', 'Critérios Framingham', 'Score HEART', 'TIMI Risk', 'Killip Class', 'NYHA Class', 'Manejo FA', 'Manejo ICC', 'Manejo HAS', 'Manejo SCA', 'Score GRACE', 'Duke Criteria (Endocardite)', 'Manejo Dislipidemia'],
            'Emergência': ['Protocolo Sepse (qSOFA)', 'Protocolo Sepse (SOFA)', 'Glasgow Coma Scale', 'Protocolo AVC (NIHSS)', 'Protocolo Trauma (ATLS)', 'Manejo PCR (ACLS)', 'Protocolo Anafilaxia', 'Manejo Intoxicação', 'Score MEWS', 'Protocolo Dor Torácica', 'Manejo Queimaduras (Parkland)', 'Manejo Cetoacidose'],
            'Pediatria': ['Calculadora Doses Pediátricas', 'Curvas Crescimento (OMS)', 'Marcos Desenvolvimento', 'Manejo Bronquiolite', 'Score Apgar', 'Silverman-Andersen', 'Hidratação (Holliday-Segar)', 'Manejo Febre', 'Calendário Vacinal', 'Score PEWS'],
            'Ginecologia': ['Rastreio Câncer Colo', 'Manejo Sangramento Uterino', 'Critérios SOP (Rotterdam)', 'Manejo Endometriose', 'Protocolo DIP', 'Planejamento Familiar', 'Manejo Climatério', 'Protocolo Candidíase', 'Protocolo Vaginose'],
            'Obstetrícia': ['Risco Pré-Eclampsia', 'Manejo Diabetes Gestacional', 'Manejo SHEG', 'Protocolo Trabalho Parto', 'Bishop Score', 'Manejo Hemorragia Pós-Parto', 'Medicações na Lactação'],
            'Nefrologia': ['Clareance Creatinina (CKD-EPI)', 'Cockcroft-Gault', 'Estadiamento DRC', 'Manejo Hipercalemia', 'Manejo Hiponatremia', 'Risco Injúria Renal (RIFLE)'],
            'Neurologia': ['ABCD2 Score', 'Manejo Cefaleias', 'Protocolo Enxaqueca', 'Hunt-Hess (Hemorragia)', 'Manejo Delirium', 'Mini-Mental', 'Manejo Vertigem'],
            'Psiquiatria': ['Critérios DSM-5 Depressão', 'Critérios DSM-5 Ansiedade', 'Manejo Insônia', 'SAD PERSONS (Suicídio)', 'Protocolo Abstinência (CIWA)', 'Manejo Bipolar'],
            'Infectologia': ['Manejo Dengue (MS)', 'Manejo Influenza', 'Manejo COVID-19', 'CURB-65 (Pneumonia)', 'Protocolo ITU', 'Manejo Celulite/Erisipela', 'Protocolo HIV/PrEP/PEP'],
            'Geral': ['Resumo do Caso', 'Gerar Atestado', 'Gerar Encaminhamento', 'Orientação ao Paciente', 'Revisão Medicamentosa', 'Interação Medicamentosa']
        };

        // LÓGICA DE ÍCONES E CORES ESPECÍFICA (Estilo Foto)
        // Função Helper para determinar estilo baseado no NOME da ferramenta, não só categoria
        function getToolStyle(name, category) {
            let icon = 'activity';
            let bgClass = 'bg-slate-700'; // Default Dark
            let lightClass = 'bg-slate-600'; // Default Light

            const n = name.toLowerCase();

            // 1. Definição de Ícones Específicos
            if (n.includes('risco') || n.includes('score') || n.includes('critérios')) icon = 'bar-chart-2';
            if (n.includes('ecg')) icon = 'heart-pulse';
            if (n.includes('has-bled') || n.includes('sangue') || n.includes('sepse')) icon = 'droplet';
            if (n.includes('criança') || n.includes('pediátrica') || n.includes('crescimento') || category === 'Pediatria') icon = 'baby';
            if (n.includes('cérebro') || n.includes('neuro') || n.includes('glasgow') || n.includes('mental')) icon = 'brain-circuit';
            if (n.includes('pulmão') || n.includes('asma') || n.includes('pneumonia')) icon = 'wind';
            if (n.includes('rim') || n.includes('renal') || n.includes('creatinina')) icon = 'filter';
            if (n.includes('gestante') || n.includes('parto') || category === 'Obstetrícia') icon = 'baby';
            if (n.includes('dengue') || n.includes('influenza') || n.includes('vírus')) icon = 'bug';
            if (n.includes('medicamento') || n.includes('dose') || n.includes('interação')) icon = 'pill';

            // 2. Definição de Cores Baseadas na Foto (Sólidas)
            // Vermelho Escuro/Bordô (Cardio, Risco, Hipertensão)
            if (category === 'Cardiologia' || n.includes('hipertensão') || n.includes('risco')) {
                bgClass = 'bg-[#7f1d1d]'; // Red 900 custom
                lightClass = 'bg-[#991b1b]'; // Red 800
            }
            // Azul (Scores, Neuro)
            if (n.includes('cha2ds2') || category === 'Neurologia' || n.includes('glasgow')) {
                bgClass = 'bg-[#1e3a8a]'; // Blue 900 custom
                lightClass = 'bg-[#1e40af]'; // Blue 800
            }
            // Laranja/Marrom (Dislipidemia, Metabólico)
            if (n.includes('dislipidemia') || n.includes('diabetes') || n.includes('metabólico')) {
                bgClass = 'bg-[#7c2d12]'; // Orange 900 custom
                lightClass = 'bg-[#9a3412]'; // Orange 800
            }
            // Roxo (Sepse, Infecção Grave)
            if (n.includes('sepse') || n.includes('infecção') || category === 'Infectologia') {
                bgClass = 'bg-[#581c87]'; // Purple 900
                lightClass = 'bg-[#6b21a8]'; // Purple 800
            }
            // Verde Petróleo (Geral, Nefro)
            if (category === 'Nefrologia' || category === 'Geral') {
                bgClass = 'bg-[#134e4a]'; // Teal 900
                lightClass = 'bg-[#115e59]'; // Teal 800
            }

            return { icon, bgClass, lightClass };
        }

        let ALL_TOOLS = [];
        Object.keys(AI_CATEGORIES).forEach(cat => {
            AI_CATEGORIES[cat].forEach(tool => {
                const style = getToolStyle(tool, cat);
                ALL_TOOLS.push({ 
                    id: tool.replace(/\s+/g,'_').toLowerCase(), 
                    cat: cat, 
                    label: tool, 
                    prompt: `Atue como médico especialista. Baseado nos dados do prontuário, realize: ${tool}. Seja técnico.`, 
                    ...style 
                });
            });
        });

        window.app = {
            state: { config: JSON.parse(localStorage.getItem('neuro_config')) || { apiKey: '' }, magicAttachment: null },

            init: function() { 
                this.loadTheme(); 
                this.updateConfigUI(); 
                this.renderAITools(); 
                lucide.createIcons();
            },

            handleMagicUpload: function(input, type) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        app.state.magicAttachment = { type: type, data: e.target.result.split(',')[1], mime: input.files[0].type };
                        input.parentElement.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-50');
                        alert("Arquivo anexado!");
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            processMagicSoap: async function() {
                if(!this.state.config.apiKey) return alert("Configure sua API Key primeiro!");
                const btn = document.getElementById('btnMagic'); const old = btn.innerText; btn.innerText = 'Processando...';
                
                const textInput = document.getElementById('magicInput').value;
                const context = "Você é um assistente médico. Estruture as informações em SOAP JSON {s,o,a,p}. Retorne APENAS o JSON puro.";
                
                const parts = [{ text: context }];
                if (this.state.magicAttachment) {
                    parts.push({ inlineData: { mimeType: this.state.magicAttachment.mime, data: this.state.magicAttachment.data } });
                    parts.push({ text: this.state.magicAttachment.type === 'audio' ? "Transcreva o áudio." : "Leia o manuscrito." });
                } else { parts.push({ text: `Texto: "${textInput}"` }); }

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${this.state.config.apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: parts }] })
                    });
                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);
                    
                    let rawText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                    const json = JSON.parse(rawText);

                    ['s','o','a','p'].forEach(k => document.getElementById('soap'+k.toUpperCase()).value = json[k] || json[k.toUpperCase()] || '');
                    this.closeModal('magicSoapModal'); this.state.magicAttachment = null;
                } catch(e) { alert("Erro: " + e.message); }
                btn.innerText = old;
            },

            generateFlowchartDirect: async function() {
                if(!this.state.config.apiKey) return alert("Sem API Key.");
                const prompt = document.getElementById('flowchartInput').value;
                this.closeModal('flowchartModal');
                
                document.getElementById('aiModalTitle').innerText = "Fluxograma Clínico";
                document.getElementById('aiContent').innerHTML = ''; 
                document.getElementById('flowchartArea').classList.remove('hidden');
                document.getElementById('genImagePlaceholder').innerHTML = '<div class="animate-pulse text-indigo-600 font-bold">Gerando diagrama visual...</div>';
                this.openModal('aiModal');

                const sysPrompt = `Crie um diagrama SVG médico e limpo sobre: ${prompt}. Use retângulos arredondados, setas e texto legível. Fundo branco. Retorne APENAS o SVG puro.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${this.state.config.apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: sysPrompt }] }] })
                    });
                    const data = await response.json();
                    let svg = data.candidates[0].content.parts[0].text.replace(/```xml|```svg|```/g,'');
                    const start = svg.indexOf('<svg'); const end = svg.indexOf('</svg>') + 6;
                    if(start !== -1) svg = svg.substring(start, end);
                    document.getElementById('genImagePlaceholder').innerHTML = svg;
                } catch(e) { document.getElementById('genImagePlaceholder').innerHTML = "Erro ao gerar."; }
            },

            renderAITools: function(filterText='') {
                const grid = document.getElementById('aiToolsGrid');
                const isDark = document.documentElement.classList.contains('dark');
                
                const filtered = ALL_TOOLS.filter(t => t.label.toLowerCase().includes(filterText.toLowerCase()));
                
                grid.innerHTML = filtered.map(t => {
                    // Aplica a lógica de cores contrastantes/sólidas
                    const colorClass = isDark ? t.bgClass : t.lightClass;
                    
                    return `<button onclick="app.callAI('${t.id}')" class="ai-btn-card ${colorClass} text-white hover:brightness-110">
                        <i data-lucide="edit-2" class="card-edit-icon text-white"></i>
                        <div class="mr-3 shrink-0"><i data-lucide="${t.icon}" class="w-6 h-6 text-white"></i></div>
                        <div class="text-left w-full overflow-hidden">
                            <div class="font-bold text-xs leading-tight line-clamp-2 text-white">${t.label}</div>
                        </div>
                    </button>`;
                }).join('');
                lucide.createIcons();
            },

            filterAI: function(cat) {
                const input = document.querySelector('#view-ai input');
                input.value = cat === 'Geral' ? '' : cat;
                this.renderAITools(input.value);
            },

            callAI: async function(toolId) {
                if(!this.state.config.apiKey) return this.openModal('configModal');
                const tool = ALL_TOOLS.find(t => t.id === toolId);
                document.getElementById('aiModalTitle').innerText = tool.label;
                document.getElementById('aiContent').innerText = 'Analisando dados do prontuário...';
                document.getElementById('flowchartArea').classList.add('hidden');
                this.openModal('aiModal');

                const soapContext = `S:${document.getElementById('soapS').value} O:${document.getElementById('soapO').value} A:${document.getElementById('soapA').value} P:${document.getElementById('soapP').value}`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${this.state.config.apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: tool.prompt + "\n\nCASO:\n" + soapContext }] }] })
                    });
                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);
                    document.getElementById('aiContent').innerHTML = data.candidates[0].content.parts[0].text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                } catch(e) { document.getElementById('aiContent').innerText = "Erro: " + e.message; }
            },

            switchTab: function(tabId) { document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.getElementById('view-'+tabId).classList.add('active'); document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); const nav = document.getElementById('nav-'+tabId); if(nav) nav.classList.add('active'); },
            toggleTheme: function() { document.documentElement.classList.toggle('dark'); localStorage.setItem('neuro_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); this.renderAITools(); },
            loadTheme: function() { if(localStorage.getItem('neuro_theme') === 'dark') document.documentElement.classList.add('dark'); },
            openModal: function(id) { document.getElementById(id).classList.remove('hidden'); },
            closeModal: function(id) { document.getElementById(id).classList.add('hidden'); },
            saveConfig: function() { this.state.config = { apiKey: document.getElementById('apiKey').value }; localStorage.setItem('neuro_config', JSON.stringify(this.state.config)); this.updateConfigUI(); this.closeModal('configModal'); },
            updateConfigUI: function() { document.getElementById('apiKey').value = this.state.config.apiKey; if(this.state.config.apiKey) { document.getElementById('configDot').classList.remove('hidden'); document.getElementById('configDot').classList.replace('bg-red-500', 'bg-emerald-500'); } },
            clearData: function() { if(confirm("Limpar prontuário?")) { ['patientName','soapS','soapO','soapA','soapP'].forEach(id => document.getElementById(id).value = ''); document.getElementById('imagePreviewArea').innerHTML = ''; } },
            openMagicSoap: function() { this.openModal('magicSoapModal'); },
            openFlowchartModal: function() { this.openModal('flowchartModal'); },
            calcObs: function() { const dum = new Date(document.getElementById('calcDum').value); if(!isNaN(dum)) { const diff = Math.floor((new Date() - dum) / 86400000); const dpp = new Date(dum); dpp.setDate(dum.getDate() + 280); document.getElementById('resIg').innerText = `${Math.floor(diff/7)}s ${diff%7}d`; document.getElementById('resDpp').innerText = dpp.toLocaleDateString('pt-BR'); } },
            pasteIg: function() { document.getElementById('soapS').value += `\nDUM: ${document.getElementById('calcDum').value}, IG: ${document.getElementById('resIg').innerText}, DPP: ${document.getElementById('resDpp').innerText}`; this.closeModal('obstetricModal'); },
            updateDoc: function() {}
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
