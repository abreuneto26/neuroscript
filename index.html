<!DOCTYPE html>
<html lang="pt-br" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroScript - Suíte Clínica</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'], 
                        arial: ['Arial', 'Helvetica', 'sans-serif'], 
                    },
                    colors: {
                        medical: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    },
                    boxShadow: {
                        'paper': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0,0,0,0.02)',
                    }
                }
            }
        }
    </script>

    <!-- Ícones e PDF -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .dark body { background-color: #0f172a; }
        
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }

        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(226, 232, 240, 0.6); }
        .dark .glass-panel { background: rgba(15, 23, 42, 0.8); border-bottom: 1px solid rgba(51, 65, 85, 0.5); }

        .tab-content { display: none !important; animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-content.active { display: flex !important; flex-direction: column; height: 100%; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .doc-switch-btn { @apply px-4 py-2 text-xs font-bold rounded-lg transition-all border shadow-sm; }
        .doc-switch-btn.active { @apply bg-slate-800 text-white border-slate-800 shadow-md scale-105 dark:bg-white dark:text-slate-900; }
        .doc-switch-btn.inactive { @apply bg-white text-slate-500 border-slate-200 hover:bg-slate-50 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700 dark:hover:bg-slate-700; }

        .ai-card { transition: all 0.2s ease-out; border: 1px solid transparent; }
        .ai-card:hover { transform: translateY(-1px); filter: brightness(0.95); }
        .ai-card:active { transform: scale(0.99); }

        .bottom-nav-item { @apply flex flex-col items-center justify-center w-full h-full text-slate-400 transition-all duration-300 rounded-xl scale-90 gap-1; }
        .bottom-nav-item.active { @apply bg-gradient-to-br from-cyan-400 to-blue-600 text-white shadow-lg shadow-cyan-500/30 scale-100 -translate-y-2; }
        .bottom-nav-item.active i { @apply text-white fill-white/20 stroke-[2.5px]; }

        /* Estilos de Impressão Específicos - ARIAL 12 */
        #prescriptionPaper {
            font-family: 'Arial', sans-serif !important;
            font-size: 12pt !important;
            line-height: 1.5;
            color: #000 !important;
        }
        #prescriptionPaper h1, #prescriptionPaper h2, #prescriptionPaper h3, #prescriptionPaper div, #prescriptionPaper p, #prescriptionPaper span, #prescriptionPaper input, #prescriptionPaper textarea {
            font-family: 'Arial', sans-serif !important;
        }
        .print-patient-name {
            font-size: 12pt !important;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .hospital-line {
            border-bottom: 1px solid #ccc;
            min-height: 28px;
            display: flex;
            align-items: center;
        }
        .hospital-line-num {
            width: 40px;
            text-align: center;
            border-right: 1px solid #ccc;
            font-weight: bold;
            font-size: 10pt;
            color: #666;
        }
        .hospital-line-input {
            flex: 1;
            padding-left: 8px;
            font-family: 'Arial', sans-serif;
            font-size: 12pt;
            border: none;
            outline: none;
            background: transparent;
            text-transform: uppercase;
        }

        /* Ajuste para Tela Cheia no Mobile */
        #documentPanel.mobile-fullscreen {
            display: flex !important;
            position: fixed !important;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999;
            background: #f8fafc; /* Slate-50 */
            padding: 0 !important;
            overflow-y: auto;
        }
        .dark #documentPanel.mobile-fullscreen {
            background: #0f172a;
        }

        @media print {
            @page { margin: 0; size: auto; } 
            body { background: white; } 
            .no-print { display: none !important; }
            .print-container { 
                box-shadow: none !important; border: none !important; margin: 0 !important; 
                padding: 0 !important; height: 100vh !important; width: 100% !important; 
                transform: none !important; overflow: hidden !important;
            }
            #documentPanel { overflow: visible !important; padding: 0 !important; position: static !important; display: block !important; }
        }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-100 h-screen overflow-hidden flex flex-col">

    <!-- HEADER (Escondido no modo doc mobile) -->
    <header id="mainHeader" class="w-full z-50 glass-panel h-16 flex items-center justify-between px-6 no-print shrink-0 shadow-sm relative transition-all">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-cyan-400 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-purple-500/20 shrink-0">
                <i data-lucide="brain-circuit" class="text-white w-6 h-6 stroke-[2.5px]"></i>
            </div>
            <div class="flex flex-col justify-center h-full pt-1">
                <h1 class="text-2xl font-bold tracking-tight text-slate-900 dark:text-white">Neuro<span class="text-cyan-500 dark:text-cyan-400">Script</span></h1>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="app.toggleTheme()" class="p-2.5 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800/50 transition text-slate-500"><i data-lucide="sun" class="hidden dark:block w-5 h-5"></i><i data-lucide="moon" class="block dark:hidden w-5 h-5"></i></button>
            <button onclick="app.openModal('configModal')" class="p-2.5 hover:bg-slate-100 dark:hover:bg-slate-800/50 rounded-xl transition relative text-slate-600"><i data-lucide="settings" class="w-5 h-5"></i><span id="apiKeyStatus" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full ring-2 ring-white dark:ring-slate-900 shadow-sm"></span></button>
            <button onclick="app.generatePDF()" class="bg-slate-900 hover:bg-black text-white px-5 py-2.5 rounded-xl text-sm font-bold flex gap-2 items-center transition shadow-lg hidden md:flex hover:-translate-y-0.5"><i data-lucide="printer" class="w-4 h-4"></i> Imprimir</button>
        </div>
    </header>

    <!-- MAIN -->
    <main class="flex flex-col flex-1 overflow-hidden max-w-[1920px] mx-auto w-full relative">
        
        <!-- Desktop Nav -->
        <div class="no-print hidden lg:flex border-b border-slate-200 dark:border-slate-800 px-6 bg-white/60 dark:bg-slate-950/60 backdrop-blur-md z-20 justify-between items-center">
            <div class="flex space-x-1">
                <button onclick="app.switchTab('patient')" id="tabButton-patient" class="tab-button group relative px-6 py-4 text-sm font-semibold text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors">
                    <div class="flex items-center gap-2"><i data-lucide="user-circle-2" class="w-4 h-4"></i> Paciente</div>
                    <span class="absolute bottom-0 left-0 w-full h-0.5 bg-slate-900 dark:bg-white scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></span>
                </button>
                <button onclick="app.switchTab('ai')" id="tabButton-ai" class="tab-button group relative px-6 py-4 text-sm font-semibold text-slate-500 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">
                    <div class="flex items-center gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i> IA Clínica</div>
                    <span class="absolute bottom-0 left-0 w-full h-0.5 bg-indigo-600 scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></span>
                </button>
                <button onclick="app.switchTab('pharmacy')" id="tabButton-pharmacy" class="tab-button group relative px-6 py-4 text-sm font-semibold text-slate-500 hover:text-emerald-600 transition-colors">
                    <div class="flex items-center gap-2"><i data-lucide="pill" class="w-4 h-4"></i> Farmácia</div>
                    <span class="absolute bottom-0 left-0 w-full h-0.5 bg-emerald-600 scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></span>
                </button>
                <button onclick="app.switchTab('exams')" id="tabButton-exams" class="tab-button group relative px-6 py-4 text-sm font-semibold text-slate-500 hover:text-orange-600 transition-colors">
                    <div class="flex items-center gap-2"><i data-lucide="microscope" class="w-4 h-4"></i> Exames</div>
                    <span class="absolute bottom-0 left-0 w-full h-0.5 bg-orange-600 scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></span>
                </button>
            </div>
            <div id="loadingIndicator" class="hidden items-center gap-2 px-3 py-1 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-full text-xs font-bold animate-pulse"><i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Buscando...</div>
        </div>

        <div class="flex flex-col lg:flex-row flex-1 overflow-hidden relative">
            
            <!-- LEFT PANEL (Tabs Content) -->
            <div id="leftPanelContainer" class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6 lg:border-r border-slate-200 dark:border-slate-800 h-full bg-white/30 dark:bg-slate-900/30 transition-all duration-300 pb-28 lg:pb-6">
                
                <!-- TAB: PATIENT -->
                <div id="tabContent-patient" class="tab-content active flex-col gap-6">
                    <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-sm font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-1 flex items-center gap-2"><i data-lucide="fingerprint" class="w-4 h-4 text-slate-400"></i> Identificação</h2>
                                <p class="text-xs text-slate-500">Registro clínico (SOAP)</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="app.openModal('obstetricModal')" class="flex items-center gap-2 px-3 py-2 bg-pink-50 text-pink-600 dark:bg-pink-900/20 dark:text-pink-300 rounded-xl text-xs font-bold hover:bg-pink-100 transition border border-pink-100 dark:border-pink-800"><i data-lucide="baby" class="w-4 h-4"></i> Calc. IG</button>
                                <button onclick="app.openMagicSoap()" class="group flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl text-xs font-bold shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/40 hover:scale-105 transition-all active:scale-95"><i data-lucide="wand-2" class="w-3 h-3 group-hover:rotate-12 transition-transform"></i> Magic SOAP</button>
                                <button onclick="app.clearPatientData()" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>

                        <div class="relative mb-6 group">
                            <input type="text" id="patientNameInput" oninput="app.updateDocumentView()" placeholder="Nome do paciente..." class="block w-full pl-3 pr-3 py-3 border border-slate-200 dark:border-slate-700 rounded-xl leading-5 bg-slate-50 dark:bg-slate-800 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-all font-medium">
                        </div>

                        <div class="grid grid-cols-1 gap-4">
                            <div class="bg-slate-50/50 dark:bg-slate-800/30 rounded-xl p-4 border border-slate-200 dark:border-slate-700 hover:border-indigo-400 transition-colors">
                                <label class="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider mb-2 flex items-center gap-1.5"><div class="w-1.5 h-1.5 bg-indigo-500 rounded-full"></div> S - Subjetivo</label>
                                <textarea id="soapS" class="w-full bg-transparent text-sm resize-none outline-none min-h-[100px] placeholder-slate-400/50" placeholder="Queixa principal..."></textarea>
                            </div>
                            <div class="bg-slate-50/50 dark:bg-slate-800/30 rounded-xl p-4 border border-slate-200 dark:border-slate-700 hover:border-emerald-400 transition-colors relative group">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-wider flex items-center gap-1.5"><div class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div> O - Objetivo</label>
                                    <button onclick="document.getElementById('examUploadInput').click()" class="text-[10px] flex items-center gap-1 text-slate-500 hover:text-emerald-600 transition bg-white dark:bg-slate-800 px-2.5 py-1 rounded-lg border border-slate-200 dark:border-slate-600 shadow-sm"><i data-lucide="paperclip" class="w-3 h-3"></i> Anexar</button>
                                    <input type="file" id="examUploadInput" multiple accept="image/*,application/pdf" class="hidden" onchange="app.handleExamUpload(this)">
                                </div>
                                <textarea id="soapO" class="w-full bg-transparent text-sm resize-none outline-none min-h-[100px] placeholder-slate-400/50" placeholder="Exame físico..."></textarea>
                                <div id="examPreviewContainer" class="hidden flex flex-col gap-2 mt-3"></div>
                            </div>
                            <div class="bg-slate-50/50 dark:bg-slate-800/30 rounded-xl p-4 border border-slate-200 dark:border-slate-700 hover:border-orange-400 transition-colors">
                                <label class="text-[10px] font-bold text-orange-600 dark:text-orange-400 uppercase tracking-wider mb-2 flex items-center gap-1.5"><div class="w-1.5 h-1.5 bg-orange-500 rounded-full"></div> A - Avaliação</label>
                                <textarea id="soapA" class="w-full bg-transparent text-sm resize-none outline-none min-h-[80px] placeholder-slate-400/50" placeholder="Diagnóstico..."></textarea>
                            </div>
                            <div class="bg-slate-50/50 dark:bg-slate-800/30 rounded-xl p-4 border border-slate-200 dark:border-slate-700 hover:border-blue-400 transition-colors">
                                <label class="text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider mb-2 flex items-center gap-1.5"><div class="w-1.5 h-1.5 bg-blue-500 rounded-full"></div> P - Plano</label>
                                <textarea id="soapP" class="w-full bg-transparent text-sm resize-none outline-none min-h-[80px] placeholder-slate-400/50" placeholder="Conduta..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: AI TOOLS -->
                <div id="tabContent-ai" class="tab-content flex-col gap-4 h-full">
                    <div class="relative">
                        <input type="text" id="aiToolSearch" oninput="app.filterAITools()" placeholder="Buscar ferramenta..." class="w-full pl-11 pr-4 py-3.5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all font-medium">
                        <i data-lucide="search" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400"></i>
                    </div>
                    <div id="aiToolsContainer" class="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-8 pb-10 pt-2"></div>
                </div>

                <!-- TAB: PHARMACY -->
                <div id="tabContent-pharmacy" class="tab-content flex-col gap-4 h-full">
                    <div class="relative">
                        <input type="text" id="medSearch" oninput="app.searchDatabase('med', this.value)" placeholder="Buscar medicamento..." class="w-full pl-11 pr-4 py-3.5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm text-sm focus:ring-2 focus:ring-emerald-500 outline-none transition-all font-medium">
                        <i data-lucide="search" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400"></i>
                    </div>
                    <div id="medicationList" class="flex-1 overflow-y-auto custom-scrollbar pr-1 space-y-2.5 pb-10">
                        <div class="flex flex-col items-center justify-center h-40 text-slate-400 opacity-60"><i data-lucide="database" class="w-10 h-10 mb-2"></i><span class="text-xs font-medium">Digite para buscar</span></div>
                    </div>
                </div>

                <!-- TAB: EXAMS -->
                <div id="tabContent-exams" class="tab-content flex-col gap-4 h-full">
                    <div class="relative">
                        <input type="text" id="examSearch" oninput="app.searchDatabase('exam', this.value)" placeholder="Buscar exame..." class="w-full pl-11 pr-4 py-3.5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm text-sm focus:ring-2 focus:ring-orange-500 outline-none transition-all font-medium">
                        <i data-lucide="search" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400"></i>
                    </div>
                    <div id="examList" class="flex-1 overflow-y-auto custom-scrollbar pr-1 space-y-2.5 pb-10">
                        <div class="flex flex-col items-center justify-center h-40 text-slate-400 opacity-60"><i data-lucide="database" class="w-10 h-10 mb-2"></i><span class="text-xs font-medium">Digite para buscar</span></div>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL: DOCUMENT PREVIEW -->
            <div id="documentPanel" class="hidden lg:flex flex-1 bg-slate-100/80 dark:bg-slate-950/50 border-l border-slate-200 dark:border-slate-800 justify-center overflow-y-auto custom-scrollbar p-8 shrink-0 h-full relative transition-all duration-300 backdrop-blur-sm">
                
                <!-- Mobile Header para o Document Panel -->
                <div class="lg:hidden w-full flex items-center justify-between mb-6 pb-4 border-b border-slate-200 dark:border-slate-700">
                    <button onclick="app.toggleMobileDoc()" class="flex items-center gap-2 text-slate-500 font-bold">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i> Voltar
                    </button>
                    <span class="text-sm font-bold uppercase text-slate-400">Visualização</span>
                </div>

                <button onclick="app.toggleSidebar()" class="hidden lg:block absolute top-4 left-4 p-2 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 hover:bg-slate-50 z-10 text-slate-500 transition-all active:scale-95"><i data-lucide="panel-left" class="w-5 h-5"></i></button>

                <div class="flex flex-col items-center w-full max-w-full pt-4 lg:pt-0">
                    <div class="flex p-1.5 bg-white dark:bg-slate-900 rounded-xl mb-8 shadow-sm border border-slate-200 dark:border-slate-800 scale-95 lg:scale-100">
                        <button onclick="app.setDocumentMode('prescription')" id="docMode-prescription" class="doc-switch-btn active">Receita</button>
                        <button onclick="app.setDocumentMode('exams')" id="docMode-exams" class="doc-switch-btn inactive">Exames</button>
                        <button onclick="app.setDocumentMode('hospital')" id="docMode-hospital" class="doc-switch-btn inactive">Hospitalar</button>
                    </div>
                    <div class="w-full flex justify-center pb-24 lg:pb-10 overflow-x-auto px-4 lg:px-0">
                        <div id="prescriptionPaper" class="print-container bg-white text-slate-900 shadow-paper relative flex flex-col transition-all duration-300 origin-top scale-[0.85] origin-top-center lg:scale-100 ring-1 ring-black/5 w-[210mm] min-h-[297mm]">
                            <!-- Content -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MOBILE BOTTOM NAV -->
    <nav id="mobileBottomNav" class="lg:hidden fixed bottom-6 left-4 right-4 h-20 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 z-50 shadow-2xl shadow-slate-300/50 dark:shadow-black/50 rounded-2xl flex justify-around items-center px-2">
        <button onclick="app.switchTab('patient')" id="mb-nav-patient" class="bottom-nav-item active"><i data-lucide="user-circle-2" class="w-6 h-6"></i><span class="text-[10px] font-bold">SOAP</span></button>
        <button onclick="app.switchTab('ai')" id="mb-nav-ai" class="bottom-nav-item"><i data-lucide="sparkles" class="w-6 h-6"></i><span class="text-[10px] font-bold">IA</span></button>
        <button onclick="app.toggleMobileDoc()" class="bottom-nav-item" id="mb-nav-doc"><i data-lucide="file-text" class="w-6 h-6"></i><span class="text-[10px] font-bold">Ver Doc</span></button>
        <button onclick="app.switchTab('pharmacy')" id="mb-nav-pharmacy" class="bottom-nav-item"><i data-lucide="pill" class="w-6 h-6"></i><span class="text-[10px] font-bold">Farmácia</span></button>
        <button onclick="app.switchTab('exams')" id="mb-nav-exams" class="bottom-nav-item"><i data-lucide="microscope" class="w-6 h-6"></i><span class="text-[10px] font-bold">Exames</span></button>
    </nav>

    <!-- MODALS (Mantidos) -->
    <div id="aiModal" class="hidden fixed inset-0 z-[80] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
         <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 w-full max-w-3xl rounded-3xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden ring-1 ring-white/10">
            <div class="p-5 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                <h3 id="aiModalTitle" class="font-bold text-lg flex items-center gap-2 text-slate-800 dark:text-white">Resultado</h3>
                <button onclick="app.closeModal('aiModal')" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition"><i data-lucide="x" class="w-5 h-5 opacity-50"></i></button>
            </div>
            <div class="p-8 overflow-y-auto custom-scrollbar grow ai-table-container bg-white dark:bg-slate-950">
                <div id="aiModalContent" class="text-sm leading-relaxed text-slate-700 dark:text-slate-300 font-sans"></div>
            </div>
            <div class="p-5 border-t border-slate-200 dark:border-slate-800 flex justify-end gap-2 bg-slate-50 dark:bg-slate-900">
                <button onclick="app.copyAIContent()" class="px-5 py-2.5 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 text-xs font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition">Copiar</button>
                <button onclick="app.closeModal('aiModal')" class="px-5 py-2.5 rounded-xl bg-slate-900 dark:bg-white text-white dark:text-slate-900 text-xs font-bold hover:bg-slate-800 transition">Fechar</button>
            </div>
        </div>
    </div>

    <div id="configModal" class="hidden fixed inset-0 z-[60] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4">
         <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl w-full max-w-lg shadow-2xl border border-slate-200 dark:border-slate-800">
            <div class="flex justify-between mb-8 items-center"><h3 class="text-2xl font-bold">Configurações</h3><button onclick="app.closeModal('configModal')" class="p-2"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div class="space-y-6">
                <div class="p-5 bg-indigo-50 dark:bg-indigo-900/10 rounded-2xl border border-indigo-100 dark:border-indigo-800/30">
                    <label class="block text-xs font-bold text-indigo-600 mb-3 uppercase">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="Cole sua chave aqui..." class="w-full p-3.5 rounded-xl border bg-white dark:bg-slate-950 border-slate-200 dark:border-slate-700 text-sm">
                </div>
                <div class="border-t border-slate-200 pt-6 grid gap-4">
                    <label class="block text-xs font-bold uppercase text-slate-500">Dados Cabeçalho</label>
                    <input id="cfgName" placeholder="Nome Médico" class="w-full p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-sm">
                    <input id="cfgSpec" placeholder="Especialidade" class="w-full p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-sm">
                    <input id="cfgCrm" placeholder="CRM" class="w-full p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-sm">
                </div>
                <button onclick="app.saveConfig()" class="w-full bg-slate-900 text-white p-4 rounded-xl font-bold mt-2 shadow-lg">Salvar</button>
            </div>
        </div>
    </div>

    <div id="obstetricModal" class="hidden fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-3xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden border border-slate-200 dark:border-slate-800">
            <div class="p-5 border-b border-slate-200 dark:border-slate-800 bg-pink-50 dark:bg-pink-900/20 flex justify-between items-center">
                <h3 class="text-lg font-bold text-pink-700 dark:text-pink-400 flex items-center gap-2"><i data-lucide="calculator" class="w-5 h-5"></i> Calculadora de Idade Gestacional</h3>
                <button onclick="app.closeModal('obstetricModal')" class="p-2 rounded-full hover:bg-slate-200 transition"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button>
            </div>
            <div class="p-6 overflow-y-auto bg-slate-50/50 dark:bg-slate-950 space-y-6">
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <label class="block text-sm font-bold mb-3 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4 text-pink-500"></i> DUM</label>
                    <input type="date" id="calcDum" onchange="app.calcObs()" class="w-full p-3 border border-slate-200 dark:border-slate-600 rounded-xl bg-slate-50 dark:bg-slate-700 outline-none text-sm">
                    <div class="mt-3 flex justify-between items-center bg-pink-50 dark:bg-pink-900/10 p-3 rounded-lg border border-pink-100 dark:border-pink-900/30">
                        <span class="text-xs font-bold text-pink-700">IG pela DUM</span>
                        <div class="text-right"><div id="resIgDum" class="font-bold text-slate-800 dark:text-white">--</div><div id="resDppDum" class="text-[10px] text-slate-500">DPP: --</div></div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <label class="block text-sm font-bold mb-3 flex items-center gap-2"><i data-lucide="image" class="w-4 h-4 text-indigo-500"></i> USG</label>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div><span class="text-[10px] uppercase font-bold text-slate-400">Data Exame</span><input type="date" id="calcUsgDate" onchange="app.calcObs()" class="w-full p-2 border border-slate-200 dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 text-sm"></div>
                        <div class="flex gap-2"><div class="flex-1"><span class="text-[10px] uppercase font-bold text-slate-400">Sem</span><input type="number" id="calcUsgW" onchange="app.calcObs()" class="w-full p-2 border border-slate-200 rounded-lg bg-slate-50 text-sm"></div><div class="flex-1"><span class="text-[10px] uppercase font-bold text-slate-400">Dias</span><input type="number" id="calcUsgD" onchange="app.calcObs()" class="w-full p-2 border border-slate-200 rounded-lg bg-slate-50 text-sm"></div></div>
                    </div>
                    <div class="mt-3 flex justify-between items-center bg-indigo-50 dark:bg-indigo-900/10 p-3 rounded-lg border border-indigo-100 dark:border-indigo-900/30">
                        <span class="text-xs font-bold text-indigo-700">IG pela USG</span>
                        <div class="text-right"><div id="resIgUsg" class="font-bold text-slate-800 dark:text-white">--</div><div id="resDppUsg" class="text-[10px] text-slate-500">DPP: --</div></div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 flex justify-end gap-2">
                <button onclick="app.pasteIg('resIgDum')" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-bold hover:bg-slate-100">Usar DUM</button>
                <button onclick="app.pasteIg('resIgUsg')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700">Usar USG</button>
            </div>
        </div>
    </div>

    <!-- MAGIC SOAP MODAL -->
    <div id="magicSoapModal" class="hidden fixed inset-0 z-[90] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4 transition-opacity">
         <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 w-full max-w-2xl rounded-3xl shadow-2xl flex flex-col p-6">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-xl flex items-center gap-2 text-indigo-600"><i data-lucide="wand-2" class="w-5 h-5"></i> Magic SOAP</h3><button onclick="app.closeModal('magicSoapModal')"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <textarea id="magicSoapInput" class="w-full h-40 p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 mb-4 text-sm" placeholder="Cole o texto..."></textarea>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="border border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer hover:bg-slate-50 relative"><i data-lucide="mic" class="w-6 h-6 mx-auto mb-2 text-purple-500"></i><span class="text-xs font-bold">Áudio</span><input type="file" id="magicSoapAudio" accept="audio/*" class="absolute inset-0 opacity-0 cursor-pointer"></div>
                <div class="border border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer hover:bg-slate-50 relative"><i data-lucide="camera" class="w-6 h-6 mx-auto mb-2 text-indigo-500"></i><span class="text-xs font-bold">Foto</span><input type="file" id="magicSoapImage" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer"></div>
            </div>
            <button onclick="app.generateMagicSoap()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">Processar</button>
        </div>
    </div>

    <script>
        const COMPRESSED_DB = `
        M|Topiramato|25mg|1 cp à noite|Neuro
        M|Topiramato|50mg|1 cp à noite|Neuro
        M|Topiramato|100mg|1 cp 12/12h|Neuro
        M|Lamotrigina|25mg|1 cp ao dia|Neuro
        M|Lamotrigina|50mg|1 cp ao dia|Neuro
        M|Lamotrigina|100mg|1 cp 12/12h|Neuro
        M|Carbamazepina|200mg|1 cp 8/8h|Neuro
        M|Carbamazepina|400mg|1 cp 12/12h|Neuro
        M|Oxcarbazepina|300mg|1 cp 12/12h|Neuro
        M|Oxcarbazepina|600mg|1 cp 12/12h|Neuro
        M|Valproato de Sódio|250mg|1 cp 12/12h|Neuro
        M|Valproato de Sódio|500mg|1 cp 12/12h|Neuro
        M|Divalproato de Sódio|250mg|1 cp 12/12h|Neuro
        M|Divalproato de Sódio|500mg|1 cp 12/12h|Neuro
        M|Gabapentina|300mg|1 cp 8/8h|Neuro
        M|Pregabalina|75mg|1 cp 12/12h|Neuro
        M|Pregabalina|150mg|1 cp 12/12h|Neuro
        M|Fenitoína|100mg|1 cp 8/8h|Neuro
        M|Fenobarbital|100mg|1 cp à noite|Neuro
        M|Levetiracetam|500mg|1 cp 12/12h|Neuro
        M|Primidona|100mg|1 cp 12/12h|Neuro
        M|Etossuximida|250mg|1 cp 12/12h|Neuro
        M|Vigabatrina|500mg|1 cp 12/12h|Neuro
        M|Litio|300mg|1 cp 12/12h|Psiquiatria
        M|Risperidona|1mg|1 cp à noite|Psiquiatria
        M|Risperidona|2mg|1 cp à noite|Psiquiatria
        M|Quetiapina|25mg|1 cp à noite|Psiquiatria
        M|Quetiapina|100mg|1 cp à noite|Psiquiatria
        M|Quetiapina XR|50mg|1 cp à noite|Psiquiatria
        M|Olanzapina|5mg|1 cp à noite|Psiquiatria
        M|Olanzapina|10mg|1 cp à noite|Psiquiatria
        M|Clozapina|25mg|1 cp à noite|Psiquiatria
        M|Aripiprazol|10mg|1 cp pela manhã|Psiquiatria
        M|Haloperidol|5mg|1 cp à noite|Psiquiatria
        M|Clorpromazina|100mg|1 cp à noite|Psiquiatria
        M|Levomepromazina|25mg|1 cp à noite|Psiquiatria
        M|Biperideno|2mg|1 cp 12/12h|Psiquiatria
        M|Amitriptilina|25mg|1 cp à noite|Psiquiatria
        M|Amitriptilina|75mg|1 cp à noite|Psiquiatria
        M|Nortriptilina|25mg|1 cp à noite|Psiquiatria
        M|Clomipramina|25mg|1 cp à noite|Psiquiatria
        M|Imipramina|25mg|1 cp à noite|Psiquiatria
        M|Fluoxetina|20mg|1 cp pela manhã|Psiquiatria
        M|Sertralina|50mg|1 cp pela manhã|Psiquiatria
        M|Sertralina|100mg|1 cp pela manhã|Psiquiatria
        M|Paroxetina|20mg|1 cp pela manhã|Psiquiatria
        M|Citalopram|20mg|1 cp pela manhã|Psiquiatria
        M|Escitalopram|10mg|1 cp pela manhã|Psiquiatria
        M|Escitalopram|20mg|1 cp pela manhã|Psiquiatria
        M|Venlafaxina|75mg|1 cp pela manhã|Psiquiatria
        M|Venlafaxina|150mg|1 cp pela manhã|Psiquiatria
        M|Desvenlafaxina|50mg|1 cp pela manhã|Psiquiatria
        M|Desvenlafaxina|100mg|1 cp pela manhã|Psiquiatria
        M|Duloxetina|30mg|1 cp pela manhã|Psiquiatria
        M|Duloxetina|60mg|1 cp pela manhã|Psiquiatria
        M|Bupropiona|150mg|1 cp pela manhã|Psiquiatria
        M|Bupropiona XL|150mg|1 cp pela manhã|Psiquiatria
        M|Mirtazapina|15mg|1 cp à noite|Psiquiatria
        M|Mirtazapina|30mg|1 cp à noite|Psiquiatria
        M|Trazodona|50mg|1 cp à noite|Psiquiatria
        M|Trazodona|100mg|1 cp à noite|Psiquiatria
        M|Agomelatina|25mg|1 cp à noite|Psiquiatria
        M|Vortioxetina|10mg|1 cp pela manhã|Psiquiatria
        M|Zolpidem|10mg|1 cp ao deitar|Psiquiatria
        M|Eszopiclona|3mg|1 cp ao deitar|Psiquiatria
        M|Zopiclona|7.5mg|1 cp ao deitar|Psiquiatria
        M|Ramelteona|8mg|1 cp ao deitar|Psiquiatria
        M|Diazepam|5mg|1 cp à noite|Psiquiatria
        M|Diazepam|10mg|1 cp à noite|Psiquiatria
        M|Clonazepam|0.5mg|1 cp à noite|Psiquiatria
        M|Clonazepam|2mg|1 cp à noite|Psiquiatria
        M|Alprazolam|0.5mg|1 cp à noite|Psiquiatria
        M|Alprazolam|1mg|1 cp à noite|Psiquiatria
        M|Lorazepam|1mg|1 cp à noite|Psiquiatria
        M|Lorazepam|2mg|1 cp à noite|Psiquiatria
        M|Bromazepam|3mg|1 cp à noite|Psiquiatria
        M|Clobazam|10mg|1 cp à noite|Psiquiatria
        M|Midazolam|15mg|1 cp ao deitar|Psiquiatria
        M|Losartana|50mg|1 cp 12/12h|Cardio
        M|Losartana|100mg|1 cp ao dia|Cardio
        M|Valsartana|160mg|1 cp ao dia|Cardio
        M|Valsartana|320mg|1 cp ao dia|Cardio
        M|Candesartana|8mg|1 cp ao dia|Cardio
        M|Telmisartana|40mg|1 cp ao dia|Cardio
        M|Telmisartana|80mg|1 cp ao dia|Cardio
        M|Olmesartana|20mg|1 cp ao dia|Cardio
        M|Olmesartana|40mg|1 cp ao dia|Cardio
        M|Enalapril|10mg|1 cp 12/12h|Cardio
        M|Enalapril|20mg|1 cp 12/12h|Cardio
        M|Captopril|25mg|1 cp 8/8h|Cardio
        M|Ramipril|5mg|1 cp ao dia|Cardio
        M|Ramipril|10mg|1 cp ao dia|Cardio
        M|Lisinopril|10mg|1 cp ao dia|Cardio
        M|Perindopril|4mg|1 cp ao dia|Cardio
        M|Anlodipino|5mg|1 cp ao dia|Cardio
        M|Anlodipino|10mg|1 cp ao dia|Cardio
        M|Nifedipino|20mg|1 cp 12/12h|Cardio
        M|Levonlodipino|2.5mg|1 cp ao dia|Cardio
        M|Felodipino|5mg|1 cp ao dia|Cardio
        M|Verapamil|80mg|1 cp 8/8h|Cardio
        M|Diltiazem|60mg|1 cp 8/8h|Cardio
        M|Atenolol|25mg|1 cp ao dia|Cardio
        M|Atenolol|50mg|1 cp ao dia|Cardio
        M|Atenolol|100mg|1 cp ao dia|Cardio
        M|Propranolol|40mg|1 cp 12/12h|Cardio
        M|Carvedilol|6.25mg|1 cp 12/12h|Cardio
        M|Carvedilol|12.5mg|1 cp 12/12h|Cardio
        M|Carvedilol|25mg|1 cp 12/12h|Cardio
        M|Bisoprolol|2.5mg|1 cp ao dia|Cardio
        M|Bisoprolol|5mg|1 cp ao dia|Cardio
        M|Bisoprolol|10mg|1 cp ao dia|Cardio
        M|Metoprolol|50mg|1 cp 12/12h|Cardio
        M|Metoprolol|100mg|1 cp ao dia|Cardio
        M|Nebivolol|5mg|1 cp ao dia|Cardio
        M|Sotalol|160mg|1 cp 12/12h|Cardio
        M|Amiodarona|200mg|1 cp ao dia|Cardio
        M|Propafenona|300mg|1 cp 12/12h|Cardio
        M|Digoxina|0.25mg|1/2 cp ao dia|Cardio
        M|Hidroclorotiazida|25mg|1 cp pela manhã|Cardio
        M|Clortalidona|12.5mg|1 cp pela manhã|Cardio
        M|Clortalidona|25mg|1 cp pela manhã|Cardio
        M|Indapamida|1.5mg|1 cp pela manhã|Cardio
        M|Furosemida|40mg|1 cp pela manhã|Cardio
        M|Espironolactona|25mg|1 cp pela manhã|Cardio
        M|Espironolactona|100mg|1 cp ao dia|Cardio
        M|Eplerenona|25mg|1 cp ao dia|Cardio
        M|Amilorida|5mg|1 cp ao dia|Cardio
        M|Clonidina|0.100mg|1 cp 12/12h|Cardio
        M|Metildopa|250mg|1 cp 8/8h|Cardio
        M|Hidralazina|25mg|1 cp 8/8h|Cardio
        M|Minoxidil|10mg|1 cp ao dia|Cardio
        M|Doxazosina|2mg|1 cp à noite|Cardio
        M|Prazosina|1mg|1 cp à noite|Cardio
        M|Tansulosina|0.4mg|1 cp ao dia|Cardio
        M|Sinvastatina|20mg|1 cp à noite|Cardio
        M|Sinvastatina|40mg|1 cp à noite|Cardio
        M|Atorvastatina|10mg|1 cp à noite|Cardio
        M|Atorvastatina|20mg|1 cp à noite|Cardio
        M|Atorvastatina|40mg|1 cp à noite|Cardio
        M|Rosuvastatina|10mg|1 cp à noite|Cardio
        M|Rosuvastatina|20mg|1 cp à noite|Cardio
        M|Pitavastatina|2mg|1 cp à noite|Cardio
        M|Pravastatina|20mg|1 cp à noite|Cardio
        M|Ezetimiba|10mg|1 cp ao dia|Cardio
        M|Fenofibrato|200mg|1 cp ao dia|Cardio
        M|Ciprofibrato|100mg|1 cp ao dia|Cardio
        M|Genfibrozila|600mg|1 cp 12/12h|Cardio
        M|Omega 3|1g|1 cp ao dia|Cardio
        M|AAS|100mg|1 cp após o almoço|Cardio
        M|Clopidogrel|75mg|1 cp após o almoço|Cardio
        M|Ticagrelor|90mg|1 cp 12/12h|Cardio
        M|Prasugrel|10mg|1 cp ao dia|Cardio
        M|Rivaroxabana|15mg|1 cp ao dia|Cardio
        M|Rivaroxabana|20mg|1 cp ao dia|Cardio
        M|Apixabana|2.5mg|1 cp 12/12h|Cardio
        M|Apixabana|5mg|1 cp 12/12h|Cardio
        M|Dabigatrana|110mg|1 cp 12/12h|Cardio
        M|Dabigatrana|150mg|1 cp 12/12h|Cardio
        M|Edoxabana|60mg|1 cp ao dia|Cardio
        M|Varfarina|5mg|Conforme RNI|Cardio
        M|Enoxaparina|40mg|1 seringa SC ao dia|Cardio
        M|Enoxaparina|60mg|1 seringa SC 12/12h|Cardio
        M|Heparina|5000UI|SC 8/8h|Cardio
        M|Nitroglicerina|5mg|Adesivo 1x dia|Cardio
        M|Isossorbida Mononitrato|20mg|1 cp 12/12h|Cardio
        M|Isossorbida Dinitrato|10mg|1 cp 8/8h|Cardio
        M|Propatilnitrato|10mg|1 cp 8/8h|Cardio
        M|Ivabradina|5mg|1 cp 12/12h|Cardio
        M|Sacubitril/Valsartana|49/51mg|1 cp 12/12h|Cardio
        M|Metformina|500mg|1 cp 3x ao dia|Endócrino
        M|Metformina|850mg|1 cp 2x ao dia|Endócrino
        M|Metformina XR|500mg|2 cp no jantar|Endócrino
        M|Metformina XR|1000mg|1 cp no jantar|Endócrino
        M|Glibenclamida|5mg|1 cp no café|Endócrino
        M|Gliclazida MR|30mg|1 cp no café|Endócrino
        M|Gliclazida MR|60mg|1 cp no café|Endócrino
        M|Glimepirida|2mg|1 cp no café|Endócrino
        M|Glimepirida|4mg|1 cp no café|Endócrino
        M|Glipizida|5mg|1 cp no café|Endócrino
        M|Pioglitazona|15mg|1 cp ao dia|Endócrino
        M|Pioglitazona|30mg|1 cp ao dia|Endócrino
        M|Acarbose|50mg|1 cp nas refeições|Endócrino
        M|Sitagliptina|50mg|1 cp ao dia|Endócrino
        M|Sitagliptina|100mg|1 cp ao dia|Endócrino
        M|Vildagliptina|50mg|1 cp 12/12h|Endócrino
        M|Saxagliptina|5mg|1 cp ao dia|Endócrino
        M|Linagliptina|5mg|1 cp ao dia|Endócrino
        M|Alogliptina|25mg|1 cp ao dia|Endócrino
        M|Dapagliflozina|10mg|1 cp ao dia|Endócrino
        M|Empagliflozina|10mg|1 cp ao dia|Endócrino
        M|Empagliflozina|25mg|1 cp ao dia|Endócrino
        M|Canagliflozina|100mg|1 cp ao dia|Endócrino
        M|Canagliflozina|300mg|1 cp ao dia|Endócrino
        M|Liraglutida|6mg/ml|SC diário|Endócrino
        M|Dulaglutida|1.5mg|SC semanal|Endócrino
        M|Semaglutida|0.25mg|SC semanal|Endócrino
        M|Semaglutida|0.5mg|SC semanal|Endócrino
        M|Semaglutida|1mg|SC semanal|Endócrino
        M|Exenatida|2mg|SC semanal|Endócrino
        M|Insulina Regular|UI|Conforme dextro|Endócrino
        M|Insulina NPH|UI|Conforme esquema|Endócrino
        M|Insulina Glargina|UI|SC 1x ao dia|Endócrino
        M|Insulina Detemir|UI|SC 1x ao dia|Endócrino
        M|Insulina Degludeca|UI|SC 1x ao dia|Endócrino
        M|Insulina Asparte|UI|SC nas refeições|Endócrino
        M|Insulina Lispro|UI|SC nas refeições|Endócrino
        M|Insulina Glulisina|UI|SC nas refeições|Endócrino
        M|Levotiroxina|25mcg|1 cp em jejum|Endócrino
        M|Levotiroxina|50mcg|1 cp em jejum|Endócrino
        M|Levotiroxina|75mcg|1 cp em jejum|Endócrino
        M|Levotiroxina|88mcg|1 cp em jejum|Endócrino
        M|Levotiroxina|100mcg|1 cp em jejum|Endócrino
        M|Levotiroxina|112mcg|1 cp em jejum|Endócrino
        M|Levotiroxina|125mcg|1 cp em jejum|Endócrino
        M|Levotiroxina|150mcg|1 cp em jejum|Endócrino
        M|Metimazol|10mg|1 cp ao dia|Endócrino
        M|Propiltiouracil|100mg|1 cp 8/8h|Endócrino
        M|Alendronato|70mg|1 cp semanal em jejum|Endócrino
        M|Risedronato|35mg|1 cp semanal em jejum|Endócrino
        M|Ibandronato|150mg|1 cp mensal em jejum|Endócrino
        M|Ácido Zoledrônico|5mg|IV anual|Endócrino
        M|Denosumabe|60mg|SC semestral|Endócrino
        M|Teriparatida|20mcg|SC diário|Endócrino
        M|Carbonato de Cálcio|500mg|1 cp ao dia|Endócrino
        M|Citrato de Cálcio|500mg|1 cp ao dia|Endócrino
        M|Colecalciferol (Vit D)|7000UI|1 cp semanal|Endócrino
        M|Colecalciferol (Vit D)|50000UI|1 cp semanal (ataque)|Endócrino
        M|Calcitriol|0.25mcg|1 cp ao dia|Endócrino
        M|Omeprazol|20mg|1 cp em jejum|Gastro
        M|Omeprazol|40mg|1 cp em jejum|Gastro
        M|Pantoprazol|20mg|1 cp em jejum|Gastro
        M|Pantoprazol|40mg|1 cp em jejum|Gastro
        M|Lansoprazol|30mg|1 cp em jejum|Gastro
        M|Esomeprazol|20mg|1 cp em jejum|Gastro
        M|Esomeprazol|40mg|1 cp em jejum|Gastro
        M|Rabeprazol|20mg|1 cp em jejum|Gastro
        M|Dexlansoprazol|30mg|1 cp em jejum|Gastro
        M|Dexlansoprazol|60mg|1 cp em jejum|Gastro
        M|Cimetidina|200mg|1 cp 12/12h|Gastro
        M|Famotidina|20mg|1 cp 12/12h|Gastro
        M|Domperidona|10mg|1 cp 15 min antes refeição|Gastro
        M|Metoclopramida|10mg|1 cp 8/8h|Gastro
        M|Bromoprida|10mg|1 cp 8/8h|Gastro
        M|Ondansetrona|4mg|1 cp 8/8h|Gastro
        M|Ondansetrona|8mg|1 cp 8/8h|Gastro
        M|Dimenidrinato|100mg|1 cp 6/6h|Gastro
        M|Meclizina|25mg|1 cp 12/12h|Gastro
        M|Escopolamina (Buscopan)|10mg|1 cp 8/8h|Gastro
        M|Simeticona|40mg|1 cp 6/6h|Gastro
        M|Loperamida|2mg|1 cp se diarreia|Gastro
        M|Racecadotrila|100mg|1 cp 8/8h|Gastro
        M|Lactulose|667mg/ml|15ml 12/12h|Gastro
        M|Bisacodil|5mg|1 cp à noite|Gastro
        M|Picossulfato|Gts|10-20 gotas à noite|Gastro
        M|Óleo Mineral|Liq|15ml à noite|Gastro
        M|Macrogol|Env|1 envelope ao dia|Gastro
        M|Psyllium|Pó|1 colher em água|Gastro
        M|Mesalazina|500mg|1 cp 8/8h|Gastro
        M|Mesalazina|800mg|1 cp 8/8h|Gastro
        M|Sulfassalazina|500mg|1 cp 6/6h|Gastro
        M|Ursodesoxicolico|300mg|1 cp 12/12h|Gastro
        M|Pancreatina|Cp|1 cp nas refeições|Gastro
        M|Amoxicilina|500mg|1 cp 8/8h|Infecto
        M|Amoxicilina|875mg|1 cp 12/12h|Infecto
        M|Amoxicilina+Clavulanato|500+125mg|1 cp 8/8h|Infecto
        M|Amoxicilina+Clavulanato|875+125mg|1 cp 12/12h|Infecto
        M|Ampicilina|500mg|1 cp 6/6h|Infecto
        M|Penicilina G Benzatina|1.200.000UI|IM dose única|Infecto
        M|Oxacilina|500mg|1 cp 6/6h|Infecto
        M|Cefalexina|500mg|1 cp 6/6h|Infecto
        M|Cefadroxila|500mg|1 cp 12/12h|Infecto
        M|Cefuroxima|500mg|1 cp 12/12h|Infecto
        M|Ceftriaxona|1g|IV/IM 1x ao dia|Infecto
        M|Cefepima|1g|IV 12/12h|Infecto
        M|Azitromicina|500mg|1 cp ao dia|Infecto
        M|Claritromicina|500mg|1 cp 12/12h|Infecto
        M|Eritromicina|500mg|1 cp 6/6h|Infecto
        M|Clindamicina|300mg|1 cp 6/6h|Infecto
        M|Gentamicina|80mg|IM/IV 1x ao dia|Infecto
        M|Amicacina|500mg|IM/IV 1x ao dia|Infecto
        M|Ciprofloxacino|500mg|1 cp 12/12h|Infecto
        M|Levofloxacino|500mg|1 cp ao dia|Infecto
        M|Levofloxacino|750mg|1 cp ao dia|Infecto
        M|Norfloxacino|400mg|1 cp 12/12h|Infecto
        M|Moxifloxacino|400mg|1 cp ao dia|Infecto
        M|Sulfametoxazol+Trimetoprima|400+80mg|2 cp 12/12h|Infecto
        M|Sulfametoxazol+Trimetoprima|800+160mg|1 cp 12/12h|Infecto
        M|Nitrofurantoína|100mg|1 cp 6/6h|Infecto
        M|Fosfomicina|3g|1 envelope dose única|Infecto
        M|Metronidazol|250mg|2 cp 12/12h|Infecto
        M|Metronidazol|400mg|1 cp 8/8h|Infecto
        M|Doxiciclina|100mg|1 cp 12/12h|Infecto
        M|Tetraciclina|500mg|1 cp 6/6h|Infecto
        M|Vancomicina|1g|IV 12/12h|Infecto
        M|Teicoplanina|400mg|IV 1x ao dia|Infecto
        M|Linezolida|600mg|1 cp 12/12h|Infecto
        M|Meropenem|1g|IV 8/8h|Infecto
        M|Imipenem|500mg|IV 6/6h|Infecto
        M|Ertapenem|1g|IV 1x ao dia|Infecto
        M|Polimixina B|UI|IV conforme peso|Infecto
        M|Fluconazol|150mg|1 cp dose única|Infecto
        M|Itraconazol|100mg|1 cp 12/12h|Infecto
        M|Cetoconazol|200mg|1 cp ao dia|Infecto
        M|Voriconazol|200mg|1 cp 12/12h|Infecto
        M|Nistatina|Susp|Bochechar 4x dia|Infecto
        M|Miconazol|Creme|Aplicar 2x dia|Infecto
        M|Anfotericina B|mg|IV conforme peso|Infecto
        M|Aciclovir|200mg|1 cp 4/4h|Infecto
        M|Aciclovir|400mg|1 cp 12/12h|Infecto
        M|Valaciclovir|500mg|1 cp 12/12h|Infecto
        M|Oseltamivir|75mg|1 cp 12/12h|Infecto
        M|Tenofovir|300mg|1 cp ao dia|Infecto
        M|Lamivudina|150mg|1 cp 12/12h|Infecto
        M|Efavirenz|600mg|1 cp à noite|Infecto
        M|Dolutegravir|50mg|1 cp ao dia|Infecto
        M|Salbutamol|Spray|2 jatos 4/4h se crise|Pneumo
        M|Fenoterol|Gts|Inalação conforme peso|Pneumo
        M|Formoterol|Cap|Inalar 1 cap 12/12h|Pneumo
        M|Salmeterol|Spray|2 jatos 12/12h|Pneumo
        M|Ipratrópio|Gts|Inalação conforme peso|Pneumo
        M|Tiotrópio|Cap|Inalar 1 cap ao dia|Pneumo
        M|Budesonida|Spray|2 jatos nasais 12/12h|Pneumo
        M|Beclometasona|Spray|2 jatos nasais 12/12h|Pneumo
        M|Fluticasona|Spray|2 jatos nasais ao dia|Pneumo
        M|Mometasona|Spray|2 jatos nasais ao dia|Pneumo
        M|Ciclesonida|Spray|2 jatos nasais ao dia|Pneumo
        M|Prednisona|5mg|1 cp pela manhã|Pneumo
        M|Prednisona|20mg|1 cp pela manhã|Pneumo
        M|Prednisolona|20mg|1 cp pela manhã|Pneumo
        M|Dexametasona|4mg|1 cp ao dia|Pneumo
        M|Betametasona|IM|Dose única|Pneumo
        M|Hidrocortisona|IV|Conforme peso|Pneumo
        M|Metilprednisolona|IV|Conforme peso|Pneumo
        M|Loratadina|10mg|1 cp ao dia|Pneumo
        M|Desloratadina|5mg|1 cp ao dia|Pneumo
        M|Fexofenadina|120mg|1 cp ao dia|Pneumo
        M|Fexofenadina|180mg|1 cp ao dia|Pneumo
        M|Cetirizina|10mg|1 cp ao dia|Pneumo
        M|Levocetirizina|5mg|1 cp ao dia|Pneumo
        M|Hidroxizina|25mg|1 cp à noite|Pneumo
        M|Dexclorfeniramina|2mg|1 cp 8/8h|Pneumo
        M|Prometazina|25mg|1 cp à noite|Pneumo
        M|Montelucaste|10mg|1 cp à noite|Pneumo
        M|Acebrofilina|Xpe|10ml 12/12h|Pneumo
        M|Ambroxol|Xpe|5ml 8/8h|Pneumo
        M|N-Acetilcisteína|600mg|1 env à noite|Pneumo
        M|Guaifenesina|Xpe|10ml 4/4h|Pneumo
        M|Dipirona|500mg|1 cp 6/6h|Dor
        M|Dipirona|1g|1 cp 6/6h|Dor
        M|Paracetamol|500mg|1 cp 6/6h|Dor
        M|Paracetamol|750mg|1 cp 6/6h|Dor
        M|Ibuprofeno|600mg|1 cp 8/8h|Dor
        M|Naproxeno|500mg|1 cp 12/12h|Dor
        M|Cetoprofeno|100mg|1 cp 12/12h|Dor
        M|Diclofenaco|50mg|1 cp 8/8h|Dor
        M|Aceclofenaco|100mg|1 cp 12/12h|Dor
        M|Meloxicam|15mg|1 cp ao dia|Dor
        M|Piroxicam|20mg|1 cp ao dia|Dor
        M|Tenoxicam|20mg|1 cp ao dia|Dor
        M|Celecoxibe|200mg|1 cp ao dia|Dor
        M|Etoricoxibe|90mg|1 cp ao dia|Dor
        M|Parecoxibe|40mg|IV/IM 12/12h|Dor
        M|Codeína|30mg|1 cp 6/6h|Dor
        M|Tramadol|50mg|1 cp 8/8h|Dor
        M|Morfina|10mg|1 cp 4/4h|Dor
        M|Metadona|10mg|1 cp 8/8h|Dor
        M|Oxicodona|10mg|1 cp 12/12h|Dor
        M|Fentanil|Adesivo|Trocar a cada 72h|Dor
        M|Buprenorfina|Adesivo|Trocar a cada 7 dias|Dor
        M|Ciclobenzaprina|5mg|1 cp à noite|Dor
        M|Ciclobenzaprina|10mg|1 cp à noite|Dor
        M|Tizanidina|2mg|1 cp 8/8h|Dor
        M|Carisoprodol|1 cp|1 cp 8/8h|Dor
        M|Orfenadrina|35mg|1 cp 8/8h|Dor
        M|Baclofeno|10mg|1 cp 8/8h|Dor
        M|Colchicina|0.5mg|1 cp 12/12h na crise|Reumato
        M|Alopurinol|100mg|1 cp ao dia|Reumato
        M|Alopurinol|300mg|1 cp ao dia|Reumato
        M|Febuxostate|80mg|1 cp ao dia|Reumato
        M|Metotrexato|2.5mg|Semanal|Reumato
        M|Leflunomida|20mg|1 cp ao dia|Reumato
        M|Hidroxicloroquina|400mg|1 cp ao dia|Reumato
        M|Cloroquina|150mg|1 cp ao dia|Reumato
        M|Azatioprina|50mg|1 cp ao dia|Reumato
        M|Ciclosporina|100mg|1 cp 12/12h|Reumato
        M|Etinilestradiol+Levonorgestrel|Cp|1 cp ao dia|Gineco
        M|Ciproterona|2mg|1 cp ao dia|Gineco
        M|Desogestrel|75mcg|1 cp ao dia|Gineco
        M|Gestodeno|75mcg|1 cp ao dia|Gineco
        M|Drospirenona|3mg|1 cp ao dia|Gineco
        M|Medroxiprogesterona|150mg|IM trimestral|Gineco
        M|Noretisterona|0.35mg|1 cp ao dia|Gineco
        M|Levonorgestrel (PDS)|1.5mg|Dose única|Gineco
        M|Estradiol|1mg|1 cp ao dia|Gineco
        M|Estriol|Creme|Aplicar vaginal|Gineco
        M|Promestrieno|Creme|Aplicar vaginal|Gineco
        M|Testosterona|Gel|Aplicar na pele|Endócrino
        M|Sildenafila|50mg|1 cp 1h antes|Uro
        M|Tadalafila|5mg|1 cp ao dia|Uro
        M|Tadalafila|20mg|1 cp antes relação|Uro
        M|Vardenafila|20mg|1 cp antes relação|Uro
        M|Finasterida|5mg|1 cp ao dia|Uro
        M|Dutasterida|0.5mg|1 cp ao dia|Uro
        M|Doxazosina|2mg|1 cp à noite|Uro
        M|Doxazosina|4mg|1 cp à noite|Uro
        M|Tansulosina|0.4mg|1 cp ao dia|Uro
        M|Oxibutinina|5mg|1 cp 8/8h|Uro
        M|Solifenacina|5mg|1 cp ao dia|Uro
        M|Darifenacina|7.5mg|1 cp ao dia|Uro
        M|Mirabegrona|50mg|1 cp ao dia|Uro
        M|Permetrina|Loção|Aplicar no corpo|Dermato
        M|Ivermectina|6mg|Conforme peso|Dermato
        M|Tiabendazol|Pmd|Aplicar na lesão|Dermato
        M|Albendazol|400mg|1 cp dose única|Dermato
        M|Mebendazol|100mg|1 cp 12/12h 3 dias|Dermato
        M|Neomicina+Bacitracina|Pmd|Aplicar na lesão|Dermato
        M|Sulfadiazina de Prata|Creme|Aplicar na queimadura|Dermato
        M|Colagenase|Pmd|Aplicar na lesão|Dermato
        M|Hidrocortisona|Creme|Aplicar na lesão|Dermato
        M|Betametasona|Creme|Aplicar na lesão|Dermato
        M|Clobetasol|Creme|Aplicar na lesão|Dermato
        M|Desonida|Creme|Aplicar na lesão|Dermato
        M|Mometasona|Creme|Aplicar na lesão|Dermato
        M|Adapaleno|Gel|Aplicar à noite|Dermato
        M|Tretinoína|Creme|Aplicar à noite|Dermato
        M|Isotretinoína|20mg|1 cp ao dia|Dermato
        M|Peróxido de Benzoíla|Gel|Aplicar na acne|Dermato
        M|Clindamicina tópica|Gel|Aplicar na acne|Dermato
        M|Eritromicina tópica|Gel|Aplicar na acne|Dermato
        M|Cetoconazol shampoo|Liq|Lavar couro cabeludo|Dermato
        M|Selênio|Shampoo|Lavar couro cabeludo|Dermato
        E|Hemograma Completo|Lab|Sangue
        E|Glicemia de Jejum|Lab|Sangue
        E|Hemoglobina Glicada (HbA1c)|Lab|Sangue
        E|Colesterol Total|Lab|Sangue
        E|HDL Colesterol|Lab|Sangue
        E|LDL Colesterol|Lab|Sangue
        E|VLDL Colesterol|Lab|Sangue
        E|Triglicerídeos|Lab|Sangue
        E|Ureia|Lab|Sangue
        E|Creatinina|Lab|Sangue
        E|Sódio|Lab|Sangue
        E|Potássio|Lab|Sangue
        E|Cálcio Total|Lab|Sangue
        E|Cálcio Iônico|Lab|Sangue
        E|Magnésio|Lab|Sangue
        E|Fósforo|Lab|Sangue
        E|Ácido Úrico|Lab|Sangue
        E|TGO (AST)|Lab|Sangue
        E|TGP (ALT)|Lab|Sangue
        E|Gama GT|Lab|Sangue
        E|Fosfatase Alcalina|Lab|Sangue
        E|Bilirrubina Total e Frações|Lab|Sangue
        E|Amilase|Lab|Sangue
        E|Lipase|Lab|Sangue
        E|Proteínas Totais e Frações|Lab|Sangue
        E|Albumina|Lab|Sangue
        E|TSH|Lab|Sangue
        E|T4 Livre|Lab|Sangue
        E|T3 Total|Lab|Sangue
        E|T3 Livre|Lab|Sangue
        E|Anti-TPO|Lab|Sangue
        E|TRAB|Lab|Sangue
        E|LH|Lab|Sangue
        E|FSH|Lab|Sangue
        E|Estradiol|Lab|Sangue
        E|Progesterona|Lab|Sangue
        E|Testosterona Total|Lab|Sangue
        E|Testosterona Livre|Lab|Sangue
        E|Prolactina|Lab|Sangue
        E|Cortisol Basal|Lab|Sangue
        E|PTH|Lab|Sangue
        E|Vitamina B12|Lab|Sangue
        E|Vitamina D (25-OH)|Lab|Sangue
        E|Ácido Fólico|Lab|Sangue
        E|Ferritina|Lab|Sangue
        E|Ferro Sérico|Lab|Sangue
        E|Capacidade de Ligação do Ferro|Lab|Sangue
        E|Saturação de Transferrina|Lab|Sangue
        E|PSA Total|Lab|Sangue
        E|PSA Livre|Lab|Sangue
        E|CA-125|Lab|Sangue
        E|CEA|Lab|Sangue
        E|CA 19-9|Lab|Sangue
        E|Alfa-fetoproteína|Lab|Sangue
        E|Beta HCG Quantitativo|Lab|Sangue
        E|HIV 1 e 2 (Sorologia)|Lab|Sangue
        E|VDRL|Lab|Sangue
        E|FTA-ABS|Lab|Sangue
        E|HBsAg|Lab|Sangue
        E|Anti-HBs|Lab|Sangue
        E|Anti-HBc Total|Lab|Sangue
        E|Anti-HCV|Lab|Sangue
        E|Sorologia Dengue IgM/IgG|Lab|Sangue
        E|Sorologia Chikungunya IgM/IgG|Lab|Sangue
        E|Sorologia Zika IgM/IgG|Lab|Sangue
        E|Sorologia Toxoplasmose IgM/IgG|Lab|Sangue
        E|Sorologia Rubéola IgM/IgG|Lab|Sangue
        E|Sorologia CMV IgM/IgG|Lab|Sangue
        E|Epstein-Barr IgM/IgG|Lab|Sangue
        E|Proteína C Reativa (PCR)|Lab|Sangue
        E|VHS|Lab|Sangue
        E|Fator Reumatoide|Lab|Sangue
        E|FAN (Hep-2)|Lab|Sangue
        E|Anti-DNA|Lab|Sangue
        E|Anti-Ro|Lab|Sangue
        E|Anti-La|Lab|Sangue
        E|Anti-CCP|Lab|Sangue
        E|ASLO|Lab|Sangue
        E|Complemento C3|Lab|Sangue
        E|Complemento C4|Lab|Sangue
        E|EAS (Urina Tipo 1)|Lab|Urina
        E|Urocultura com Antibiograma|Lab|Urina
        E|Microalbuminúria|Lab|Urina
        E|Proteinúria de 24h|Lab|Urina
        E|Parasitológico de Fezes|Lab|Fezes
        E|Sangue Oculto nas Fezes|Lab|Fezes
        E|Coprocultura|Lab|Fezes
        E|RX Tórax PA e Perfil|Img|Raio-X
        E|RX Seios da Face|Img|Raio-X
        E|RX Abdome Agudo|Img|Raio-X
        E|RX Abdome Simples|Img|Raio-X
        E|RX Coluna Cervical|Img|Raio-X
        E|RX Coluna Torácica|Img|Raio-X
        E|RX Coluna Lombar|Img|Raio-X
        E|RX Bacia|Img|Raio-X
        E|RX Quadril|Img|Raio-X
        E|RX Joelho|Img|Raio-X
        E|RX Ombro|Img|Raio-X
        E|RX Mãos e Punhos|Img|Raio-X
        E|RX Pé e Tornozelo|Img|Raio-X
        E|USG Abdome Total|Img|Ultrassom
        E|USG Abdome Superior|Img|Ultrassom
        E|USG Vias Urinárias|Img|Ultrassom
        E|USG Pélvica|Img|Ultrassom
        E|USG Transvaginal|Img|Ultrassom
        E|USG Obstétrica|Img|Ultrassom
        E|USG Obstétrica com Doppler|Img|Ultrassom
        E|USG Morfológica 1º Trimestre|Img|Ultrassom
        E|USG Morfológica 2º Trimestre|Img|Ultrassom
        E|USG Tireoide|Img|Ultrassom
        E|USG Tireoide com Doppler|Img|Ultrassom
        E|USG Mamas|Img|Ultrassom
        E|USG Próstata Via Abdominal|Img|Ultrassom
        E|USG Próstata Transretal|Img|Ultrassom
        E|USG Doppler Venoso MMII|Img|Ultrassom
        E|USG Doppler Arterial MMII|Img|Ultrassom
        E|USG Doppler Carótidas e Vertebrais|Img|Ultrassom
        E|TC Crânio|Img|Tomografia
        E|TC Seios da Face|Img|Tomografia
        E|TC Tórax|Img|Tomografia
        E|TC Abdome Total|Img|Tomografia
        E|TC Abdome Superior|Img|Tomografia
        E|TC Pelve|Img|Tomografia
        E|TC Coluna Cervical|Img|Tomografia
        E|TC Coluna Lombar|Img|Tomografia
        E|TC Mastoides|Img|Tomografia
        E|RM Crânio|Img|Ressonância
        E|RM Sela Túrcica|Img|Ressonância
        E|RM Coluna Cervical|Img|Ressonância
        E|RM Coluna Lombar|Img|Ressonância
        E|RM Joelho|Img|Ressonância
        E|RM Ombro|Img|Ressonância
        E|RM Quadril|Img|Ressonância
        E|RM Abdome Superior|Img|Ressonância
        E|RM Pelve|Img|Ressonância
        E|Eletrocardiograma (ECG)|Gf|Cardio
        E|Ecocardiograma Transtorácico|Gf|Cardio
        E|Teste Ergométrico|Gf|Cardio
        E|Holter 24h|Gf|Cardio
        E|MAPA 24h|Gf|Cardio
        E|Cintilografia Miocárdica|Img|Cardio
        E|Angiotomografia de Coronárias|Img|Cardio
        E|Endoscopia Digestiva Alta|Gf|Gastro
        E|Colonoscopia|Gf|Gastro
        E|Espirometria|Gf|Pneumo
        E|Audiometria|Gf|Otorrino
        E|Impedanciometria|Gf|Otorrino
        E|Densitometria Óssea|Gf|Reumato
        E|Mamografia Digital|Img|Gineco
        `;

        /* BIBLIOTECA COMPLETA DE IA (220+ FERRAMENTAS RESTAURADAS) */
        const AI_LIBRARY = [
            // --- Diagnóstico Geral ---
            { id: 'second_opinion', cat: 'Diagnóstico', label: 'Segunda Opinião', icon: 'brain-circuit', color: 'indigo', prompt: 'Analise criticamente: {soap}.' },
            { id: 'differential', cat: 'Diagnóstico', label: 'Diag. Diferencial', icon: 'git-pull-request', color: 'indigo', prompt: 'Liste diagnósticos diferenciais com probabilidade para: {s} {o} {a}.' },
            { id: 'symptom_checker', cat: 'Diagnóstico', label: 'Sintomas', icon: 'activity', color: 'indigo', prompt: 'Analise os sintomas: {s}. Agrupe em síndromes.' },
            { id: 'red_flags', cat: 'Diagnóstico', label: 'Red Flags', icon: 'flag', color: 'red', prompt: 'Identifique sinais de alerta em: {soap}.' },
            { id: 'anamnesis_gap', cat: 'Diagnóstico', label: 'O que faltou?', icon: 'help-circle', color: 'slate', prompt: 'O que esqueci de perguntar?' },
            { id: 'lab_interpret', cat: 'Diagnóstico', label: 'Interpretar Labs', icon: 'test-tube', color: 'teal', prompt: 'Interprete exames em {o}.' },
            { id: 'rare_disease', cat: 'Diagnóstico', label: 'Doença Rara', icon: 'search', color: 'purple', prompt: 'Considere doenças raras.' },
            
            // --- Cardiologia ---
            { id: 'ecg_interpret', cat: 'Cardiologia', label: 'Laudo ECG', icon: 'activity', color: 'red', prompt: 'Interprete este ECG descrito: {o}.' },
            { id: 'cardio_risk', cat: 'Cardiologia', label: 'Risco CV', icon: 'heart', color: 'red', prompt: 'Estime risco CV (Framingham) para: {s} {o}.' },
            { id: 'has_guideline', cat: 'Cardiologia', label: 'HAS 2020', icon: 'book', color: 'blue', prompt: 'Manejo HAS 2020 para este paciente.' },
            { id: 'cha2ds2', cat: 'Cardiologia', label: 'CHA2DS2-VASc', icon: 'calculator', color: 'blue', prompt: 'Calcule CHA2DS2-VASc: {s} {o}.' },
            { id: 'has_bled', cat: 'Cardiologia', label: 'HAS-BLED', icon: 'droplet', color: 'red', prompt: 'Risco sangramento HAS-BLED.' },
            { id: 'lipid_target', cat: 'Cardiologia', label: 'Alvo LDL', icon: 'target', color: 'orange', prompt: 'Alvo LDL: {s}.' },
            { id: 'hf_pilar', cat: 'Cardiologia', label: 'IC Pilares', icon: 'layers', color: 'green', prompt: '4 pilares da IC para: {meds}.' },
            { id: 'timi_score', cat: 'Cardiologia', label: 'TIMI Score', icon: 'bar-chart', color: 'red', prompt: 'TIMI Score IAM.' },
            { id: 'grace_score', cat: 'Cardiologia', label: 'GRACE', icon: 'bar-chart', color: 'red', prompt: 'GRACE Score.' },
            { id: 'killip', cat: 'Cardiologia', label: 'Killip', icon: 'activity', color: 'purple', prompt: 'Classificação Killip.' },
            { id: 'nyha', cat: 'Cardiologia', label: 'NYHA', icon: 'activity', color: 'blue', prompt: 'Classe NYHA.' },
            { id: 'qt_c', cat: 'Cardiologia', label: 'QTc', icon: 'activity', color: 'yellow', prompt: 'Cálculo QTc.' },
            
            // --- Emergência ---
            { id: 'sepsis_protocol', cat: 'Emergência', label: 'Protocolo Sepse', icon: 'alert-triangle', color: 'orange', prompt: 'Checklist Sepse.' },
            { id: 'acls_guide', cat: 'Emergência', label: 'ACLS', icon: 'zap', color: 'red', prompt: 'Conduta ACLS.' },
            { id: 'stroke_protocol', cat: 'Emergência', label: 'AVC Agudo', icon: 'brain', color: 'purple', prompt: 'Checklist AVC.' },
            { id: 'anaphylaxis', cat: 'Emergência', label: 'Anafilaxia', icon: 'wind', color: 'red', prompt: 'Manejo anafilaxia.' },
            { id: 'qsofa', cat: 'Emergência', label: 'qSOFA', icon: 'alert-circle', color: 'orange', prompt: 'Calcule qSOFA: {o}.' },
            { id: 'glasgow', cat: 'Emergência', label: 'Glasgow', icon: 'eye', color: 'green', prompt: 'Calcule Glasgow: {o}.' },
            { id: 'news2', cat: 'Emergência', label: 'NEWS-2', icon: 'monitor', color: 'blue', prompt: 'Score NEWS-2.' },
            { id: 'sofa', cat: 'Emergência', label: 'SOFA', icon: 'bar-chart-2', color: 'red', prompt: 'Score SOFA.' },
            { id: 'burn_parkland', cat: 'Emergência', label: 'Queimados', icon: 'flame', color: 'orange', prompt: 'Fórmula Parkland.' },
            { id: 'poisoning', cat: 'Emergência', label: 'Intoxicação', icon: 'skull', color: 'slate', prompt: 'Manejo intoxicação.' },
            { id: 'htn_crisis', cat: 'Emergência', label: 'Crise HAS', icon: 'arrow-up', color: 'red', prompt: 'Emergência Hipertensiva.' },
            { id: 'status_epi', cat: 'Emergência', label: 'Status Epilepticus', icon: 'zap-off', color: 'purple', prompt: 'Status Epilepticus.' },
            
            // --- Nefrologia ---
            { id: 'gfr_calc', cat: 'Nefrologia', label: 'TFG (CKD-EPI)', icon: 'droplet', color: 'yellow', prompt: 'Estime TFG com creatinina em {o}.' },
            { id: 'acid_base', cat: 'Nefrologia', label: 'Gasometria', icon: 'file-text', color: 'gray', prompt: 'Interprete gasometria.' },
            { id: 'aki_kdigo', cat: 'Nefrologia', label: 'IRA KDIGO', icon: 'bar-chart', color: 'orange', prompt: 'Estágio IRA KDIGO.' },
            { id: 'fena', cat: 'Nefrologia', label: 'FeNa', icon: 'percent', color: 'blue', prompt: 'Cálculo FeNa.' },
            { id: 'hyperkalemia', cat: 'Nefrologia', label: 'Hipercalemia', icon: 'alert-octagon', color: 'red', prompt: 'Manejo potássio alto.' },
            { id: 'hyponatremia', cat: 'Nefrologia', label: 'Hiponatremia', icon: 'activity', color: 'blue', prompt: 'Correção sódio.' },
            
            // --- Endocrinologia ---
            { id: 'dk_protocol', cat: 'Endocrinologia', label: 'Cetoacidose', icon: 'alert-triangle', color: 'red', prompt: 'Protocolo CAD.' },
            { id: 'insulin_sliding', cat: 'Endocrinologia', label: 'Escala Insulina', icon: 'syringe', color: 'blue', prompt: 'Sugira esquema insulina.' },
            { id: 'thyroid_nodule', cat: 'Endocrinologia', label: 'Nódulo Tireoide', icon: 'circle', color: 'purple', prompt: 'TIRADS.' },
            { id: 'hba1c_target', cat: 'Endocrinologia', label: 'Alvo HbA1c', icon: 'target', color: 'green', prompt: 'Alvo glicada.' },
            { id: 'osteoporosis', cat: 'Endocrinologia', label: 'Osteoporose', icon: 'bone', color: 'slate', prompt: 'Manejo osteoporose.' },
            { id: 'adrenal', cat: 'Endocrinologia', label: 'Insuf. Adrenal', icon: 'triangle', color: 'orange', prompt: 'Crise adrenal.' },
            
            // --- Gastro ---
            { id: 'child_pugh', cat: 'Gastro', label: 'Child-Pugh', icon: 'activity', color: 'yellow', prompt: 'Calcule Child-Pugh: {o}.' },
            { id: 'meld', cat: 'Gastro', label: 'MELD', icon: 'calculator', color: 'orange', prompt: 'Calcule MELD: {o}.' },
            { id: 'upper_bleed', cat: 'Gastro', label: 'HDA Glasgow', icon: 'droplet', color: 'red', prompt: 'Glasgow-Blatchford.' },
            { id: 'h_pylori', cat: 'Gastro', label: 'H. Pylori', icon: 'bug', color: 'green', prompt: 'Erradicação H. Pylori.' },
            { id: 'ranson', cat: 'Gastro', label: 'Ranson', icon: 'list', color: 'purple', prompt: 'Critérios Ranson pancreatite: {o}.' },
            { id: 'rome_iv', cat: 'Gastro', label: 'Roma IV', icon: 'book', color: 'blue', prompt: 'Critérios Roma IV.' },
            
            // --- Pneumo ---
            { id: 'copd_gold', cat: 'Pneumo', label: 'DPOC GOLD', icon: 'wind', color: 'slate', prompt: 'Classifique DPOC: {s}.' },
            { id: 'asthma_gina', cat: 'Pneumo', label: 'Asma GINA', icon: 'feather', color: 'blue', prompt: 'Manejo Asma GINA: {s}.' },
            { id: 'pneumonia_psi', cat: 'Pneumo', label: 'CURB-65', icon: 'wind', color: 'red', prompt: 'Calcule CURB-65: {s} {o}.' },
            { id: 'well_pe', cat: 'Pneumo', label: 'Wells TEP', icon: 'alert-circle', color: 'red', prompt: 'Score Wells para TEP: {s}.' },
            { id: 'light_criteria', cat: 'Pneumo', label: 'Light Derrame', icon: 'droplet', color: 'yellow', prompt: 'Critérios Light.' },
            { id: 'perc_rule', cat: 'Pneumo', label: 'PERC TEP', icon: 'check-circle', color: 'green', prompt: 'Regra PERC.' },
            
            // --- Neuro ---
            { id: 'nihss', cat: 'Neuro', label: 'NIHSS', icon: 'calculator', color: 'purple', prompt: 'Estime NIHSS: {o}.' },
            { id: 'hints', cat: 'Neuro', label: 'HINTS', icon: 'rotate-cw', color: 'blue', prompt: 'Protocolo HINTS.' },
            { id: 'abcd2', cat: 'Neuro', label: 'ABCD2', icon: 'alert-triangle', color: 'orange', prompt: 'Score ABCD2 para AIT: {s}.' },
            { id: 'hunt_hess', cat: 'Neuro', label: 'Hunt-Hess', icon: 'activity', color: 'red', prompt: 'Classificação Hunt-Hess HSA: {o}.' },
            { id: 'headache_red', cat: 'Neuro', label: 'SNOOP4', icon: 'flag', color: 'red', prompt: 'SNOOP4 Cefaleia.' },
            { id: 'delirium_cam', cat: 'Neuro', label: 'CAM Delirium', icon: 'alert-circle', color: 'orange', prompt: 'CAM Delirium.' },
            
            // --- Infecto ---
            { id: 'uti_treat', cat: 'Infecto', label: 'ITU', icon: 'activity', color: 'blue', prompt: 'Tratamento ITU.' },
            { id: 'dengue_stage', cat: 'Infecto', label: 'Dengue', icon: 'bug', color: 'green', prompt: 'Classifique Dengue: {s}.' },
            { id: 'endocarditis', cat: 'Infecto', label: 'Endocardite', icon: 'heart', color: 'red', prompt: 'Critérios Duke.' },
            { id: 'meningitis', cat: 'Infecto', label: 'Líquor', icon: 'test-tube', color: 'yellow', prompt: 'Líquor meningite.' },
            { id: 'hiv_oi', cat: 'Infecto', label: 'IO HIV', icon: 'shield-off', color: 'purple', prompt: 'Infecções Oportunistas.' },
            { id: 'sirs', cat: 'Infecto', label: 'SIRS', icon: 'thermometer', color: 'orange', prompt: 'Critérios SIRS.' },
            
            // --- Pediatria ---
            { id: 'ped_dose', cat: 'Pediatria', label: 'Dose Ped', icon: 'baby', color: 'pink', prompt: 'Calcule dose para peso em {o} de: {meds}.' },
            { id: 'hydration_ped', cat: 'Pediatria', label: 'Holliday-Segar', icon: 'droplet', color: 'blue', prompt: 'Holliday-Segar para peso em {o}.' },
            { id: 'centor', cat: 'Pediatria', label: 'Centor', icon: 'thermometer', color: 'orange', prompt: 'Critérios Centor amigdalite: {s}.' },
            { id: 'apgar', cat: 'Pediatria', label: 'APGAR', icon: 'star', color: 'green', prompt: 'Calcule APGAR: {o}.' },
            { id: 'milestones', cat: 'Pediatria', label: 'Desenvolvimento', icon: 'star', color: 'yellow', prompt: 'Marcos desenvolvimento.' },
            { id: 'vaccine', cat: 'Pediatria', label: 'Vacinas', icon: 'syringe', color: 'blue', prompt: 'Vacinação.' },
            { id: 'kawasaki', cat: 'Pediatria', label: 'Kawasaki', icon: 'heart', color: 'red', prompt: 'Critérios Kawasaki.' },
            
            // --- Gineco/Obs ---
            { id: 'preeclampsia', cat: 'Gineco', label: 'Pré-Eclâmpsia', icon: 'alert-triangle', color: 'red', prompt: 'Risco Pré-Eclâmpsia.' },
            { id: 'std_cdc', cat: 'Gineco', label: 'IST CDC', icon: 'shield', color: 'purple', prompt: 'Tratamento IST.' },
            { id: 'gestational', cat: 'Gineco', label: 'IG Calculadora', icon: 'calendar', color: 'pink', prompt: 'Idade Gestacional.' },
            { id: 'bishop', cat: 'Gineco', label: 'Bishop', icon: 'activity', color: 'pink', prompt: 'Índice de Bishop: {o}.' },
            { id: 'abx_preg', cat: 'Gineco', label: 'ATB Gestação', icon: 'bug', color: 'green', prompt: 'Antibiótico gestante.' },
            { id: 'contraception', cat: 'Gineco', label: 'Critérios MEC', icon: 'circle', color: 'pink', prompt: 'Elegibilidade contraceptiva.' },
            
            // --- Psiquiatria ---
            { id: 'suicide_risk', cat: 'Psiquiatria', label: 'Suicídio', icon: 'life-buoy', color: 'red', prompt: 'Avalie risco suicídio: {s}.' },
            { id: 'dsm5', cat: 'Psiquiatria', label: 'Critérios DSM-5', icon: 'book-open', color: 'purple', prompt: 'Verifique critérios DSM-5 para: {s}.' },
            { id: 'mental_exam', cat: 'Psiquiatria', label: 'Súmula', icon: 'brain', color: 'purple', prompt: 'Exame mental.' },
            { id: 'ciwa', cat: 'Psiquiatria', label: 'CIWA-Ar', icon: 'wine-off', color: 'red', prompt: 'Abstinência álcool.' },
            { id: 'audit_c', cat: 'Psiquiatria', label: 'AUDIT-C', icon: 'wine', color: 'purple', prompt: 'Rastreio álcool AUDIT-C: {s}.' },
            { id: 'phq9', cat: 'Psiquiatria', label: 'PHQ-9', icon: 'check-square', color: 'blue', prompt: 'Depressão PHQ-9.' },
            
            // --- Reumato ---
            { id: 'lupus', cat: 'Reumato', label: 'Critérios LES', icon: 'flower-2', color: 'purple', prompt: 'Critérios Lupus.' },
            { id: 'ra_criteria', cat: 'Reumato', label: 'Artrite Reum.', icon: 'hand', color: 'orange', prompt: 'Critérios AR.' },
            { id: 'gout', cat: 'Reumato', label: 'Gota', icon: 'footprints', color: 'red', prompt: 'Manejo Gota.' },
            { id: 'fibro', cat: 'Reumato', label: 'Fibromialgia', icon: 'user', color: 'pink', prompt: 'Fibromialgia.' },
            
            // --- Terapêutica ---
            { id: 'interactions', cat: 'Terapêutica', label: 'Interações', icon: 'shuffle', color: 'red', prompt: 'Interações medicamentosas.' },
            { id: 'renal_adjust', cat: 'Terapêutica', label: 'Ajuste Renal', icon: 'activity', color: 'blue', prompt: 'Ajuste renal.' },
            { id: 'pregnancy_risk', cat: 'Terapêutica', label: 'Risco Gest.', icon: 'baby', color: 'pink', prompt: 'Risco gestação.' },
            { id: 'breastfeeding', cat: 'Terapêutica', label: 'Lactação', icon: 'baby', color: 'pink', prompt: 'Lactação.' },
            { id: 'antibiotic_ch', cat: 'Terapêutica', label: 'Escolha ATB', icon: 'bug', color: 'emerald', prompt: 'Escolha antibiótico.' },
            { id: 'deprescribing', cat: 'Terapêutica', label: 'Desprescrição', icon: 'trash-2', color: 'green', prompt: 'Desprescrição idoso.' },
            
            // --- Documentos ---
            { id: 'referral', cat: 'Documentos', label: 'Encaminhar', icon: 'send', color: 'slate', prompt: 'Carta encaminhamento.' },
            { id: 'laudo', cat: 'Documentos', label: 'Laudo', icon: 'file-text', color: 'slate', prompt: 'Laudo médico.' },
            { id: 'certificate', cat: 'Documentos', label: 'Atestado', icon: 'file-badge', color: 'slate', prompt: 'Texto atestado.' },
            { id: 'travel', cat: 'Documentos', label: 'Viagem', icon: 'plane', color: 'sky', prompt: 'Carta viagem.' },
            { id: 'gym', cat: 'Documentos', label: 'Academia', icon: 'dumbbell', color: 'emerald', prompt: 'Atestado academia.' },
            
            // --- Outros ---
            { id: 'diet', cat: 'Nutrição', label: 'Dieta', icon: 'carrot', color: 'green', prompt: 'Plano dietético.' },
            { id: 'caloric', cat: 'Nutrição', label: 'Calorias', icon: 'calculator', color: 'green', prompt: 'Necessidade calórica.' },
            { id: 'enteral', cat: 'Nutrição', label: 'Enteral', icon: 'test-tube', color: 'blue', prompt: 'Dieta enteral.' },
            { id: 'snake_bite', cat: 'Toxico', label: 'Ofídico', icon: 'alert-triangle', color: 'green', prompt: 'Acidente ofídico.' },
            { id: 'paracetamol', cat: 'Toxico', label: 'Paracetamol', icon: 'skull', color: 'red', prompt: 'Intoxicação paracetamol.' },
            { id: 'dermato', cat: 'Dermato', label: 'Lesão', icon: 'scan-eye', color: 'pink', prompt: 'Análise lesão pele.' },
            { id: 'pre_op', cat: 'Cirurgia', label: 'Risco Cir.', icon: 'clipboard-check', color: 'blue', prompt: 'Risco cirúrgico.' },
            { id: 'post_op', cat: 'Cirurgia', label: 'Pós-Op', icon: 'bandage', color: 'slate', prompt: 'Cuidados pós-op.' },
            { id: 'ottawa', cat: 'Ortopedia', label: 'Ottawa', icon: 'bone', color: 'slate', prompt: 'Regras Ottawa.' },
            { id: 'back_pain', cat: 'Ortopedia', label: 'Lombalgia', icon: 'flag', color: 'red', prompt: 'Red flags lombalgia.' },
            { id: 'c_spine', cat: 'Ortopedia', label: 'C-Spine', icon: 'activity', color: 'orange', prompt: 'Canadian C-Spine.' },
            { id: 'frailty', cat: 'Geriatria', label: 'Fragilidade', icon: 'user', color: 'gray', prompt: 'Escala fragilidade.' },
            { id: 'beers', cat: 'Geriatria', label: 'Beers', icon: 'pill', color: 'red', prompt: 'Critérios Beers.' },
            { id: 'falls', cat: 'Geriatria', label: 'Quedas', icon: 'arrow-down-right', color: 'orange', prompt: 'Risco queda.' },
            { id: 'palliative', cat: 'Paliativos', label: 'Sintomas', icon: 'sunset', color: 'orange', prompt: 'Manejo sintomas.' },
            { id: 'opioid_conv', cat: 'Paliativos', label: 'Opioide', icon: 'repeat', color: 'green', prompt: 'Conversão opioide.' },
            { id: 'chemo_tox', cat: 'Oncologia', label: 'Tox Quimio', icon: 'alert-octagon', color: 'red', prompt: 'Toxicidade quimio.' },
            { id: 'tnm', cat: 'Oncologia', label: 'TNM', icon: 'layers', color: 'slate', prompt: 'Estadiamento TNM.' },
            { id: 'braden', cat: 'Enfermagem', label: 'Braden', icon: 'layers', color: 'orange', prompt: 'Escala Braden.' },
            { id: 'iv_dilution', cat: 'Enfermagem', label: 'Diluição', icon: 'droplet', color: 'blue', prompt: 'Diluição medicação.' },
            { id: 'anemia', cat: 'Hemato', label: 'Anemia', icon: 'droplet', color: 'red', prompt: 'Investigação anemia.' },
            { id: 'coag', cat: 'Hemato', label: 'Coagulograma', icon: 'clock', color: 'blue', prompt: 'Interpretação coagulograma.' },
            { id: 'transfusion', cat: 'Hemato', label: 'Transfusão', icon: 'beaker', color: 'red', prompt: 'Guia transfusão.' }
        ];

        const app = (function() {
            let state = {
                meds: [], 
                exams: [],
                config: JSON.parse(localStorage.getItem('neuro_config')) || { name: 'Dr. Médico', crm: '00000' },
                prescription: [], 
                examRequest: [], 
                hospitalLines: Array(35).fill(""), 
                activeDocument: 'prescription', 
                searchTimeout: null
            };

            function init() {
                loadDatabase();
                lucide.createIcons();
                updateDocumentView();
                renderAITools();
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('calcUsgDate').max = today;
                document.getElementById('calcDum').max = today;
                updateConfigUI();
            }

            function loadDatabase() {
                const lines = COMPRESSED_DB.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                lines.forEach(line => {
                    const parts = line.split('|');
                    if (parts[0] === 'M') {
                        state.meds.push({ 
                            name: parts[1], 
                            dose: parts[2], 
                            instr: parts[3], 
                            cat: parts[4], 
                            id: Math.random().toString(36).substr(2, 9) 
                        });
                    }
                    // CORREÇÃO CRÍTICA DE PARSING PARA EXAMES
                    if (parts[0] === 'E') {
                        state.exams.push({ 
                            name: parts[1], 
                            type: parts[2], 
                            cat: parts[3],  
                            id: Math.random().toString(36).substr(2, 9) 
                        });
                    }
                });
            }

            // ... (Restante das funções mantidas) ...
            function searchDatabase(type, query) {
                const indicator = document.getElementById('loadingIndicator');
                const list = type === 'med' ? document.getElementById('medicationList') : document.getElementById('examList');
                
                if (state.searchTimeout) clearTimeout(state.searchTimeout);

                if (!query) {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-slate-400 opacity-60"><i data-lucide="database" class="w-10 h-10 mb-2"></i><span class="text-xs font-medium">Digite para buscar</span></div>`;
                    lucide.createIcons();
                    return;
                }

                indicator.classList.remove('hidden');
                indicator.classList.add('flex');

                state.searchTimeout = setTimeout(() => {
                    const lowerQ = query.toLowerCase();
                    let results = [];
                    
                    if (type === 'med') {
                        results = state.meds.filter(m => m.name.toLowerCase().includes(lowerQ) || m.cat.toLowerCase().includes(lowerQ)).slice(0, 50);
                        renderMedResults(results);
                    } else {
                        results = state.exams.filter(e => e.name.toLowerCase().includes(lowerQ) || (e.cat && e.cat.toLowerCase().includes(lowerQ))).slice(0, 50);
                        renderExamResults(results);
                    }
                    
                    indicator.classList.add('hidden');
                    indicator.classList.remove('flex');
                }, 300);
            }

            function renderMedResults(results) {
                const list = document.getElementById('medicationList');
                if (results.length === 0) { list.innerHTML = `<div class="p-4 text-center text-slate-400">Nada encontrado.</div>`; return; }
                list.innerHTML = results.map(m => `
                    <button onclick="app.addItem('${m.id}', 'med')" class="w-full text-left p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 hover:border-emerald-500 hover:shadow-sm transition group">
                        <div class="flex justify-between"><span class="font-bold text-slate-700 dark:text-slate-200 group-hover:text-emerald-600">${m.name}</span><span class="text-[10px] bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded text-slate-500">${m.cat}</span></div>
                        <div class="text-xs text-slate-400 mt-1">${m.dose} • ${m.instr}</div>
                    </button>`).join('');
            }

            function renderExamResults(results) {
                const list = document.getElementById('examList');
                if (results.length === 0) { list.innerHTML = `<div class="p-4 text-center text-slate-400">Nada encontrado.</div>`; return; }
                list.innerHTML = results.map(e => `
                    <button onclick="app.addItem('${e.id}', 'exam')" class="w-full text-left p-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 hover:border-orange-500 hover:shadow-sm transition group">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-slate-700 dark:text-slate-200 group-hover:text-orange-600">${e.name}</span>
                            <span class="text-[10px] uppercase font-bold text-slate-400">${e.cat || 'Geral'}</span>
                        </div>
                        <div class="text-xs text-slate-400 mt-1">${e.type}</div>
                    </button>`).join('');
            }

            function addItem(id, type) {
                if(type === 'med') {
                    const item = state.meds.find(i => i.id === id);
                    if(item) {
                        state.prescription.push({ ...item, uid: Date.now() });
                        const emptyIdx = state.hospitalLines.findIndex(l => l === "");
                        if (emptyIdx !== -1) { state.hospitalLines[emptyIdx] = `${item.name} ${item.dose} - ${item.instr}`; }
                        setDocumentMode('prescription');
                    }
                } else {
                    const item = state.exams.find(i => i.id === id);
                    if(item) {
                        state.examRequest.push({ ...item, uid: Date.now() });
                        setDocumentMode('exams');
                    }
                }
                // Force update view
                updateDocumentView();
                // Ensure mobile document panel is visible if on mobile
                if(window.innerWidth < 1024) {
                    const panel = document.getElementById('documentPanel');
                    if(panel.classList.contains('hidden')) {
                        app.toggleMobileDoc();
                    }
                }
            }

            function removeItem(uid, type) {
                if(type === 'med') state.prescription = state.prescription.filter(i => i.uid != uid);
                else state.examRequest = state.examRequest.filter(i => i.uid != uid);
                updateDocumentView();
            }

            function updateHospitalLine(index, value) {
                state.hospitalLines[index] = value.toUpperCase();
            }

            /* --- AI LOGIC --- */
            function renderAITools(filter = '') {
                const container = document.getElementById('aiToolsContainer');
                container.innerHTML = '';
                const filtered = AI_LIBRARY.filter(t => t.label.toLowerCase().includes(filter.toLowerCase()) || t.cat.toLowerCase().includes(filter.toLowerCase()));
                const cats = [...new Set(filtered.map(t => t.cat))];
                cats.forEach(cat => {
                    const section = document.createElement('div');
                    section.innerHTML = `<h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-3 ml-1 flex items-center gap-2">${cat}</h3>`;
                    const grid = document.createElement('div'); grid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3';
                    grid.innerHTML = filtered.filter(t => t.cat === cat).map(t => {
                        const theme = {
                            bg: `bg-${t.color}-100 dark:bg-${t.color}-900/30`, 
                            text: `text-${t.color}-800 dark:text-${t.color}-200`,
                            hover: `hover:bg-${t.color}-200 dark:hover:bg-${t.color}-900/50`
                        };
                        return `<button onclick="app.callAI('${t.id}')" class="ai-card group flex flex-col items-start justify-between p-3 h-[60px] w-full rounded-xl ${theme.bg} ${theme.text} ${theme.hover} cursor-pointer">
                            <div class="w-full flex justify-start"><i data-lucide="${t.icon}" class="w-5 h-5"></i></div>
                            <span class="text-[11px] font-bold text-left leading-tight w-full truncate">${t.label}</span>
                        </button>`
                    }).join('');
                    section.appendChild(grid); container.appendChild(section);
                });
                lucide.createIcons();
            }
            function filterAITools() { renderAITools(document.getElementById('aiToolSearch').value); }

            async function callAI(toolId) {
                if(!state.config.apiKey) { alert("Configure a API Key!"); openModal('configModal'); return; }
                const tool = AI_LIBRARY.find(t => t.id === toolId);
                const s = document.getElementById('soapS').value; const o = document.getElementById('soapO').value;
                const a = document.getElementById('soapA').value; const p = document.getElementById('soapP').value;
                const meds = state.prescription.map(m => `${m.name} ${m.dose}`).join(', ');
                let prompt = tool.prompt.replace('{s}', s||'NI').replace('{o}', o||'NI').replace('{a}', a||'NI').replace('{p}', p||'NI').replace('{soap}', `S: ${s}\nO: ${o}\nA: ${a}\nP: ${p}`).replace('{meds}', meds||'Nenhuma');
                prompt += "\n\nIMPORTANTE: Responda em HTML usando classes TailwindCSS. NÃO use Markdown.";
                
                document.getElementById('aiModalTitle').innerText = tool.label;
                document.getElementById('aiModalContent').innerHTML = '<div class="flex justify-center py-10"><i data-lucide="loader" class="w-8 h-8 animate-spin text-indigo-600"></i></div>';
                openModal('aiModal'); lucide.createIcons();

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.config.apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    let html = data.candidates?.[0]?.content?.parts?.[0]?.text || "<p class='text-red-500'>Erro na geração.</p>";
                    document.getElementById('aiModalContent').innerHTML = html.replace(/```html|```/g, '');
                } catch(e) { document.getElementById('aiModalContent').innerHTML = `<p class="text-red-500">Erro: ${e.message}</p>`; }
            }

            /* --- CALC OBS --- */
            function calcObs() {
                const today = new Date(); today.setHours(0,0,0,0);
                const dumVal = document.getElementById('calcDum').value;
                if(dumVal) {
                    const dumDate = new Date(dumVal + 'T00:00:00');
                    const diffDays = Math.floor((today - dumDate) / (1000 * 60 * 60 * 24));
                    const dpp = new Date(dumDate); dpp.setDate(dumDate.getDate() + 280);
                    document.getElementById('resIgDum').innerText = `${Math.floor(diffDays/7)}s ${diffDays%7}d`;
                    document.getElementById('resDppDum').innerText = `DPP: ${dpp.toLocaleDateString('pt-BR')}`;
                }
                const usgVal = document.getElementById('calcUsgDate').value;
                const usgW = parseInt(document.getElementById('calcUsgW').value)||0;
                const usgD = parseInt(document.getElementById('calcUsgD').value)||0;
                if(usgVal && usgW) {
                    const usgDate = new Date(usgVal + 'T00:00:00');
                    const conceptionDate = new Date(usgDate); conceptionDate.setDate(conceptionDate.getDate() - ((usgW*7)+usgD));
                    const diffDays = Math.floor((today - conceptionDate) / (1000 * 60 * 60 * 24));
                    const dpp = new Date(conceptionDate); dpp.setDate(conceptionDate.getDate() + 280);
                    document.getElementById('resIgUsg').innerText = `${Math.floor(diffDays/7)}s ${diffDays%7}d`;
                    document.getElementById('resDppUsg').innerText = `DPP: ${dpp.toLocaleDateString('pt-BR')}`;
                }
            }
            function pasteIg(id) { document.getElementById('soapA').value += `\nIG: ${document.getElementById(id).innerText}`; closeModal('obstetricModal'); }

            /* --- UI UTILS --- */
            function updateDocumentView() {
                const doc = document.getElementById('prescriptionPaper');
                const pName = document.getElementById('patientNameInput').value || "_______________________";
                const date = new Date().toLocaleDateString('pt-BR');
                const config = state.config;

                let contentHtml = '';

                if (state.activeDocument === 'hospital') {
                    // HOSPITALAR: Grade completa + Evolução no final
                    const rows = state.hospitalLines.map((val, i) => `
                        <div class="hospital-line">
                            <div class="hospital-line-num">${i+1}</div>
                            <input type="text" class="hospital-line-input" value="${val}" oninput="app.updateHospitalLine(${i}, this.value)">
                        </div>
                    `).join('');

                    contentHtml = `
                        <div style="display: flex; flex-direction: column; height: 100%;">
                            <div style="border: 2px solid #000; margin-bottom: 10px;">
                                <div style="display: flex; border-bottom: 1px solid #000;">
                                    <div style="flex: 1; padding: 5px; border-right: 1px solid #000;">
                                        <strong style="font-size: 10pt; text-transform: uppercase;">Nome Paciente</strong><br>
                                        <span class="print-patient-name">${pName}</span>
                                    </div>
                                    <div style="width: 200px; padding: 5px;">
                                        <strong style="font-size: 10pt; text-transform: uppercase;">Médico</strong><br>
                                        <span>${config.name}</span>
                                    </div>
                                </div>
                                <div style="display: flex;">
                                    <div style="width: 100px; padding: 5px; border-right: 1px solid #000; text-align: center;">
                                        <strong style="font-size: 10pt;">DATA</strong><br>
                                        <span>${date}</span>
                                    </div>
                                    <div style="flex: 1; padding: 5px; text-align: center; background: #f0f0f0; border-right: 1px solid #000;">
                                        <h2 style="margin: 0; font-size: 14pt; text-transform: uppercase;">Prescrição Médica</h2>
                                    </div>
                                    <div style="width: 80px; padding: 5px; border-right: 1px solid #000; text-align: center;">
                                        <strong style="font-size: 8pt;">Leito</strong><br>__
                                    </div>
                                    <div style="width: 100px; padding: 5px; text-align: center;">
                                        <strong style="font-size: 8pt;">Prontuário</strong><br>__
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1; border: 2px solid #000; display: flex; flex-direction: column;">
                                <div style="background: #ddd; border-bottom: 1px solid #000; padding: 2px; text-align: center; font-weight: bold; font-size: 10pt;">ITENS DA PRESCRIÇÃO</div>
                                <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                                    ${rows}
                                </div>
                            </div>

                            <div style="height: 150px; border: 2px solid #000; margin-top: 10px; padding: 5px; display: flex;">
                                <div style="flex: 1; padding-right: 10px;">
                                    <strong style="font-size: 10pt; text-transform: uppercase;">Evolução / Anotações</strong>
                                    <textarea style="width: 100%; height: 80%; border: none; outline: none; resize: none; font-family: 'Arial'; font-size: 12pt; background: transparent;"></textarea>
                                </div>
                                <div style="width: 200px; display: flex; align-items: flex-end; justify-content: center; text-align: center;">
                                    <div>
                                        <div style="border-top: 1px solid #000; width: 180px; margin-bottom: 2px;"></div>
                                        <strong>${config.name}</strong><br>
                                        <span style="font-size: 10pt;">${config.crm}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // RECEITA OU EXAMES (SIMPLES)
                    let listItems = '';
                    if(state.activeDocument === 'prescription') {
                        listItems = state.prescription.length 
                            ? state.prescription.map((m,i) => `<div style="margin-bottom: 15px;">
                                <div style="font-weight: bold; font-size: 12pt;">${i+1}. ${m.name} ${m.dose}</div>
                                <div style="padding-left: 20px; font-size: 11pt; font-style: italic;">${m.instr}</div>
                                <button onclick="app.removeItem(${m.uid},'med')" class="no-print" style="color: red; font-size: 10px; cursor: pointer;">[Remover]</button>
                            </div>`).join('') 
                            : '<div style="text-align: center; color: #999; margin-top: 50px;">Adicione medicamentos</div>';
                    } else {
                        listItems = state.examRequest.length 
                            ? `<ul style="list-style-type: disc; padding-left: 20px;">` + state.examRequest.map(e => `<li style="margin-bottom: 8px;">
                                <span style="font-size: 12pt;">${e.name}</span>
                                <button onclick="app.removeItem(${e.uid},'exam')" class="no-print" style="color: red; font-size: 10px; cursor: pointer; margin-left: 10px;">[x]</button>
                            </li>`).join('') + `</ul>` 
                            : '<div style="text-align: center; color: #999; margin-top: 50px;">Adicione exames</div>';
                    }

                    contentHtml = `
                        <div style="padding: 40px; height: 100%; display: flex; flex-direction: column; font-family: 'Arial', sans-serif;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 30px;">
                                <div>
                                    <h1 style="font-size: 18pt; font-weight: bold; text-transform: uppercase; margin: 0;">${config.name}</h1>
                                    <p style="font-size: 10pt; margin: 0;">CRM: ${config.crm}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="font-size: 11pt; margin: 0;">${date}</p>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 30px;">
                                <span style="font-size: 10pt; font-weight: bold; text-transform: uppercase; color: #555;">Paciente</span><br>
                                <span class="print-patient-name" style="font-size: 14pt; font-weight: bold; text-transform: uppercase;">${pName}</span>
                            </div>

                            <div style="flex: 1;">
                                ${listItems}
                            </div>

                            <div style="margin-top: auto; border-top: 1px solid #ccc; padding-top: 20px; text-align: center; font-size: 9pt; color: #777;">
                                Documento emitido digitalmente em ${date}.
                            </div>
                        </div>
                    `;
                }

                doc.innerHTML = contentHtml;
                lucide.createIcons();
            }

            function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active')); document.getElementById('tabContent-'+id).classList.add('active'); document.querySelectorAll('.bottom-nav-item').forEach(e => e.classList.remove('active')); document.getElementById('mb-nav-'+id)?.classList.add('active'); if(id==='pharmacy') setDocumentMode('prescription'); if(id==='exams') setDocumentMode('exams'); }
            function setDocumentMode(mode) { state.activeDocument = mode; document.getElementById('docMode-prescription').className = mode==='prescription'?'doc-switch-btn active':'doc-switch-btn inactive'; document.getElementById('docMode-exams').className = mode==='exams'?'doc-switch-btn active':'doc-switch-btn inactive'; document.getElementById('docMode-hospital').className = mode==='hospital'?'doc-switch-btn active':'doc-switch-btn inactive'; updateDocumentView(); }
            function toggleMobileDoc() { 
                const p = document.getElementById('documentPanel');
                if (p.classList.contains('hidden')) {
                    // OPEN
                    p.classList.remove('hidden', 'lg:flex');
                    p.classList.add('mobile-fullscreen'); // Use custom class
                    document.getElementById('mobileBottomNav').style.display = 'none'; // Hide Nav
                    document.getElementById('mainHeader').style.display = 'none'; // Hide Header
                } else {
                    // CLOSE
                    p.classList.add('hidden', 'lg:flex');
                    p.classList.remove('mobile-fullscreen');
                    document.getElementById('mobileBottomNav').style.display = 'flex'; // Show Nav
                    document.getElementById('mainHeader').style.display = 'flex'; // Show Header
                }
            }
            function toggleTheme() { document.documentElement.classList.toggle('dark'); localStorage.setItem('neuro_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); }
            function loadTheme() { if(localStorage.getItem('neuro_theme') === 'dark') document.documentElement.classList.add('dark'); }
            function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
            function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
            function generatePDF() { 
                const el = document.getElementById('prescriptionPaper'); 
                const opt = {
                    margin: 0,
                    filename: state.activeDocument + '.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                html2pdf().set(opt).from(el).save(); 
            }
            function saveConfig() { state.config.name = document.getElementById('cfgName').value; state.config.crm = document.getElementById('cfgCrm').value; state.config.apiKey = document.getElementById('apiKeyInput').value; localStorage.setItem('neuro_config', JSON.stringify(state.config)); if(state.config.apiKey) document.getElementById('apiKeyStatus').classList.replace('bg-red-500','bg-emerald-500'); closeModal('configModal'); updateDocumentView(); }
            function updateConfigUI() { document.getElementById('cfgName').value = state.config.name; document.getElementById('cfgCrm').value = state.config.crm; document.getElementById('apiKeyInput').value = state.config.apiKey || ''; if(state.config.apiKey) document.getElementById('apiKeyStatus').classList.replace('bg-red-500','bg-emerald-500'); }
            function copyAIContent() { const r = document.createRange(); r.selectNode(document.getElementById('aiModalContent')); window.getSelection().removeAllRanges(); window.getSelection().addRange(r); document.execCommand('copy'); alert("Copiado!"); }
            function openMagicSoap() { openModal('magicSoapModal'); }
            async function generateMagicSoap() { if(!state.config.apiKey) return alert("Sem API Key"); const txt = document.getElementById('magicSoapInput').value; const btn = document.querySelector('#magicSoapModal button[onclick="app.generateMagicSoap()"]'); const old = btn.innerHTML; btn.innerHTML = 'Processando...'; try { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.config.apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: "Extraia SOAP JSON de: " + txt }] }] }) }); const data = await response.json(); const json = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```json|```/g, '')); document.getElementById('soapS').value = json.s||''; document.getElementById('soapO').value = json.o||''; document.getElementById('soapA').value = json.a||''; document.getElementById('soapP').value = json.p||''; closeModal('magicSoapModal'); } catch(e) { alert("Erro"); } finally { btn.innerHTML = old; } }
            function handleExamUpload(input) { /* Simulado */ alert("Anexado (Simulado)"); }
            function clearPatientData() { document.getElementById('patientNameInput').value=''; document.getElementById('soapS').value=''; document.getElementById('soapO').value=''; document.getElementById('soapA').value=''; document.getElementById('soapP').value=''; state.prescription=[]; state.examRequest=[]; state.hospitalLines=Array(35).fill(""); updateDocumentView(); }

            return { init, searchDatabase, addItem, removeItem, calcObs, pasteIg, updateDocumentView, switchTab, setDocumentMode, toggleMobileDoc, toggleTheme, openModal, closeModal, generatePDF, saveConfig, copyAIContent, callAI, renderAITools, filterAITools, openMagicSoap, generateMagicSoap, handleExamUpload, clearPatientData, updateHospitalLine };
        })();
        window.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
