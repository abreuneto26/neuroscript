<!DOCTYPE html>
<html lang="pt-br" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroScript - Suíte Clínica Inteligente</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'], 
                        serif: ['Merriweather', 'serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: {
                        medical: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        }
                    },
                    boxShadow: {
                        'paper': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0,0,0,0.02)',
                        'floating': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 20px rgba(99, 102, 241, 0.15)',
                        'glow-blue': '0 0 15px rgba(6, 182, 212, 0.4)'
                    }
                }
            }
        }
    </script>

    <!-- Ícones e PDF -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .dark body { background-color: #0f172a; }
        
        /* Custom Scrollbar Clean */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Glass Panel Effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        }
        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
        }

        /* Tab Animation */
        .tab-content { display: none !important; animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-content.active { display: flex !important; flex-direction: column; height: 100%; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* Document Switcher */
        .doc-switch-btn { @apply px-4 py-1.5 text-xs font-bold rounded-lg transition-all border shadow-sm; }
        .doc-switch-btn.active { @apply bg-slate-800 text-white border-slate-800 shadow-md scale-105 dark:bg-white dark:text-slate-900; }
        .doc-switch-btn.inactive { @apply bg-white text-slate-500 border-slate-200 hover:bg-slate-50 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700 dark:hover:bg-slate-700; }

        /* Hospital Input */
        .hospital-input { @apply w-full bg-transparent outline-none font-mono text-slate-900 px-1 h-full border-b border-dotted border-slate-300 focus:border-slate-900 transition-colors uppercase text-sm; }

        /* Premium Notebook Card */
        .notebook-card {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .notebook-card:active { transform: scale(0.95); }
        .notebook-card:hover { transform: translateY(-3px); box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15); z-index: 10; }
        
        /* Dark Mode Glow Effects for Cards */
        .dark .notebook-card:hover {
            box-shadow: 0 0 20px rgba(var(--card-glow-color), 0.2);
            border-color: rgba(var(--card-glow-color), 0.5);
        }

        /* Mobile Bottom Nav - Magic Soap Style (Blue Gradient) */
        .bottom-nav-item {
            @apply flex flex-col items-center justify-center w-full h-full text-slate-400 transition-all duration-300 rounded-xl scale-90 gap-1;
        }
        .bottom-nav-item.active {
            @apply bg-gradient-to-br from-cyan-400 to-blue-600 text-white shadow-lg shadow-cyan-500/30 scale-100 -translate-y-2;
        }
        .bottom-nav-item.active i {
            @apply text-white fill-white/20 stroke-[2.5px]; 
        }
        .bottom-nav-item:not(.active):hover {
            @apply bg-slate-50 dark:bg-slate-800/50 text-slate-600 dark:text-slate-300;
        }

        /* Sticky Headers for Lists */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(8px);
        }

        /* Print Styles */
        @media print {
            @page { margin: 0; size: auto; } 
            body { background: white; }
            .no-print { display: none !important; }
            .print-container { 
                box-shadow: none !important; border: none !important; margin: 0 !important; 
                padding: 0 !important; height: auto !important; width: 100% !important; transform: none !important; 
            }
            #prescriptionPaper { min-height: 0 !important; height: auto !important; }
        }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-100 h-screen overflow-hidden flex flex-col">

    <!-- HEADER -->
    <header class="w-full z-50 glass-panel h-16 flex items-center justify-between px-6 no-print shrink-0 shadow-sm relative">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-cyan-400 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-purple-500/20 shrink-0">
                <i data-lucide="brain-circuit" class="text-white w-6 h-6 stroke-[2.5px]"></i>
            </div>
            <div class="flex flex-col justify-center h-full pt-1">
                <div class="flex items-baseline leading-none">
                    <h1 class="text-2xl font-bold tracking-tight text-slate-900 dark:text-white">
                        Neuro<span class="text-cyan-500 dark:text-cyan-400">Script</span>
                    </h1>
                    <span class="text-sm font-light text-slate-400 dark:text-slate-500 uppercase tracking-widest ml-2" style="font-family: 'Inter', sans-serif;">ULTIMATE</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="app.toggleTheme()" class="p-2.5 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800/50 transition text-slate-500 border border-transparent hover:border-slate-200 dark:hover:border-slate-700">
                <i data-lucide="sun" class="hidden dark:block w-5 h-5"></i>
                <i data-lucide="moon" class="block dark:hidden w-5 h-5"></i>
            </button>
            <div class="h-6 w-px bg-slate-200 dark:bg-slate-800 mx-1"></div>
            <button onclick="app.openModal('configModal')" class="p-2.5 hover:bg-slate-100 dark:hover:bg-slate-800/50 rounded-xl transition relative text-slate-600 dark:text-slate-300 border border-transparent hover:border-slate-200 dark:hover:border-slate-700">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span id="apiKeyStatus" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full ring-2 ring-white dark:ring-slate-900 shadow-sm"></span>
            </button>
            <button onclick="app.generatePDF()" class="bg-slate-900 hover:bg-black text-white px-5 py-2.5 rounded-xl text-sm font-bold flex gap-2 items-center transition shadow-lg shadow-slate-900/20 dark:bg-white dark:text-slate-900 dark:hover:bg-slate-100 hidden md:flex hover:-translate-y-0.5 active:translate-y-0">
                <i data-lucide="printer" class="w-4 h-4"></i> Imprimir
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex flex-col flex-1 overflow-hidden max-w-[1920px] mx-auto w-full relative">
        
        <!-- Navigation Bar (Desktop) -->
        <div class="no-print hidden lg:flex border-b border-slate-200 dark:border-slate-800 px-6 bg-white/60 dark:bg-slate-950/60 backdrop-blur-md z-20 justify-between items-center">
            <div class="flex space-x-1">
                <button onclick="app.switchTab('patient')" id="tabButton-patient" class="tab-button group relative px-6 py-4 text-sm font-semibold text-slate-500 hover:text-slate-900 dark:hover:text-white transition-colors">
                    <div class="flex items-center gap-2"><i data-lucide="user-circle-2" class="w-4 h-4"></i> Paciente</div>
                    <span class="absolute bottom-0 left-0 w-full h-0.5 bg-slate-900 dark:bg-white scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></span>
                </button>
                <button onclick="app.switchTab('ai')" id="tabButton-ai" class="tab-button group relative px-6 py-4 text-sm font-semibold text-slate-500 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">
                    <div class="flex items-center gap-2"><i data-lucide="sparkles" class="w-4 h-4"></i> IA Clínica</div>
                    <span class="absolute bottom-0 left-0 w-full h-0.5 bg-indigo-600 scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></span>
                </button>
                <button onclick="app.switchTab('pharmacy')" id="tabButton-pharmacy" class="tab-button group relative px-6 py-4 text-sm font-semibold text-slate-500 hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors">
                    <div class="flex items-center gap-2"><i data-lucide="pill" class="w-4 h-4"></i> Farmácia</div>
                    <span class="absolute bottom-0 left-0 w-full h-0.5 bg-emerald-600 scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></span>
                </button>
                <button onclick="app.switchTab('exams')" id="tabButton-exams" class="tab-button group relative px-6 py-4 text-sm font-semibold text-slate-500 hover:text-orange-600 dark:hover:text-orange-400 transition-colors">
                    <div class="flex items-center gap-2"><i data-lucide="microscope" class="w-4 h-4"></i> Exames</div>
                    <span class="absolute bottom-0 left-0 w-full h-0.5 bg-orange-600 scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></span>
                </button>
            </div>
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2 bg-slate-100 dark:bg-slate-800/50 px-3 py-1.5 rounded-full">
                <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div> v2.0
            </div>
        </div>

        <div class="flex flex-col lg:flex-row flex-1 overflow-hidden relative">
            
            <!-- LEFT PANEL -->
            <div id="leftPanelContainer" class="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-6 lg:border-r border-slate-200 dark:border-slate-800 h-full bg-white/30 dark:bg-slate-900/30 transition-all duration-300 pb-28 lg:pb-6">
                
                <!-- TAB: PATIENT -->
                <div id="tabContent-patient" class="tab-content active flex-col gap-6">
                    <div class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6">
                        
                        <!-- Header Paciente -->
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-sm font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-1 flex items-center gap-2">
                                    <i data-lucide="fingerprint" class="w-4 h-4 text-slate-400"></i> Identificação
                                </h2>
                                <p class="text-xs text-slate-500">Registro clínico (SOAP)</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="app.openMagicSoap()" class="group flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl text-xs font-bold shadow-lg shadow-indigo-500/20 hover:shadow-indigo-500/40 hover:scale-105 transition-all active:scale-95">
                                    <i data-lucide="wand-2" class="w-3 h-3 group-hover:rotate-12 transition-transform"></i> <span class="hidden sm:inline">Magic SOAP</span>
                                </button>
                                <button onclick="app.clearPatientData()" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>

                        <!-- Busca Paciente -->
                        <div class="relative mb-6 group">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-lucide="search" class="h-4 w-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                            </div>
                            <input type="text" id="patientNameInput" oninput="app.searchPatient()" placeholder="Nome do paciente..." 
                                class="block w-full pl-10 pr-3 py-3 border border-slate-200 dark:border-slate-700 rounded-xl leading-5 bg-slate-50 dark:bg-slate-800 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition-all font-medium">
                        </div>

                        <!-- Grid SOAP -->
                        <div class="grid grid-cols-1 gap-4">
                            <div class="bg-slate-50/50 dark:bg-slate-800/30 rounded-xl p-4 border border-slate-200 dark:border-slate-700 hover:border-indigo-400 dark:hover:border-indigo-500 transition-colors group">
                                <label class="text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-wider mb-2 flex items-center gap-1.5">
                                    <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full"></div> S - Subjetivo
                                </label>
                                <textarea id="soapS" class="w-full bg-transparent text-sm resize-none outline-none min-h-[100px] placeholder-slate-400/50" placeholder="Queixa principal, HDA, histórico..."></textarea>
                            </div>

                            <div class="bg-slate-50/50 dark:bg-slate-800/30 rounded-xl p-4 border border-slate-200 dark:border-slate-700 hover:border-emerald-400 dark:hover:border-emerald-500 transition-colors relative group">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-wider flex items-center gap-1.5">
                                        <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full"></div> O - Objetivo
                                    </label>
                                    <button onclick="document.getElementById('examUploadInput').click()" class="text-[10px] flex items-center gap-1 text-slate-500 hover:text-emerald-600 transition bg-white dark:bg-slate-800 px-2.5 py-1 rounded-lg border border-slate-200 dark:border-slate-600 shadow-sm hover:shadow">
                                        <i data-lucide="paperclip" class="w-3 h-3"></i> Anexar
                                    </button>
                                    <input type="file" id="examUploadInput" multiple accept="image/*,application/pdf" class="hidden" onchange="app.handleExamUpload(this)">
                                </div>
                                <textarea id="soapO" class="w-full bg-transparent text-sm resize-none outline-none min-h-[100px] placeholder-slate-400/50" placeholder="Exame físico, sinais vitais, resultados de exames..."></textarea>
                                
                                <!-- Lista de Anexos -->
                                <div id="examPreviewContainer" class="hidden flex flex-col gap-2 mt-3">
                                    <!-- Injetado via JS -->
                                </div>
                            </div>

                            <div class="bg-slate-50/50 dark:bg-slate-800/30 rounded-xl p-4 border border-slate-200 dark:border-slate-700 hover:border-orange-400 dark:hover:border-orange-500 transition-colors group">
                                <label class="text-[10px] font-bold text-orange-600 dark:text-orange-400 uppercase tracking-wider mb-2 flex items-center gap-1.5">
                                    <div class="w-1.5 h-1.5 bg-orange-500 rounded-full"></div> A - Avaliação
                                </label>
                                <textarea id="soapA" class="w-full bg-transparent text-sm resize-none outline-none min-h-[80px] placeholder-slate-400/50" placeholder="Diagnóstico, hipóteses, raciocínio clínico..."></textarea>
                            </div>

                            <div class="bg-slate-50/50 dark:bg-slate-800/30 rounded-xl p-4 border border-slate-200 dark:border-slate-700 hover:border-blue-400 dark:hover:border-blue-500 transition-colors group">
                                <label class="text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider mb-2 flex items-center gap-1.5">
                                    <div class="w-1.5 h-1.5 bg-blue-500 rounded-full"></div> P - Plano
                                </label>
                                <textarea id="soapP" class="w-full bg-transparent text-sm resize-none outline-none min-h-[80px] placeholder-slate-400/50" placeholder="Conduta, prescrição, orientações..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: AI TOOLS -->
                <div id="tabContent-ai" class="tab-content flex-col gap-4 h-full">
                    <div class="relative">
                        <input type="text" id="aiToolSearch" oninput="app.filterAITools()" placeholder="O que você precisa? (ex: risco cirúrgico, pediatria...)" 
                            class="w-full pl-11 pr-4 py-3.5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl shadow-sm text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all font-medium">
                        <i data-lucide="search" class="absolute left-4 top-3.5 w-5 h-5 text-slate-400"></i>
                    </div>
                    <div id="aiToolsContainer" class="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-8 pb-10 pt-2">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- TAB: PHARMACY (ATUALIZADA) -->
                <div id="tabContent-pharmacy" class="tab-content flex-col gap-4 h-full">
                    <div class="flex justify-between items-center gap-2">
                         <div class="relative flex-1">
                            <input type="text" id="medSearch" oninput="app.renderMeds()" placeholder="Buscar medicamento..." class="w-full pl-10 pr-3 py-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-emerald-500 outline-none shadow-sm">
                            <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                        </div>
                        <button onclick="app.openConfigMedModal()" class="bg-emerald-600 text-white p-3 rounded-xl hover:bg-emerald-700 transition shadow-md hover:shadow-emerald-500/30 active:scale-95"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <!-- Lista de Medicamentos com Categorias -->
                    <div id="medicationList" class="flex-1 overflow-y-auto custom-scrollbar pr-1 pb-10"></div>
                </div>

                <!-- TAB: EXAMS (ATUALIZADA) -->
                <div id="tabContent-exams" class="tab-content flex-col gap-4 h-full">
                    <div class="relative">
                        <input type="text" id="examSearch" oninput="app.renderExams()" placeholder="Buscar exame (ex: hemograma, rx...)" class="w-full pl-10 pr-3 py-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-orange-500 outline-none shadow-sm">
                        <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                    </div>
                    <!-- Lista de Exames com Pastas -->
                    <div id="examList" class="flex-1 overflow-y-auto custom-scrollbar pr-1 pb-10"></div>
                </div>

            </div>

            <!-- RIGHT PANEL: DOCUMENT PREVIEW (RESPONSIVE) -->
            <div id="documentPanel" class="hidden lg:flex flex-1 bg-slate-100/80 dark:bg-slate-950/50 border-l border-slate-200 dark:border-slate-800 justify-center overflow-y-auto custom-scrollbar p-8 shrink-0 h-full relative transition-all duration-300 backdrop-blur-sm">
                
                <!-- Mobile Close Button -->
                <button onclick="app.toggleMobileDoc()" class="lg:hidden absolute top-4 right-4 p-2 bg-white dark:bg-slate-800 rounded-full text-slate-600 dark:text-slate-300 z-50 shadow-md">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>

                <button onclick="app.toggleSidebar()" class="hidden lg:block absolute top-4 left-4 p-2 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 hover:bg-slate-50 z-10 text-slate-500 transition-all active:scale-95">
                    <i data-lucide="panel-left" class="w-5 h-5"></i>
                </button>

                <div class="flex flex-col items-center w-full max-w-full pt-16 lg:pt-0">
                    <!-- Switcher -->
                    <div class="flex p-1.5 bg-white dark:bg-slate-900 rounded-xl mb-8 shadow-sm border border-slate-200 dark:border-slate-800 scale-95 lg:scale-100">
                        <button onclick="app.setDocumentMode('prescription')" id="docMode-prescription" class="doc-switch-btn active">Receita</button>
                        <button onclick="app.setDocumentMode('exams')" id="docMode-exams" class="doc-switch-btn inactive">Exames</button>
                        <button onclick="app.setDocumentMode('hospital')" id="docMode-hospital" class="doc-switch-btn inactive">Hospitalar</button>
                    </div>

                    <!-- Document Paper -->
                    <div class="w-full flex justify-center pb-24 lg:pb-10 overflow-x-auto px-4 lg:px-0">
                        <div id="prescriptionPaper" class="print-container bg-white text-slate-900 shadow-paper relative flex flex-col transition-all duration-300 origin-top scale-[0.85] origin-top-center lg:scale-100 ring-1 ring-black/5">
                            <!-- Content injected by JS -->
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- MOBILE BOTTOM NAV -->
    <nav class="lg:hidden fixed bottom-6 left-4 right-4 h-20 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 z-50 shadow-2xl shadow-slate-300/50 dark:shadow-black/50 rounded-2xl flex justify-around items-center px-2">
        <button onclick="app.switchTab('patient')" id="mb-nav-patient" class="bottom-nav-item active">
            <i data-lucide="user-circle-2" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold tracking-wide">SOAP</span>
        </button>
        <button onclick="app.switchTab('ai')" id="mb-nav-ai" class="bottom-nav-item">
            <i data-lucide="sparkles" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold tracking-wide">IA</span>
        </button>
        <!-- Central Button -->
        <button onclick="app.toggleMobileDoc()" class="bottom-nav-item" id="mb-nav-doc">
            <i data-lucide="file-text" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold tracking-wide">Ver Doc</span>
        </button>
        <button onclick="app.switchTab('pharmacy')" id="mb-nav-pharmacy" class="bottom-nav-item">
            <i data-lucide="pill" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold tracking-wide">Farmácia</span>
        </button>
         <button onclick="app.switchTab('exams')" id="mb-nav-exams" class="bottom-nav-item">
            <i data-lucide="microscope" class="w-6 h-6"></i>
            <span class="text-[10px] font-bold tracking-wide">Exames</span>
        </button>
    </nav>

    <!-- MODALS (MAGIC SOAP, RESULTADO IA, CONFIG, ADD MED) -->
    <!-- ... (Mantendo a estrutura dos modais idêntica para brevidade, apenas o conteúdo JS muda) ... -->
    <div id="magicSoapModal" class="hidden fixed inset-0 z-[90] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4 transition-opacity">
         <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 w-full max-w-2xl rounded-3xl shadow-2xl flex flex-col max-h-[85vh] overflow-hidden scale-100 ring-1 ring-black/5">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-gradient-to-r from-indigo-50/50 to-white dark:from-slate-800/50 dark:to-slate-900">
                <h3 class="font-bold text-xl flex items-center gap-2 text-indigo-600 dark:text-indigo-400 tracking-tight"><i data-lucide="wand-2" class="w-5 h-5"></i> Magic SOAP 2.0</h3>
                <button onclick="app.closeModal('magicSoapModal')" class="text-slate-400 hover:text-slate-600 bg-slate-100 dark:bg-slate-800 p-2 rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="p-8 grow flex flex-col gap-6 overflow-y-auto bg-slate-50/30 dark:bg-black/20">
                <p class="text-sm text-slate-500 font-medium">
                    Cole um texto desorganizado, envie um áudio ou <strong class="text-indigo-600 dark:text-indigo-400">faça upload de uma foto de anotação manual</strong>. A IA estruturará tudo.
                </p>
                
                <textarea id="magicSoapInput" class="w-full flex-1 rounded-2xl p-5 text-sm resize-none outline-none border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-indigo-500 transition-all min-h-[140px] shadow-sm" placeholder="Ex: Paciente Joao, 45 anos, dor no peito há 2 horas..."></textarea>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="border border-dashed border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800/50 rounded-2xl p-5 flex flex-col items-center justify-center text-center hover:bg-indigo-50/50 dark:hover:bg-indigo-900/20 hover:border-indigo-300 transition cursor-pointer relative group">
                        <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                            <i data-lucide="mic" class="w-6 h-6 text-purple-600 dark:text-purple-400"></i>
                        </div>
                        <span class="text-xs font-bold text-slate-600 dark:text-slate-300">Áudio (MP3/WAV)</span>
                        <input type="file" id="magicSoapAudio" accept="audio/*" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>
                    <div class="border border-dashed border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800/50 rounded-2xl p-5 flex flex-col items-center justify-center text-center hover:bg-indigo-50/50 dark:hover:bg-indigo-900/20 hover:border-indigo-300 transition cursor-pointer relative group">
                        <div class="w-12 h-12 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                            <i data-lucide="camera" class="w-6 h-6 text-indigo-600 dark:text-indigo-400"></i>
                        </div>
                        <span class="text-xs font-bold text-slate-600 dark:text-slate-300">Foto Manuscrito/Nota</span>
                        <input type="file" id="magicSoapImage" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 flex justify-end gap-3">
                <button onclick="app.closeModal('magicSoapModal')" class="px-5 py-2.5 rounded-xl border border-slate-300 dark:border-slate-700 text-slate-600 dark:text-slate-400 font-bold text-sm hover:bg-slate-50 dark:hover:bg-slate-800 transition">Cancelar</button>
                <button onclick="app.generateMagicSoap()" class="px-8 py-2.5 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white text-sm font-bold shadow-lg shadow-indigo-500/30 flex items-center gap-2 transition-all active:scale-95 hover:-translate-y-0.5">
                    <i data-lucide="sparkles" class="w-4 h-4"></i> Processar
                </button>
            </div>
        </div>
    </div>

    <div id="aiModal" class="hidden fixed inset-0 z-[80] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
         <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 w-full max-w-3xl rounded-3xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden ring-1 ring-white/10">
            <div class="p-5 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                <h3 id="aiModalTitle" class="font-bold text-lg flex items-center gap-2 text-slate-800 dark:text-white">Resultado</h3>
                <button onclick="app.closeModal('aiModal')" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition"><i data-lucide="x" class="w-5 h-5 opacity-50"></i></button>
            </div>
            <div class="p-8 overflow-y-auto custom-scrollbar grow ai-table-container bg-white dark:bg-slate-950">
                <div id="aiModalContent" class="text-sm leading-relaxed text-slate-700 dark:text-slate-300 font-sans"></div>
            </div>
            <div class="p-5 border-t border-slate-200 dark:border-slate-800 flex justify-end gap-2 bg-slate-50 dark:bg-slate-900">
                <button onclick="app.copyAIContent()" class="px-5 py-2.5 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 text-xs font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition">Copiar Texto</button>
                <button onclick="app.closeModal('aiModal')" class="px-5 py-2.5 rounded-xl bg-slate-900 dark:bg-white text-white dark:text-slate-900 text-xs font-bold hover:bg-slate-800 dark:hover:bg-slate-200 transition shadow-lg">Fechar</button>
            </div>
        </div>
    </div>

    <div id="configModal" class="hidden fixed inset-0 z-[60] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4">
         <div class="bg-white dark:bg-slate-900 p-8 rounded-3xl w-full max-w-lg shadow-2xl border border-slate-200 dark:border-slate-800">
            <div class="flex justify-between mb-8 items-center">
                <h3 class="text-2xl font-bold tracking-tight">Configurações</h3>
                <button onclick="app.closeModal('configModal')" class="text-slate-400 hover:text-slate-600 bg-slate-100 dark:bg-slate-800 p-2 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="space-y-6">
                <div class="p-5 bg-indigo-50 dark:bg-indigo-900/10 rounded-2xl border border-indigo-100 dark:border-indigo-800/30">
                    <label class="block text-xs font-bold text-indigo-600 dark:text-indigo-400 mb-3 uppercase tracking-wider">Gemini API Key</label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" placeholder="Cole sua chave aqui..." class="w-full p-3.5 pl-10 rounded-xl border bg-white dark:bg-slate-950 border-slate-200 dark:border-slate-700 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all shadow-sm">
                        <i data-lucide="key" class="absolute left-3.5 top-3.5 w-4 h-4 text-slate-400"></i>
                    </div>
                </div>
                <div class="border-t border-slate-200 dark:border-slate-800 pt-6 grid gap-4">
                    <label class="block text-xs font-bold uppercase tracking-wider text-slate-500">Dados do Cabeçalho</label>
                    <input id="cfgName" placeholder="Nome do Médico" class="w-full p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-sm">
                    <input id="cfgSpec" placeholder="Especialidade" class="w-full p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-sm">
                    <input id="cfgCrm" placeholder="CRM / Registro" class="w-full p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-sm">
                    <div class="grid grid-cols-2 gap-3">
                        <input id="cfgPhone" placeholder="Telefone" class="w-full p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-sm">
                        <input id="cfgAddress" placeholder="Endereço" class="w-full p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-sm">
                    </div>
                    <input id="cfgLogo" placeholder="URL do Logo (Opcional)" class="w-full p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-sm">
                </div>
                <button onclick="app.saveConfig()" class="w-full bg-slate-900 hover:bg-black dark:bg-white dark:text-slate-900 dark:hover:bg-slate-100 text-white p-4 rounded-xl font-bold mt-2 transition shadow-lg transform active:scale-98">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <div id="addMedModal" class="hidden fixed inset-0 z-[60] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl w-full max-w-md border border-slate-200 dark:border-slate-800 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Adicionar Medicamento</h3>
            <div class="space-y-3">
                <input id="newMedName" placeholder="Nome Comercial/Genérico" class="w-full p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700">
                <input id="newMedDose" placeholder="Dose (ex: 500mg)" class="w-full p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700">
                <textarea id="newMedInstr" placeholder="Posologia Padrão" class="w-full p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700"></textarea>
                <select id="newMedCat" class="w-full p-3 rounded-xl border bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-600">
                    <option value="Geral">Geral</option><option value="Cardiologia">Cardiologia</option><option value="Psiquiatria">Psiquiatria</option><option value="Antibióticos">Antibióticos</option>
                </select>
                <div class="flex gap-2 mt-4">
                    <button onclick="app.closeModal('addMedModal')" class="flex-1 p-3 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-600 hover:bg-slate-50 font-bold text-sm">Cancelar</button>
                    <button onclick="app.addNewMedication()" class="flex-1 bg-emerald-600 text-white p-3 rounded-xl font-bold text-sm hover:bg-emerald-700 shadow-lg shadow-emerald-500/20">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* DADOS DE EXAMES HIERARQUIZADOS */
        const EXAM_CATALOG = {
            "Laboratoriais": {
                "Hematologia": [
                    "Hemograma Completo", "Eritrograma", "Leucograma", "Plaquetas", "Grupo Sanguíneo e Fator Rh", "Coombs Direto", "Coombs Indireto", "Reticulócitos", "Velocidade de Hemossedimentação (VHS)"
                ],
                "Bioquímica": [
                    "Glicemia de Jejum", "Hemoglobina Glicada (HbA1c)", "Teste Oral de Tolerância à Glicose (75g)", "Insulina Basal", "Peptídeo C", 
                    "Ureia", "Creatinina", "Ácido Úrico", "Cistatina C",
                    "Colesterol Total", "Colesterol HDL", "Colesterol LDL", "Colesterol VLDL", "Triglicerídeos", "Lipidograma Completo",
                    "Proteínas Totais e Frações", "Albumina", "Globulinas",
                    "Bilirrubinas Totais e Frações", "TGO (AST)", "TGP (ALT)", "Gama GT", "Fosfatase Alcalina", "Desidrogenase Lática (LDH)", "Amilase", "Lipase",
                    "CPK (Creatinoquinase)", "CK-MB", "Troponina I", "Troponina T", "Mioglobina", "BNP", "Pro-BNP"
                ],
                "Eletrolitos": [
                    "Sódio", "Potássio", "Cálcio Total", "Cálcio Iônico", "Magnésio", "Fósforo", "Cloro"
                ],
                "Hormônios": [
                    "TSH", "T4 Livre", "T3 Total", "T3 Livre", "Anti-TPO", "Anti-Tireoglobulina", "TRAB",
                    "LH", "FSH", "Prolactina", "Estradiol", "Progesterona", "Testosterona Total", "Testosterona Livre", "SHBG", "SDHEA", "Androstenediona",
                    "Cortisol Basal (8h)", "ACTH", "GH", "IGF-1", "PTH (Paratormônio)", "Vitamina D (25-OH)",
                    "Beta HCG (Qualitativo)", "Beta HCG (Quantitativo)"
                ],
                "Vitaminas/Minerais": [
                    "Vitamina B12", "Ácido Fólico", "Ferro Sérico", "Ferritina", "Capacidade Total de Ligação do Ferro (TIBC)", "Saturação de Transferrina", "Zinco"
                ],
                "Imunologia/Infecto": [
                    "HIV 1 e 2 (Sorologia)", "VDRL", "FTA-ABS", "HBsAg", "Anti-HBs", "Anti-HBc Total", "Anti-HBc IgM", "Anti-HCV", "Anti-HAV IgM", "Anti-HAV IgG",
                    "Sorologia Dengue (IgM/IgG)", "Dengue NS1", "Sorologia Zika", "Sorologia Chikungunya",
                    "Sorologia Toxoplasmose (IgM/IgG)", "Sorologia Rubéola (IgM/IgG)", "Sorologia Citomegalovírus (IgM/IgG)", "Epstein-Barr (Mononucleose)",
                    "Proteína C Reativa (PCR)", "Fator Reumatoide", "FAN (Fator Antinuclear)", "Anti-DNA", "Anti-CCP", "HLA-B27", "ASLO"
                ],
                "Urina e Fezes": [
                    "EAS (Urina Tipo 1)", "Urocultura com Antibiograma", "Proteinúria de 24h", "Microalbuminúria",
                    "Parasitológico de Fezes", "Sangue Oculto nas Fezes", "Coprocultura", "Pesquisa de Rotavírus"
                ]
            },
            "Imagem": {
                "Raio-X": [
                    "Raio-X de Tórax PA/Perfil", "Raio-X de Abdome Agudo", "Raio-X de Abdome Simples", "Raio-X de Seios da Face", "Raio-X de Cavum",
                    "Raio-X de Coluna Cervical", "Raio-X de Coluna Torácica", "Raio-X de Coluna Lombar", "Raio-X de Bacia", "Raio-X de Joelho", "Raio-X de Ombro", "Raio-X de Mão/Punho", "Raio-X de Pé/Tornozelo"
                ],
                "Ultrassonografia": [
                    "USG Abdome Total", "USG Abdome Superior", "USG Vias Urinárias", "USG Pélvica", "USG Transvaginal", "USG Obstétrica", "USG Tireoide", "USG Mamas", "USG Próstata",
                    "USG Doppler Venoso MMII", "USG Doppler Arterial MMII", "USG Doppler Carótidas e Vertebrais"
                ],
                "Tomografia (TC)": [
                    "Tomografia de Crânio", "Tomografia de Tórax", "Tomografia de Abdome Total", "Tomografia de Pelve", "Tomografia de Seios da Face", "Tomografia de Coluna Cervical", "Tomografia de Coluna Lombar"
                ],
                "Ressonância (RM)": [
                    "Ressonância de Crânio", "Ressonância de Coluna Cervical", "Ressonância de Coluna Lombar", "Ressonância de Joelho", "Ressonância de Ombro", "Ressonância de Abdome Superior"
                ]
            },
            "Métodos Gráficos": {
                "Cardiologia": [
                    "Eletrocardiograma (ECG)", "Ecocardiograma Transtorácico", "Teste Ergométrico", "Holter 24h", "MAPA 24h", "Cintilografia Miocárdica", "Angiotomografia de Coronárias"
                ],
                "Outros": [
                    "Endoscopia Digestiva Alta", "Colonoscopia", "Espirometria", "Audiometria", "Densitometria Óssea"
                ]
            }
        };

        /* MEDICAMENTOS (MAIS DE 100 ITENS ORGANIZADOS) */
        const RAW_MED_DATA = `
        Analgésicos/Antitérmicos|Dipirona|500mg|1 cp 6/6h se dor ou febre
        Analgésicos/Antitérmicos|Dipirona|1g|1 cp 6/6h se dor forte
        Analgésicos/Antitérmicos|Paracetamol|500mg|1 cp 6/6h se dor ou febre
        Analgésicos/Antitérmicos|Paracetamol|750mg|1 cp 6/6h se dor forte
        Analgésicos/Antitérmicos|Codeína|30mg|1 cp 8/8h se dor forte
        Analgésicos/Antitérmicos|Tramadol|50mg|1 cp 8/8h se dor intensa
        Analgésicos/Antitérmicos|Paco (Paracetamol + Codeína)|30mg/500mg|1 cp 8/8h se dor
        Anti-inflamatórios (AINEs)|Ibuprofeno|600mg|1 cp 8/8h após refeições (3-5 dias)
        Anti-inflamatórios (AINEs)|Nimesulida|100mg|1 cp 12/12h após refeições (3-5 dias)
        Anti-inflamatórios (AINEs)|Diclofenaco Sódico|50mg|1 cp 8/8h se dor
        Anti-inflamatórios (AINEs)|Cetoprofeno|100mg|1 cp 12/12h (Entérico)
        Anti-inflamatórios (AINEs)|Naproxeno|500mg|1 cp 12/12h
        Anti-inflamatórios (AINEs)|Meloxicam|15mg|1 cp ao dia
        Anti-inflamatórios (AINEs)|Celecoxibe|200mg|1 cp ao dia
        Anti-inflamatórios (AINEs)|Piroxicam|20mg|1 cp ao dia
        Antibióticos|Amoxicilina|500mg|1 cp 8/8h por 7 dias
        Antibióticos|Amoxicilina + Clavulanato|875mg|1 cp 12/12h por 10 dias
        Antibióticos|Azitromicina|500mg|1 cp ao dia por 5 dias
        Antibióticos|Ciprofloxacino|500mg|1 cp 12/12h por 7 dias
        Antibióticos|Levofloxacino|500mg|1 cp ao dia por 7 dias
        Antibióticos|Levofloxacino|750mg|1 cp ao dia por 5 dias
        Antibióticos|Cefalexina|500mg|1 cp 6/6h por 7 dias
        Antibióticos|Sulfametoxazol + Trimetoprima|400/80mg|2 cp 12/12h por 7 dias
        Antibióticos|Metronidazol|250mg|2 cp 12/12h por 7 dias
        Antibióticos|Nitrofurantoína|100mg|1 cp 6/6h por 5 dias
        Antibióticos|Doxiciclina|100mg|1 cp 12/12h por 7 dias
        Antibióticos|Clindamicina|300mg|1 cp 6/6h por 7 dias
        Antibióticos|Claritromicina|500mg|1 cp 12/12h
        Antibióticos|Cefadroxila|500mg|1 cp 12/12h
        Antibióticos|Fosfomicina|3g|1 envelope dose única
        Cardiologia (Anti-hipertensivos)|Losartana|50mg|1 cp 12/12h
        Cardiologia (Anti-hipertensivos)|Enalapril|10mg|1 cp 12/12h
        Cardiologia (Anti-hipertensivos)|Captopril|25mg|1 cp 8/8h ou SN
        Cardiologia (Anti-hipertensivos)|Anlodipino|5mg|1 cp ao dia
        Cardiologia (Anti-hipertensivos)|Atenolol|50mg|1 cp ao dia
        Cardiologia (Anti-hipertensivos)|Carvedilol|6.25mg|1 cp 12/12h
        Cardiologia (Anti-hipertensivos)|Carvedilol|12.5mg|1 cp 12/12h
        Cardiologia (Anti-hipertensivos)|Bisoprolol|5mg|1 cp ao dia
        Cardiologia (Anti-hipertensivos)|Metoprolol|50mg|1 cp 12/12h
        Cardiologia (Anti-hipertensivos)|Nebivolol|5mg|1 cp ao dia
        Cardiologia (Anti-hipertensivos)|Hidralazina|25mg|1 cp 8/8h
        Cardiologia (Anti-hipertensivos)|Clonidina|0.100mg|1 cp 12/12h
        Cardiologia (Anti-hipertensivos)|Metildopa|250mg|1 cp 8/8h
        Cardiologia (Diuréticos)|Hidroclorotiazida|25mg|1 cp pela manhã
        Cardiologia (Diuréticos)|Furosemida|40mg|1 cp pela manhã
        Cardiologia (Diuréticos)|Espironolactona|25mg|1 cp pela manhã
        Cardiologia (Diuréticos)|Indapamida|1.5mg|1 cp pela manhã
        Cardiologia (Outros)|AAS|100mg|1 cp após almoço
        Cardiologia (Outros)|Clopidogrel|75mg|1 cp após almoço
        Cardiologia (Outros)|Atorvastatina|20mg|1 cp à noite
        Cardiologia (Outros)|Sinvastatina|20mg|1 cp à noite
        Cardiologia (Outros)|Rosuvastatina|10mg|1 cp à noite
        Cardiologia (Outros)|Amiodarona|200mg|1 cp ao dia
        Cardiologia (Outros)|Digoxina|0.25mg|1/2 cp ao dia
        Cardiologia (Outros)|Isossorbida (Monocordil)|20mg|1 cp 8/8h
        Cardiologia (Outros)|Rivaroxabana|20mg|1 cp após jantar
        Cardiologia (Outros)|Apixabana|5mg|1 cp 12/12h
        Endocrinologia (Diabetes)|Metformina|850mg|1 cp 2x ao dia (almoço/jantar)
        Endocrinologia (Diabetes)|Metformina XR|500mg|2 cp no jantar
        Endocrinologia (Diabetes)|Gliclazida MR|30mg|1 cp no café
        Endocrinologia (Diabetes)|Glibenclamida|5mg|1 cp no café
        Endocrinologia (Diabetes)|Dapagliflozina|10mg|1 cp ao dia
        Endocrinologia (Diabetes)|Empagliflozina|25mg|1 cp ao dia
        Endocrinologia (Diabetes)|Vildagliptina|50mg|1 cp 12/12h
        Endocrinologia (Diabetes)|Sitagliptina|50mg|1 cp ao dia
        Endocrinologia (Tireoide)|Levotiroxina|25mcg|1 cp em jejum (30 min antes café)
        Endocrinologia (Tireoide)|Levotiroxina|50mcg|1 cp em jejum (30 min antes café)
        Endocrinologia (Tireoide)|Levotiroxina|75mcg|1 cp em jejum (30 min antes café)
        Endocrinologia (Tireoide)|Levotiroxina|88mcg|1 cp em jejum (30 min antes café)
        Endocrinologia (Tireoide)|Levotiroxina|100mcg|1 cp em jejum (30 min antes café)
        Gastroenterologia|Omeprazol|20mg|1 cp em jejum
        Gastroenterologia|Pantoprazol|40mg|1 cp em jejum
        Gastroenterologia|Esomeprazol|40mg|1 cp em jejum
        Gastroenterologia|Domperidona|10mg|1 cp 15 min antes das refeições
        Gastroenterologia|Metoclopramida|10mg|1 cp 8/8h se náusea
        Gastroenterologia|Ondansetrona|4mg|1 cp 8/8h se náusea
        Gastroenterologia|Simeticona|40mg|1 cp 6/6h
        Gastroenterologia|Albendazol|400mg|1 cp dose única
        Gastroenterologia|Annita (Nitazoxanida)|500mg|1 cp 12/12h por 3 dias
        Gastroenterologia|Ivermectina|6mg|Calcular peso (200mcg/kg)
        Psiquiatria (Antidepressivos)|Fluoxetina|20mg|1 cp pela manhã
        Psiquiatria (Antidepressivos)|Sertralina|50mg|1 cp pela manhã
        Psiquiatria (Antidepressivos)|Escitalopram|10mg|1 cp pela manhã
        Psiquiatria (Antidepressivos)|Citalopram|20mg|1 cp pela manhã
        Psiquiatria (Antidepressivos)|Paroxetina|20mg|1 cp pela manhã
        Psiquiatria (Antidepressivos)|Venlafaxina|75mg|1 cp pela manhã
        Psiquiatria (Antidepressivos)|Desvenlafaxina|50mg|1 cp pela manhã
        Psiquiatria (Antidepressivos)|Duloxetina|60mg|1 cp pela manhã
        Psiquiatria (Antidepressivos)|Amitriptilina|25mg|1 cp à noite
        Psiquiatria (Antidepressivos)|Nortriptilina|25mg|1 cp à noite
        Psiquiatria (Antidepressivos)|Mirtazapina|15mg|1 cp à noite
        Psiquiatria (Outros)|Clonazepam|0.5mg|1 cp à noite se insônia
        Psiquiatria (Outros)|Clonazepam|2mg|1 cp à noite
        Psiquiatria (Outros)|Diazepam|10mg|1 cp à noite
        Psiquiatria (Outros)|Alprazolam|0.5mg|1 cp à noite
        Psiquiatria (Outros)|Zolpidem|10mg|1 cp ao deitar
        Psiquiatria (Outros)|Quetiapina|25mg|1 cp à noite
        Psiquiatria (Outros)|Risperidona|1mg|1 cp à noite
        Psiquiatria (Outros)|Litio|300mg|1 cp 12/12h
        Psiquiatria (Outros)|Ácido Valproico|500mg|1 cp 12/12h
        Respiratório/Alergia|Loratadina|10mg|1 cp ao dia
        Respiratório/Alergia|Desloratadina|5mg|1 cp ao dia
        Respiratório/Alergia|Fexofenadina|120mg|1 cp ao dia
        Respiratório/Alergia|Dexclorfeniramina (Polaramine)|2mg|1 cp 8/8h
        Respiratório/Alergia|Prednisona|20mg|1 cp pela manhã (3 a 5 dias)
        Respiratório/Alergia|Prednisona|5mg|1 cp pela manhã
        Respiratório/Alergia|Acebrofilina|10mg/ml|10ml 12/12h
        Respiratório/Alergia|Ambroxol|30mg/5ml|5ml 8/8h
        Respiratório/Alergia|N-Acetilcisteína|600mg|1 envelope à noite
        Respiratório/Alergia|Salbutamol Spray|100mcg|2 jatos 4/4h se crise
        Respiratório/Alergia|Budesonida Spray|32mcg|2 jatos cada narina 12/12h
        Muscular/Relaxantes|Ciclobenzaprina|5mg|1 cp à noite
        Muscular/Relaxantes|Ciclobenzaprina|10mg|1 cp à noite
        Muscular/Relaxantes|Tizanidina|2mg|1 cp 8/8h se espasmo
        `;

        /* LIBRARY COMPLETA MASSIVA (200+ TOOLS) */
        const AI_LIBRARY = [
            // --- DIAGNÓSTICO & RACIOCÍNIO (PRIORIDADE 1) ---
            { id: 'second_opinion', cat: 'Diagnóstico', label: 'Segunda Opinião', icon: 'brain-circuit', color: 'indigo', prompt: 'Atue como médico sênior. Analise criticamente este caso: {soap}. Aponte inconsistências, Red Flags e sugira a melhor conduta baseada em evidências.' },
            { id: 'differential', cat: 'Diagnóstico', label: 'Diagnóstico Diferencial', icon: 'git-pull-request', color: 'indigo', prompt: 'Liste diagnósticos diferenciais prováveis para: {s} {o} {a}. Crie uma tabela com colunas: Hipótese, Probabilidade (Alta/Média/Baixa), Dados a Favor, Dados Contra.' },
            { id: 'symptom_checker', cat: 'Diagnóstico', label: 'Analisador Sintomas', icon: 'activity', color: 'indigo', prompt: 'Analise os sintomas: {s}. Agrupe em síndromes clínicas e sugira etiologias.' },
            { id: 'rare_diseases', cat: 'Diagnóstico', label: 'Doenças Raras', icon: 'search', color: 'purple', prompt: 'Pense "fora da caixa". Considere doenças raras, genéticas ou autoimunes que expliquem este quadro: {s} {o}.' },
            { id: 'red_flags', cat: 'Diagnóstico', label: 'Red Flags (Alerta)', icon: 'flag', color: 'red', prompt: 'Identifique IMEDIATAMENTE sinais de alerta (Red Flags) neste caso: {soap}. Existe risco de vida iminente? Ref: Medicina de Emergência.' },
            { id: 'anamnesis_gap', cat: 'Diagnóstico', label: 'O que faltou?', icon: 'help-circle', color: 'slate', prompt: 'O que esqueci de perguntar ou examinar? Liste perguntas cruciais faltando em: {s} para fechar o diagnóstico.' },
            { id: 'lab_interpret', cat: 'Diagnóstico', label: 'Interpretar Labs', icon: 'test-tube', color: 'teal', prompt: 'Analise os exames laboratoriais em anexo ou descritos em {o}. Identifique alterações e correlacione com a clínica. Gere tabela.' },

            // --- CARDIOLOGIA ---
            { id: 'ecg_interpret', cat: 'Cardiologia', label: 'Laudo de ECG', icon: 'activity', color: 'red', prompt: 'Analise este ECG (imagem ou descrição). Siga o roteiro: 1. Frequência/Ritmo. 2. Eixo. 3. Sobrecargas. 4. Isquemia/Infarto. 5. Bloqueios. 6. Conclusão.' },
            { id: 'cardio_risk', cat: 'Cardiologia', label: 'Risco CV (Framingham)', icon: 'heart', color: 'red', prompt: 'Estime o risco cardiovascular (10 anos) inferindo dados de {s} {o}.' },
            { id: 'has_guideline', cat: 'Cardiologia', label: 'Diretriz HAS 2020', icon: 'book', color: 'blue', prompt: 'Resuma o manejo da hipertensão para este paciente específico segundo a Diretriz Brasileira 2020.' },
            { id: 'cha2ds2', cat: 'Cardiologia', label: 'CHA2DS2-VASc', icon: 'calculator', color: 'blue', prompt: 'Calcule CHA2DS2-VASc baseado em {s} {o}. Indique necessidade de anticoagulação.' },
            { id: 'lipid_targets', cat: 'Cardiologia', label: 'Alvos LDL (SBC)', icon: 'target', color: 'orange', prompt: 'Com base no risco CV do paciente ({s} {o}), qual o alvo de LDL segundo diretriz SBC? Sugira estatina.' },
            { id: 'hf_meds', cat: 'Cardiologia', label: 'ICFER (4 Pilares)', icon: 'layers', color: 'green', prompt: 'Verifique se o paciente com ICFER ({s} {o}) está usando os 4 pilares (IECA/BRA/ARNI, BB, ARM, iSGLT2). Sugira otimização.' },
            { id: 'chest_pain_score', cat: 'Cardiologia', label: 'Score HEART', icon: 'clipboard', color: 'red', prompt: 'Calcule Score HEART para dor torácica descrita em {s}.' },
            { id: 'grace_score', cat: 'Cardiologia', label: 'Score GRACE', icon: 'bar-chart', color: 'red', prompt: 'Estime Score GRACE para SCA descrita em {s}. Mortalidade intra-hospitalar?' },
            { id: 'timi_stemi', cat: 'Cardiologia', label: 'TIMI (IAMCSST)', icon: 'alert-circle', color: 'red', prompt: 'Calcule Score TIMI para IAM com Supra ({s} {o}).' },
            { id: 'timi_nstemi', cat: 'Cardiologia', label: 'TIMI (IAMSSST)', icon: 'alert-triangle', color: 'orange', prompt: 'Calcule Score TIMI para Angina Instável/IAMSSST ({s} {o}).' },
            { id: 'killip_class', cat: 'Cardiologia', label: 'Classificação Killip', icon: 'heart', color: 'purple', prompt: 'Classifique Killip-Kimball baseado no exame físico pulmonar em {o}.' },
            { id: 'nyha_class', cat: 'Cardiologia', label: 'Classe NYHA', icon: 'activity', color: 'blue', prompt: 'Classifique a insuficiência cardíaca (I-IV) baseada na tolerância ao esforço em {s}.' },
            { id: 'has_bled', cat: 'Cardiologia', label: 'Score HAS-BLED', icon: 'droplet', color: 'red', prompt: 'Calcule risco de sangramento em anticoagulação (HAS-BLED) para este paciente.' },
            { id: 'qt_interval', cat: 'Cardiologia', label: 'QT Corrigido', icon: 'activity', color: 'yellow', prompt: 'Calcule QTc (Bazett) com base na FC e QT descritos em {o}.' },
            
            // --- EMERGÊNCIA ---
            { id: 'sepsis_protocol', cat: 'Emergência', label: 'Protocolo Sepse', icon: 'alert-triangle', color: 'orange', prompt: 'Gere o Checklist da Hora de Ouro da Sepse para este caso: {s} {o}. qSOFA e conduta.' },
            { id: 'acls_guide', cat: 'Emergência', label: 'Protocolo ACLS', icon: 'zap', color: 'red', prompt: 'Resuma a conduta ACLS para o cenário descrito: {s}.' },
            { id: 'stroke_protocol', cat: 'Emergência', label: 'Protocolo AVC', icon: 'brain', color: 'purple', prompt: 'Crie checklist para AVC agudo (NIHSS, critérios trombólise) para: {s}.' },
            { id: 'anaphylaxis', cat: 'Emergência', label: 'Anafilaxia', icon: 'wind', color: 'red', prompt: 'Detalhe manejo imediato de anafilaxia (Adrenalina IM, dose) para este caso.' },
            { id: 'poisoning', cat: 'Emergência', label: 'Intoxicação', icon: 'skull', color: 'slate', prompt: 'Sugira antídotos e manejo para intoxicação descrita em: {s}.' },
            { id: 'burn_parkland', cat: 'Emergência', label: 'Queimados (Parkland)', icon: 'flame', color: 'orange', prompt: 'Calcule reposição volêmica (Fórmula de Parkland) para queimadura descrita em {o}.' },
            { id: 'qsofa', cat: 'Emergência', label: 'qSOFA', icon: 'alert-circle', color: 'orange', prompt: 'Calcule qSOFA (FR, Glasgow, PAS) com base em {s} {o}.' },
            { id: 'glasgow_scale', cat: 'Emergência', label: 'Escala de Glasgow', icon: 'eye', color: 'green', prompt: 'Calcule o Glasgow com base em {o}. Detalhe Ocular, Verbal e Motor.' },
            { id: 'news2', cat: 'Emergência', label: 'NEWS-2 Score', icon: 'monitor', color: 'blue', prompt: 'Calcule NEWS-2 com base nos sinais vitais em {o}.' },
            { id: 'sofa_score', cat: 'Emergência', label: 'SOFA Score', icon: 'bar-chart-2', color: 'red', prompt: 'Calcule SOFA Score (Resp, Coag, Liver, Cardio, CNS, Renal) com base em {o}.' },
            { id: 'hypertensive_emergency', cat: 'Emergência', label: 'Emergência Hipertensiva', icon: 'arrow-up', color: 'red', prompt: 'Manejo de crise hipertensiva ({o}). Urgência ou Emergência? Drogas EV indicadas.' },
            { id: 'status_epilepticus', cat: 'Emergência', label: 'Estado Mal Epiléptico', icon: 'zap-off', color: 'purple', prompt: 'Protocolo de sedação e anticonvulsivantes para Status Epilepticus.' },

             // --- NEFROLOGIA ---
            { id: 'gfr_calc', cat: 'Nefrologia', label: 'TFG (CKD-EPI)', icon: 'droplet', color: 'yellow', prompt: 'Identifique Creatinina em {o} e estime TFG (CKD-EPI). Classifique estágio DRC.' },
            { id: 'hyponatremia_correction', cat: 'Nefrologia', label: 'Corrigir Hiponatremia', icon: 'activity', color: 'blue', prompt: 'Calcule déficit de sódio e velocidade de reposição para hiponatremia em {o}.' },
            { id: 'hyperkalemia_management', cat: 'Nefrologia', label: 'Manejo Hipercalemia', icon: 'alert-octagon', color: 'red', prompt: 'Sugira conduta escalonada para Potássio alto ({o}): Gluconato, Glicoinsulina, Sorcal.' },
            { id: 'acid_base', cat: 'Nefrologia', label: 'Gasometria Arterial', icon: 'file-text', color: 'gray', prompt: 'Interprete gasometria em {o}. Distúrbio misto? Anion Gap?' },
            { id: 'aki_staging', cat: 'Nefrologia', label: 'Estágio IRA (KDIGO)', icon: 'bar-chart', color: 'orange', prompt: 'Classifique Injúria Renal Aguda (KDIGO) baseada na creatinina/diurese.' },
            { id: 'fena_calc', cat: 'Nefrologia', label: 'FeNa (Fração Excreção)', icon: 'percent', color: 'blue', prompt: 'Calcule FeNa com dados de {o}. Sugere pré-renal ou NTA?' },

            // --- ENDOCRINOLOGIA ---
            { id: 'dk_protocol', cat: 'Endocrinologia', label: 'Cetoacidose (CAD)', icon: 'alert-triangle', color: 'red', prompt: 'Protocolo de manejo de Cetoacidose Diabética (ADA) para: {o}. Hidratação, Insulina, K+.' },
            { id: 'insulin_sliding', cat: 'Endocrinologia', label: 'Escala de Insulina', icon: 'syringe', color: 'blue', prompt: 'Sugira esquema de insulina regular (sliding scale) para paciente internado.' },
            { id: 'thyroid_nodule', cat: 'Endocrinologia', label: 'Nódulo Tireoide (TI-RADS)', icon: 'circle', color: 'purple', prompt: 'Classifique nódulo tireoidiano em {o} (TI-RADS) e sugira PAAF se indicado.' },
            { id: 'osteoporosis', cat: 'Endocrinologia', label: 'Osteoporose', icon: 'bone', color: 'slate', prompt: 'Sugira tratamento para osteoporose baseada em Densitometria em {o}.' },
            { id: 'hba1c_target', cat: 'Endocrinologia', label: 'Alvo HbA1c', icon: 'target', color: 'green', prompt: 'Qual o alvo de HbA1c para este paciente ({s})? Idoso? Comorbidades?' },
            { id: 'adrenal_insufficiency', cat: 'Endocrinologia', label: 'Insuficiência Adrenal', icon: 'triangle', color: 'orange', prompt: 'Suspeita de crise adrenal em {s}? Protocolo de reposição.' },
            { id: 'hypercalcemia', cat: 'Endocrinologia', label: 'Hipercalcemia', icon: 'droplet', color: 'yellow', prompt: 'Manejo agudo de hipercalcemia descrita em {o}.' },

            // --- GASTROENTEROLOGIA ---
            { id: 'child_pugh', cat: 'Gastroenterologia', label: 'Child-Pugh', icon: 'activity', color: 'yellow', prompt: 'Calcule Child-Pugh para cirrose com base em {o}.' },
            { id: 'meld_calc', cat: 'Gastroenterologia', label: 'MELD Score', icon: 'calculator', color: 'orange', prompt: 'Calcule MELD (Bili, INR, Cr) com base em {o}.' },
            { id: 'upper_gi_bleed', cat: 'Gastroenterologia', label: 'HDA (Glasgow-Blatchford)', icon: 'droplet', color: 'red', prompt: 'Escore de Glasgow-Blatchford para HDA em {s}. Precisa de EDA urgente?' },
            { id: 'h_pylori', cat: 'Gastroenterologia', label: 'Erradicação H. pylori', icon: 'bug', color: 'green', prompt: 'Esquema de antibióticos para H. pylori (1ª linha Brasil) se confirmado.' },
            { id: 'pancreatitis_ranson', cat: 'Gastroenterologia', label: 'Ranson/Apache', icon: 'activity', color: 'purple', prompt: 'Critérios de gravidade para pancreatite aguda ({o}).' },
            { id: 'rome_iv', cat: 'Gastroenterologia', label: 'Critérios Roma IV', icon: 'book', color: 'blue', prompt: 'O paciente preenche critérios de Roma IV para SII ou Dispepsia?' },
            { id: 'uc_mayo', cat: 'Gastroenterologia', label: 'Score Mayo (RCU)', icon: 'activity', color: 'purple', prompt: 'Classifique atividade da RCU (Mayo Score) baseada em {s}.' },

            // --- PNEUMOLOGIA ---
            { id: 'copd_gold', cat: 'Pneumologia', label: 'DPOC (GOLD)', icon: 'wind', color: 'slate', prompt: 'Classifique DPOC (GOLD A-D) baseado em sintomas {s} e espirometria {o}.' },
            { id: 'asthma_gina', cat: 'Pneumologia', label: 'Asma (GINA)', icon: 'feather', color: 'blue', prompt: 'Classifique controle da asma (GINA) e ajuste de etapa (step) baseado em {s}.' },
            { id: 'pneumonia_psi', cat: 'Pneumologia', label: 'Pneumonia (CURB-65/PSI)', icon: 'wind', color: 'red', prompt: 'Calcule CURB-65 e PSI para pneumonia em {s} {o}. Internar?' },
            { id: 'pe_wells', cat: 'Pneumologia', label: 'TEP (Wells)', icon: 'alert-circle', color: 'red', prompt: 'Probabilidade pré-teste de TEP (Score de Wells) em {s}. Pedir D-Dímero ou TC?' },
            { id: 'pleural_light', cat: 'Pneumologia', label: 'Critérios de Light', icon: 'droplet', color: 'yellow', prompt: 'Derrame pleural ({o}): Exsudato ou Transudato?' },
            { id: 'perc_rule', cat: 'Pneumologia', label: 'Regra PERC (TEP)', icon: 'check-circle', color: 'green', prompt: 'Aplique regra PERC para excluir TEP em paciente de baixo risco.' },

            // --- NEUROLOGIA ---
            { id: 'stroke_nihss', cat: 'Neurologia', label: 'NIHSS Estimado', icon: 'calculator', color: 'purple', prompt: 'Estime a pontuação NIHSS baseada na descrição neurológica em {o}.' },
            { id: 'vertigo_hints', cat: 'Neurologia', label: 'Protocolo HINTS', icon: 'rotate-cw', color: 'blue', prompt: 'Interprete exame HINTS para vertigem aguda descrita em {s}. Central ou periférica?' },
            { id: 'headache_redflags', cat: 'Neurologia', label: 'Cefaleia (SNOOP4)', icon: 'flag', color: 'red', prompt: 'Busque sinais de alarme (SNOOP4) para cefaleia em {s}. Precisa de imagem?' },
            { id: 'delirium_cam', cat: 'Neurologia', label: 'Delirium (CAM)', icon: 'alert-circle', color: 'orange', prompt: 'Aplique critérios CAM para Delirium baseado no comportamento descrito.' },
            { id: 'dementia_screen', cat: 'Neurologia', label: 'Rastreio Demência', icon: 'brain', color: 'slate', prompt: 'Sugira mini-mental ou MoCA para queixa de memória em {s}.' },
            { id: 'abcd2_tia', cat: 'Neurologia', label: 'ABCD2 (AIT)', icon: 'alert-triangle', color: 'orange', prompt: 'Risco de AVC após AIT (Score ABCD2) baseado em {s} {o}.' },

            // --- INFECTOLOGIA ---
            { id: 'endocarditis_duke', cat: 'Infectologia', label: 'Endocardite (Duke)', icon: 'heart', color: 'red', prompt: 'Aplique critérios de Duke modificados para suspeita de endocardite em {s} {o}.' },
            { id: 'meningitis_sf', cat: 'Infectologia', label: 'Líquor (Meningite)', icon: 'test-tube', color: 'yellow', prompt: 'Interprete o líquor em {o}. Bacteriano, Viral, TB ou Fúngico?' },
            { id: 'uti_treatment', cat: 'Infectologia', label: 'ITU Manejo', icon: 'activity', color: 'blue', prompt: 'ITU em {s}. É complicada? Qual antibiótico empírico adequado?' },
            { id: 'arbovirus', cat: 'Infectologia', label: 'Dengue/Zika/Chik', icon: 'bug', color: 'green', prompt: 'Diferencie Dengue, Zika e Chikungunya baseado nos sintomas de {s}.' },
            { id: 'hiv_oi', cat: 'Infectologia', label: 'Infecções Oportunistas', icon: 'shield-off', color: 'purple', prompt: 'CD4 em {o}. Quais profilaxias iniciar? Suspeita de qual IO?' },
            { id: 'sir_criteria', cat: 'Infectologia', label: 'Critérios SIRS', icon: 'thermometer', color: 'orange', prompt: 'Verifique critérios de SIRS com os dados vitais em {o}.' },

            // --- PEDIATRIA ---
            { id: 'pediatric_dose', cat: 'Pediatria', label: 'Dose Pediátrica', icon: 'baby', color: 'pink', prompt: 'Calcule a dose exata de {meds} (ou sugira medicação comum) para o peso/idade da criança inferido em {s}.' },
            { id: 'hydration_peds', cat: 'Pediatria', label: 'Hidratação (Holliday)', icon: 'droplet', color: 'blue', prompt: 'Calcule regra de Holliday-Segar e soro de expansão para criança em {s}.' },
            { id: 'centor_score', cat: 'Pediatria', label: 'Score Centor', icon: 'thermometer', color: 'orange', prompt: 'Probabilidade de faringite estreptocócica (Centor) em {s}. Teste rápido?' },
            { id: 'milestones', cat: 'Pediatria', label: 'Marcos Desenvolvimento', icon: 'star', color: 'yellow', prompt: 'Verifique marcos do desenvolvimento para a idade citada em {s}.' },
            { id: 'vaccine_check', cat: 'Pediatria', label: 'Checagem Vacinal', icon: 'syringe', color: 'blue', prompt: 'Quais vacinas do PNI (Brasil) deveriam ter sido tomadas até a idade do paciente?' },
            { id: 'kawasaki_criteria', cat: 'Pediatria', label: 'Kawasaki', icon: 'heart', color: 'red', prompt: 'Critérios para Doença de Kawasaki em febre prolongada descrita em {s}.' },
            { id: 'apgar_score', cat: 'Pediatria', label: 'APGAR', icon: 'activity', color: 'green', prompt: 'Calcule APGAR baseado na descrição do RN em {s}.' },

            // --- GINECO/OBSTETRÍCIA ---
            { id: 'gestational_age', cat: 'Gineco/Obs', label: 'Idade Gestacional', icon: 'calendar', color: 'pink', prompt: 'Estime IG e DPP se houver DUM em {s}.' },
            { id: 'preeclampsia_risk', cat: 'Gineco/Obs', label: 'Risco Pré-Eclâmpsia', icon: 'alert-triangle', color: 'red', prompt: 'Avalie fatores de risco para pré-eclâmpsia em {s}.' },
            { id: 'std_cdc', cat: 'Gineco/Obs', label: 'Tratamento IST', icon: 'shield', color: 'purple', prompt: 'Protocolo atualizado Brasil (MS) para tratamento de IST suspeita em {s}.' },
            { id: 'pop_methods', cat: 'Gineco/Obs', label: 'Elegibilidade (MEC)', icon: 'circle', color: 'pink', prompt: 'Verifique critérios de elegibilidade OMS (MEC) para anticoncepcionais.' },
            { id: 'abx_pregnancy', cat: 'Gineco/Obs', label: 'Antibiótico na Gestação', icon: 'bug', color: 'green', prompt: 'Segurança de antibióticos para infecção descrita em {s} durante a gravidez.' },
            { id: 'bishop_score', cat: 'Gineco/Obs', label: 'Índice de Bishop', icon: 'activity', color: 'purple', prompt: 'Calcule índice de Bishop baseado no toque vaginal em {o}.' },

            // --- SAÚDE MENTAL ---
            { id: 'mse_format', cat: 'Saúde Mental', label: 'Súmula Psíquica', icon: 'brain', color: 'purple', prompt: 'Organize o exame mental (Súmula) baseado em: {o}.' },
            { id: 'suicide_risk', cat: 'Saúde Mental', label: 'Risco Suicídio', icon: 'life-buoy', color: 'red', prompt: 'Avalie risco de autoextermínio em {s}. Estratifique e sugira conduta.' },
            { id: 'dsm5_check', cat: 'Saúde Mental', label: 'Critérios DSM-5', icon: 'book-open', color: 'purple', prompt: 'Verifique se {s} preenche critérios DSM-5 para transtornos prováveis.' },
            { id: 'ciwa_ar', cat: 'Saúde Mental', label: 'Abstinência Álcool (CIWA)', icon: 'wine-off', color: 'red', prompt: 'Estime score CIWA-Ar para abstinência alcoólica em {s}. Protocolo de diazepam?' },
            { id: 'psych_agitation', cat: 'Saúde Mental', label: 'Agitação Psicomotora', icon: 'zap', color: 'orange', prompt: 'Protocolo de contenção medicamentosa para agitação descrita em {s}.' },
            { id: 'phq9_gad7', cat: 'Saúde Mental', label: 'PHQ-9 / GAD-7', icon: 'check-square', color: 'blue', prompt: 'Sugira aplicação de PHQ-9 (Depressão) e GAD-7 (Ansiedade).' },

             // --- REUMATOLOGIA ---
            { id: 'sle_criteria', cat: 'Reumatologia', label: 'Critérios Lúpus (EULAR)', icon: 'flower-2', color: 'purple', prompt: 'Verifique critérios EULAR/ACR 2019 para LES baseados em {s} {o}.' },
            { id: 'ra_criteria', cat: 'Reumatologia', label: 'Artrite Reumatoide', icon: 'hand', color: 'orange', prompt: 'Critérios ACR/EULAR para AR. Score baseado em articulações e sorologia.' },
            { id: 'gout_management', cat: 'Reumatologia', label: 'Crise de Gota', icon: 'footprints', color: 'red', prompt: 'Manejo de crise aguda de gota descrita em {s}.' },
            { id: 'fibro_criteria', cat: 'Reumatologia', label: 'Fibromialgia', icon: 'user', color: 'pink', prompt: 'Critérios diagnósticos de Fibromialgia (ACR) para as dores descritas em {s}.' },

            // --- DOCUMENTOS ---
            { id: 'referral', cat: 'Documentos', label: 'Encaminhamento', icon: 'send', color: 'slate', prompt: 'Redija uma carta de encaminhamento formal e técnica para especialista baseada em {soap}.' },
            { id: 'medical_certificate', cat: 'Documentos', label: 'Atestado (Texto)', icon: 'file-badge', color: 'slate', prompt: 'Gere o texto técnico para atestado médico justificando afastamento baseado no CID provável de {a}.' },
            { id: 'laudo', cat: 'Documentos', label: 'Laudo Médico', icon: 'file-text', color: 'slate', prompt: 'Redija laudo médico formal descrevendo condição atual e CID para fins previdenciários: {soap}.' },
            { id: 'insurance_justification', cat: 'Documentos', label: 'Justificativa Convênio', icon: 'shield', color: 'green', prompt: 'Escreva justificativa técnica para solicitar exames/procedimentos listados no plano baseando-se em {a}.' },
            { id: 'travel_letter', cat: 'Documentos', label: 'Carta para Viagem', icon: 'plane', color: 'sky', prompt: 'Redija carta (PT/EN) atestando uso de medicamentos controlados para viagem aérea.' },
            { id: 'fitness_gym', cat: 'Documentos', label: 'Atestado Academia', icon: 'dumbbell', color: 'emerald', prompt: 'Texto para atestado de aptidão física considerando {s} {o}.' },
            
            // --- TERAPÊUTICA ---
            { id: 'interactions', cat: 'Terapêutica', label: 'Interações', icon: 'shuffle', color: 'red', prompt: 'Analise interações medicamentosas perigosas na prescrição: {meds}.' },
            { id: 'antibiotic_choice', cat: 'Terapêutica', label: 'Escolha ATB', icon: 'bug', color: 'emerald', prompt: 'Sugira antibiótico empírico racional para a infecção suspeita em {a}, considerando perfil Brasil.' },
            { id: 'renal_adjust', cat: 'Terapêutica', label: 'Ajuste Renal', icon: 'activity', color: 'blue', prompt: 'Para os remédios {meds}, sugira ajustes para ClCr estimado.' },
            { id: 'pregnancy_risk', cat: 'Terapêutica', label: 'Risco Gravidez', icon: 'baby', color: 'pink', prompt: 'Classifique o risco (FDA/Anvisa) dos medicamentos {meds} na gestação.' },
            { id: 'breastfeeding', cat: 'Terapêutica', label: 'Lactação', icon: 'baby', color: 'pink', prompt: 'Segurança na amamentação para: {meds}.' },
            { id: 'deprescribing', cat: 'Terapêutica', label: 'Desprescrição', icon: 'trash-2', color: 'green', prompt: 'Sugira estratégia de desmame/retirada para: {meds} em idoso.' },
            
            // --- ENFERMAGEM ---
            { id: 'braden_scale', cat: 'Enfermagem', label: 'Escala de Braden', icon: 'layers', color: 'orange', prompt: 'Estime risco de lesão por pressão (Braden) com base em {s}.' },
            { id: 'iv_dilution', cat: 'Enfermagem', label: 'Diluição Meds', icon: 'droplet', color: 'blue', prompt: 'Orientações de diluição e tempo de infusão para os medicamentos EV em {meds}.' },
            { id: 'morse_fall', cat: 'Enfermagem', label: 'Escala de Morse', icon: 'arrow-down-right', color: 'red', prompt: 'Risco de queda (Morse) para paciente internado.' },
            
            // --- HEMATOLOGIA ---
            { id: 'anemia_diff', cat: 'Hematologia', label: 'Investigação Anemia', icon: 'droplet', color: 'red', prompt: 'Classifique a anemia em {o} (VCM, HCM). Ferropriva? Megaloblástica? Doença crônica?' },
            { id: 'coagulation_screen', cat: 'Hematologia', label: 'Coagulograma', icon: 'clock', color: 'blue', prompt: 'Interprete TP/TTPA em {o}. Via intrínseca ou extrínseca? Deficiência de fatores?' },
            { id: 'transfusion_guide', cat: 'Hematologia', label: 'Guia Transfusão', icon: 'beaker', color: 'red', prompt: 'Indicação de transfusão para Hb/Plaquetas em {o}. Gatilhos recomendados.' },

            // --- ONCOLOGIA & PALIATIVOS ---
            { id: 'tnm_staging', cat: 'Oncologia', label: 'Estadiamento (TNM)', icon: 'layers', color: 'slate', prompt: 'Tente estimar TNM genérico baseado no laudo de imagem em {o} ou biópsia.' },
            { id: 'palliative_care', cat: 'Paliativos', label: 'Manejo de Sintomas', icon: 'sunset', color: 'orange', prompt: 'Sugira receitas de conforto para sintomas (dor, dispneia, náusea) descritos em {s}.' },
            { id: 'opioid_conversion', cat: 'Paliativos', label: 'Conversão Opioide', icon: 'repeat', color: 'green', prompt: 'Conversão de dose de opioide ({meds}) para morfina oral equivalente ou rotação.' },
            { id: 'chemo_tox', cat: 'Oncologia', label: 'Toxicidade Quimio', icon: 'alert-octagon', color: 'red', prompt: 'Manejo de efeitos colaterais descritos em {s} relacionados à quimioterapia.' },

            // --- ORTOPEDIA ---
            { id: 'ottawa_rules', cat: 'Ortopedia', label: 'Regras de Ottawa', icon: 'bone', color: 'slate', prompt: 'Aplique Regras de Ottawa para tornozelo/joelho baseadas na história {s} e exame {o}. Precisa de Raio-X?' },
            { id: 'back_pain_flags', cat: 'Ortopedia', label: 'Red Flags Lombalgia', icon: 'flag', color: 'red', prompt: 'Busque sinais de alarme em lombalgia (Cauda Equina, Câncer, Infecção) em {s}.' },
            { id: 'canadian_cspine', cat: 'Ortopedia', label: 'Canadian C-Spine', icon: 'activity', color: 'orange', prompt: 'Regra Canadian C-Spine para trauma cervical em {s}. Imagem necessária?' },

            // --- GERIATRIA ---
            { id: 'beers_criteria', cat: 'Geriatria', label: 'Critérios de Beers', icon: 'pill', color: 'red', prompt: 'Identifique medicamentos potencialmente inapropriados para idosos (Beers) na lista {meds}.' },
            { id: 'frailty_score', cat: 'Geriatria', label: 'Escala de Fragilidade', icon: 'user', color: 'gray', prompt: 'Estime fragilidade (Fried/CFS) baseada na descrição funcional em {s}.' },
            { id: 'fall_risk', cat: 'Geriatria', label: 'Risco de Queda', icon: 'arrow-down-right', color: 'orange', prompt: 'Avalie risco de quedas (medicações, comorbidades) em {s}.' },

            // --- NUTRIÇÃO ---
            { id: 'caloric_needs', cat: 'Nutrição', label: 'Necessidade Calórica', icon: 'calculator', color: 'green', prompt: 'Estime Taxa Metabólica Basal e necessidade calórica (Harris-Benedict) para o paciente {s}.' },
            { id: 'diet_advice', cat: 'Nutrição', label: 'Dieta Específica', icon: 'carrot', color: 'green', prompt: 'Monte orientações dietéticas focadas na patologia principal de {a}.' },
            { id: 'enteral_nutrition', cat: 'Nutrição', label: 'Nutrição Enteral', icon: 'test-tube', color: 'blue', prompt: 'Sugira fórmula e vazão de dieta enteral para paciente {s}.' },

            // --- TOXICOLOGIA ---
            { id: 'snake_bite', cat: 'Toxicologia', label: 'Acidente Ofídico', icon: 'alert-triangle', color: 'green', prompt: 'Classifique acidente ofídico (Botrópico, Crotálico...) baseado em {s} {o} e sugira soro.' },
            { id: 'paracetamol_tox', cat: 'Toxicologia', label: 'Intoxicação Paracetamol', icon: 'skull', color: 'red', prompt: 'Protocolo de N-Acetilcisteína (Rumack-Matthew) para ingestão de paracetamol em {s}.' },

            // --- DERMATOLOGIA ---
            { id: 'dermatology', cat: 'Dermatologia', label: 'Análise de Lesão', icon: 'scan-eye', color: 'pink', prompt: 'Descreva tecnicamente as lesões relatadas em {s} {o}. Aplique regra ABCDE se aplicável. Sugira diagnósticos.' },
            
            // --- CIRURGIA ---
            { id: 'pre_op_eval', cat: 'Cirurgia', label: 'Risco Cirúrgico', icon: 'clipboard-check', color: 'blue', prompt: 'Avaliação pré-operatória (ACP/Goldman) baseada em {s} {o}.' },
            { id: 'post_op', cat: 'Cirurgia', label: 'Cuidados Pós-Op', icon: 'bandage', color: 'slate', prompt: 'Gere orientações de cuidados em casa para pós-operatório de: {a}.' }
        ];

        const app = (function() {
            
            // Inicialização do Estado
            function loadState() {
                const defaultLines = Array(15).fill(""); 
                return {
                    meds: JSON.parse(localStorage.getItem('neuro_meds')) || loadInitialMeds(),
                    config: JSON.parse(localStorage.getItem('neuro_config')) || { name: 'Dr. Médico', specialty: 'Clínica Geral', crm: '00000', phone: '(00) 0000-0000', logoUrl: '', apiKey: '' },
                    patients: JSON.parse(localStorage.getItem('neuro_patients')) || [],
                    currentPatient: { 
                        id: null, 
                        name: '', 
                        soap: { s: '', o: '', a: '', p: '' }, 
                        attachments: [] 
                    },
                    prescription: [],
                    hospitalLines: ["DIETA ZERO", "SORO FISIOLÓGICO 0,9% 1000ML EV 8/8H", "DIPIRONA 1G EV 6/6H SE DOR", "METOCLOPRAMIDA 10MG EV 8/8H SE NÁUSEA", "", "", "", "", "", "", "", "", "", "", ""],
                    examRequest: [],
                    activeDocument: 'prescription',
                    sidebarOpen: true
                };
            }

            function loadInitialMeds() {
                const lines = RAW_MED_DATA.split('\n').map(l => l.trim()).filter(l => l);
                return lines.map((l, i) => {
                    const p = l.split('|');
                    return { id: i, category: p[0], name: p[1], dose: p[2], instruction: p[3] };
                });
            }

            let state = loadState();

            // --- CORE FUNCTIONS ---
            
            function init() {
                lucide.createIcons();
                loadTheme();
                renderMeds();
                renderExams();
                renderAITools();
                updateConfigUI();
                if(window.innerWidth >= 1024) switchTab('patient');
                updateDocumentView();
            }

            // --- UI HELPERS ---
            function toggleTheme() { document.documentElement.classList.toggle('dark'); localStorage.setItem('neuro_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); }
            function loadTheme() { if(localStorage.getItem('neuro_theme') === 'dark') document.documentElement.classList.add('dark'); }
            function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
            function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
            function switchTab(tabId) {
                // Close mobile document view if open
                document.getElementById('documentPanel').classList.add('hidden', 'lg:flex');
                document.getElementById('documentPanel').classList.remove('fixed', 'inset-0', 'z-50', 'flex', 'bg-slate-100');

                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.getElementById(`tabContent-${tabId}`)?.classList.add('active');
                
                // Desktop Tabs
                document.querySelectorAll('.tab-button span').forEach(s => s.classList.remove('scale-x-100'));
                document.querySelector(`#tabButton-${tabId} span`)?.classList.add('scale-x-100');
                
                // Mobile Tabs
                document.querySelectorAll('.bottom-nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById(`mb-nav-${tabId}`)?.classList.add('active');

                if(tabId === 'exams') setDocumentMode('exams');
                else if(tabId === 'pharmacy') setDocumentMode('prescription');
            }

            function toggleMobileDoc() {
                const panel = document.getElementById('documentPanel');
                const isHidden = panel.classList.contains('hidden');
                
                // Reset active tab state for visual feedback
                document.querySelectorAll('.bottom-nav-item').forEach(el => el.classList.remove('active'));
                
                if(isHidden) {
                    panel.classList.remove('hidden');
                    panel.classList.add('fixed', 'inset-0', 'z-50', 'flex', 'bg-slate-100', 'dark:bg-slate-900');
                    document.getElementById('mb-nav-doc').classList.add('active');
                } else {
                    panel.classList.add('hidden');
                    panel.classList.remove('fixed', 'inset-0', 'z-50', 'flex', 'bg-slate-100', 'dark:bg-slate-900');
                    // Re-highlight active tab
                    const activeTabId = document.querySelector('.tab-content.active').id.replace('tabContent-', '');
                    document.getElementById(`mb-nav-${activeTabId}`)?.classList.add('active');
                }
            }

            function setDocumentMode(mode) {
                state.activeDocument = mode;
                const map = { 'prescription': 'docMode-prescription', 'exams': 'docMode-exams', 'hospital': 'docMode-hospital' };
                Object.values(map).forEach(id => document.getElementById(id).classList.replace('active', 'inactive'));
                document.getElementById(map[mode]).classList.replace('inactive', 'active');
                updateDocumentView();
            }

            function toggleSidebar() {
                state.sidebarOpen = !state.sidebarOpen;
                const el = document.getElementById('leftPanelContainer');
                if(state.sidebarOpen) { el.style.marginLeft = "0"; el.classList.remove('w-0', 'opacity-0'); el.classList.add('p-4'); }
                else { el.style.marginLeft = "-100%"; el.classList.add('w-0', 'opacity-0', 'p-0'); el.classList.remove('p-4'); }
                if(state.sidebarOpen) el.style.display = 'block'; else el.style.display = 'none';
            }

            // --- PRESCRIÇÃO ---
            function updateHospitalLine(index, value) { state.hospitalLines[index] = value.toUpperCase(); }
            function removeHospitalLine(index) { state.hospitalLines.splice(index, 1); updateDocumentView(); }
            function addHospitalLine() { state.hospitalLines.push(""); updateDocumentView(); }

            // --- MAGIC SOAP ---
            function openMagicSoap() { openModal('magicSoapModal'); }
            async function generateMagicSoap() {
                if(!state.config.apiKey) { alert("Configure sua API Key nas configurações!"); openModal('configModal'); return; }
                const txt = document.getElementById('magicSoapInput').value;
                const audioFile = document.getElementById('magicSoapAudio').files[0];
                const imageFile = document.getElementById('magicSoapImage').files[0];
                if(!txt && !audioFile && !imageFile) return alert("Forneça texto, áudio ou imagem.");

                const btn = document.querySelector('#magicSoapModal button[onclick="app.generateMagicSoap()"]');
                const oldHtml = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Processando...';
                btn.disabled = true; lucide.createIcons();

                let parts = [{ text: "Você é um assistente médico especialista. Sua tarefa é extrair informações clínicas de um texto, áudio transcrito ou imagem (incluindo manuscritos/anotações à mão). Se uma imagem for fornecida, realize a leitura (OCR) do manuscrito ou texto datilografado e utilize o conteúdo para preencher o SOAP. Estruture a resposta EXATAMENTE no formato JSON com as chaves: 's' (Subjetivo), 'o' (Objetivo), 'a' (Avaliação), 'p' (Plano). Use terminologia médica formal em PT-BR. Se faltar dado para algum campo, deixe como string vazia. " + (txt ? `\nTexto de apoio: ${txt}` : "") }];
                
                const fileToBase64 = (file) => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                });

                try {
                    if (audioFile) parts.push({ inlineData: { mimeType: audioFile.type, data: await fileToBase64(audioFile) } });
                    if (imageFile) parts.push({ inlineData: { mimeType: imageFile.type, data: await fileToBase64(imageFile) } });

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.config.apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: parts }] })
                    });
                    const data = await response.json();
                    const json = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text.replace(/```json|```/g, '').trim());

                    document.getElementById('soapS').value = json.s || ""; document.getElementById('soapO').value = json.o || "";
                    document.getElementById('soapA').value = json.a || ""; document.getElementById('soapP').value = json.p || "";
                    closeModal('magicSoapModal');
                } catch (error) { alert("Erro ao processar. Verifique API Key."); } finally { btn.innerHTML = oldHtml; btn.disabled = false; }
            }

            // --- AI TOOLS ---
            function renderAITools(filter = '') {
                const container = document.getElementById('aiToolsContainer');
                container.innerHTML = '';
                const filtered = AI_LIBRARY.filter(t => t.label.toLowerCase().includes(filter.toLowerCase()) || t.cat.toLowerCase().includes(filter.toLowerCase()));
                const cats = [...new Set(filtered.map(t => t.cat))];
                
                cats.forEach(cat => {
                    const section = document.createElement('div');
                    section.innerHTML = `<h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-3 ml-1 flex items-center gap-2">${cat}</h3>`;
                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3';
                    
                    grid.innerHTML = filtered.filter(t => t.cat === cat).map(t => {
                        const colorMap = {
                            'red': { card: 'bg-red-50 dark:bg-slate-800/60 dark:border-red-500/20', circle: 'bg-white/60 dark:bg-red-900/40', icon: 'text-red-600 dark:text-red-300', glow: 'dark:shadow-[0_0_15px_rgba(239,68,68,0.15)]' },
                            'blue': { card: 'bg-blue-50 dark:bg-slate-800/60 dark:border-blue-500/20', circle: 'bg-white/60 dark:bg-blue-900/40', icon: 'text-blue-600 dark:text-blue-300', glow: 'dark:shadow-[0_0_15px_rgba(59,130,246,0.15)]' },
                            'green': { card: 'bg-emerald-50 dark:bg-slate-800/60 dark:border-emerald-500/20', circle: 'bg-white/60 dark:bg-emerald-900/40', icon: 'text-emerald-600 dark:text-emerald-300', glow: 'dark:shadow-[0_0_15px_rgba(16,185,129,0.15)]' },
                            'orange': { card: 'bg-orange-50 dark:bg-slate-800/60 dark:border-orange-500/20', circle: 'bg-white/60 dark:bg-orange-900/40', icon: 'text-orange-600 dark:text-orange-300', glow: 'dark:shadow-[0_0_15px_rgba(249,115,22,0.15)]' },
                            'purple': { card: 'bg-purple-50 dark:bg-slate-800/60 dark:border-purple-500/20', circle: 'bg-white/60 dark:bg-purple-900/40', icon: 'text-purple-600 dark:text-purple-300', glow: 'dark:shadow-[0_0_15px_rgba(168,85,247,0.15)]' },
                            'indigo': { card: 'bg-indigo-50 dark:bg-slate-800/60 dark:border-indigo-500/20', circle: 'bg-white/60 dark:bg-indigo-900/40', icon: 'text-indigo-600 dark:text-indigo-300', glow: 'dark:shadow-[0_0_15px_rgba(99,102,241,0.15)]' },
                            'pink': { card: 'bg-pink-50 dark:bg-slate-800/60 dark:border-pink-500/20', circle: 'bg-white/60 dark:bg-pink-900/40', icon: 'text-pink-600 dark:text-pink-300', glow: 'dark:shadow-[0_0_15px_rgba(236,72,153,0.15)]' },
                            'teal': { card: 'bg-teal-50 dark:bg-slate-800/60 dark:border-teal-500/20', circle: 'bg-white/60 dark:bg-teal-900/40', icon: 'text-teal-600 dark:text-teal-300', glow: 'dark:shadow-[0_0_15px_rgba(20,184,166,0.15)]' },
                            'yellow': { card: 'bg-yellow-50 dark:bg-slate-800/60 dark:border-yellow-500/20', circle: 'bg-white/60 dark:bg-yellow-900/40', icon: 'text-yellow-600 dark:text-yellow-300', glow: 'dark:shadow-[0_0_15px_rgba(234,179,8,0.15)]' },
                            'slate': { card: 'bg-slate-100 dark:bg-slate-800/60 dark:border-slate-500/20', circle: 'bg-white/60 dark:bg-slate-700/50', icon: 'text-slate-600 dark:text-slate-300', glow: '' }
                        };
                        const theme = colorMap[t.color] || colorMap['slate'];
                        return `
                        <button onclick="app.callAI('${t.id}')" class="notebook-card relative p-3 rounded-2xl flex flex-col items-center justify-center min-h-[80px] text-center border-0 dark:border dark:backdrop-blur-md gap-2 ${theme.card} ${theme.glow} hover:bg-opacity-80 transition-all">
                            <div class="${theme.circle} p-2 rounded-full backdrop-blur-sm shrink-0 shadow-sm transition-colors">
                                <i data-lucide="${t.icon}" class="w-6 h-6 ${theme.icon}"></i>
                            </div>
                            <span class="text-[10px] font-bold leading-tight line-clamp-2 opacity-90 dark:text-slate-200">${t.label}</span>
                        </button>`;
                    }).join('');
                    
                    section.appendChild(grid);
                    container.appendChild(section);
                });
                lucide.createIcons();
            }
            function filterAITools() { renderAITools(document.getElementById('aiToolSearch').value); }

            async function callAI(toolId) {
                if(!state.config.apiKey) { alert("Configure a API Key!"); openModal('configModal'); return; }
                const tool = AI_LIBRARY.find(t => t.id === toolId);
                const s = document.getElementById('soapS').value;
                const o = document.getElementById('soapO').value;
                const a = document.getElementById('soapA').value;
                const p = document.getElementById('soapP').value;
                const meds = state.prescription.map(m => `${m.name} ${m.dose}`).join(', ');
                
                let prompt = tool.prompt.replace('{s}', s||'NI').replace('{o}', o||'NI').replace('{a}', a||'NI').replace('{p}', p||'NI').replace('{soap}', `S: ${s}\nO: ${o}\nA: ${a}\nP: ${p}`).replace('{meds}', meds||'Nenhuma');
                prompt += "\n\nIMPORTANTE: Responda em HTML usando classes TailwindCSS (ex: text-sm, font-bold, table w-full). NÃO use Markdown.";

                document.getElementById('aiModalTitle').innerText = tool.label;
                document.getElementById('aiModalContent').innerHTML = '<div class="flex justify-center py-10"><i data-lucide="loader" class="w-8 h-8 animate-spin text-indigo-600"></i></div>';
                lucide.createIcons(); openModal('aiModal');

                try {
                    let parts = [{ text: prompt }];
                    if (state.currentPatient.attachments && state.currentPatient.attachments.length > 0) {
                        state.currentPatient.attachments.forEach(att => {
                             parts.push({ inlineData: { mimeType: att.type, data: att.data } });
                        });
                    }
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.config.apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: parts }] })
                    });
                    const data = await response.json();
                    let html = data.candidates?.[0]?.content?.parts?.[0]?.text || "<p class='text-red-500'>Erro na geração.</p>";
                    document.getElementById('aiModalContent').innerHTML = html.replace(/```html|```/g, '');
                } catch(e) { document.getElementById('aiModalContent').innerHTML = `<p class="text-red-500">Erro: ${e.message}</p>`; }
            }

            // --- UPLOAD MÚLTIPLO ---
            function handleExamUpload(input) {
                const files = Array.from(input.files);
                if(!files.length) return;
                
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        state.currentPatient.attachments.push({
                            name: file.name,
                            type: file.type,
                            data: e.target.result.split(',')[1],
                            preview: e.target.result
                        });
                        updateExamPreviewList();
                    };
                    reader.readAsDataURL(file);
                });
                input.value = '';
            }

            function updateExamPreviewList() {
                const container = document.getElementById('examPreviewContainer');
                if (state.currentPatient.attachments.length === 0) {
                    container.classList.add('hidden');
                    return;
                }
                container.classList.remove('hidden');
                container.innerHTML = state.currentPatient.attachments.map((att, index) => `
                    <div class="flex items-center gap-3 p-2 bg-white dark:bg-slate-900 rounded border border-slate-200 dark:border-slate-700 shadow-sm">
                        <div class="w-10 h-10 bg-slate-100 dark:bg-slate-800 rounded flex items-center justify-center overflow-hidden border border-slate-200 shrink-0">
                            ${att.type.startsWith('image/') ? `<img src="${att.preview}" class="w-full h-full object-cover">` : `<i data-lucide="file-text" class="w-5 h-5 text-slate-400"></i>`}
                        </div>
                        <div class="flex-1 min-w-0">
                            <span class="text-[10px] font-bold text-slate-600 dark:text-slate-300 truncate block">${att.name}</span>
                            <span class="text-[10px] text-slate-400 uppercase">${att.type.split('/')[1] || 'FILE'}</span>
                        </div>
                        <button onclick="app.removeAttachment(${index})" class="text-slate-400 hover:text-red-500 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `).join('');
                
                const analyzeBtn = document.createElement('div');
                analyzeBtn.className = 'mt-1';
                analyzeBtn.innerHTML = `
                    <button onclick="app.callAI('lab_interpret')" class="w-full py-1.5 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 rounded text-xs font-bold border border-indigo-200 dark:border-indigo-800 hover:bg-indigo-100 transition flex items-center justify-center gap-2">
                        <i data-lucide="sparkles" class="w-3 h-3"></i> Analisar Todos com IA
                    </button>
                `;
                container.appendChild(analyzeBtn);
                lucide.createIcons();
            }

            function removeAttachment(index) {
                state.currentPatient.attachments.splice(index, 1);
                updateExamPreviewList();
            }

            function clearExamImage() { state.currentPatient.attachments = []; updateExamPreviewList(); }

            // --- RENDER DOCUMENTO ---
            function updateDocumentView() {
                const paper = document.getElementById('prescriptionPaper');
                const c = state.config;
                const patientName = document.getElementById('patientNameInput').value || "__________________________";
                const dateStr = new Date().toLocaleDateString('pt-BR');

                if (state.activeDocument === 'hospital') {
                    paper.className = "print-container bg-white text-slate-900 shadow-paper relative flex flex-col transition-all duration-300 origin-top w-[1120px] min-h-[790px]"; 
                    let rows = state.hospitalLines.map((val, i) => `
                        <div class="flex border-b border-slate-300 min-h-[32px] items-stretch group hover:bg-slate-50">
                            <div class="w-10 border-r border-slate-300 flex items-center justify-center font-bold text-sm text-slate-400 select-none">${i+1}</div>
                            <div class="flex-1 relative"><input type="text" class="hospital-input" value="${val}" oninput="app.updateHospitalLine(${i}, this.value)"></div>
                            <button onclick="app.removeHospitalLine(${i})" class="w-8 flex items-center justify-center text-slate-300 hover:text-red-500 no-print transition-colors" tabindex="-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    `).join('');

                    paper.innerHTML = `
                        <div class="h-full flex flex-col p-8 font-sans">
                            <div class="border border-slate-800 mb-4">
                                <div class="flex border-b border-slate-800"><div class="flex-1 p-2 border-r border-slate-800"><span class="text-[10px] font-bold uppercase block">Nome Paciente</span><div class="font-bold uppercase text-lg truncate">${patientName}</div></div><div class="w-64 p-2"><span class="text-[10px] font-bold uppercase block">Médico Responsável</span><div class="truncate text-sm">${c.name}</div></div></div>
                                <div class="flex"><div class="w-32 p-2 bg-slate-100 border-r border-slate-800 flex flex-col justify-center items-center text-center"><span class="text-[10px] font-bold block uppercase">DATA</span><div class="font-mono font-bold">${dateStr}</div></div><div class="flex-1 p-2 flex items-center justify-center bg-slate-50 border-r border-slate-800"><h2 class="text-xl font-black uppercase tracking-widest">Prescrição Médica</h2></div><div class="w-32 p-2 flex flex-col justify-center border-r border-slate-800"><span class="text-[10px] font-bold uppercase block">Leito</span><input class="w-full bg-transparent outline-none font-mono" placeholder="___"></div><div class="w-32 p-2 flex flex-col justify-center"><span class="text-[10px] font-bold uppercase block">Prontuário</span><input class="w-full bg-transparent outline-none font-mono" placeholder="___"></div></div>
                            </div>
                            <div class="flex-1 border border-slate-800 flex flex-col mb-4 bg-white"><div class="bg-slate-100 border-b border-slate-800 p-1 text-center text-[10px] font-bold uppercase tracking-wider">Itens da Prescrição</div><div class="flex-1 flex flex-col">${rows}<button onclick="app.addHospitalLine()" class="no-print w-full py-2 text-xs font-bold text-slate-400 hover:text-indigo-600 hover:bg-slate-50 transition flex items-center justify-center gap-1 border-b border-dashed border-slate-300"><i data-lucide="plus" class="w-3 h-3"></i> Adicionar Linha</button></div></div>
                            <div class="border border-slate-800 p-2 flex min-h-[80px]"><div class="flex-1 pr-4 border-r border-slate-800"><span class="text-[10px] font-bold uppercase block mb-1">Anotações / Enfermagem</span><textarea class="w-full h-full bg-transparent resize-none outline-none text-sm font-mono"></textarea></div><div class="w-64 flex flex-col items-center justify-end pl-4"><div class="w-full border-t border-slate-800 mt-8 pt-1 text-center"><div class="text-xs font-bold uppercase">${c.name}</div><div class="text-[10px] text-slate-500">${c.crm}</div></div></div></div>
                        </div>`;
                } else {
                    paper.className = "print-container bg-white text-slate-900 shadow-paper relative flex flex-col transition-all duration-300 origin-top w-[600px] min-h-[840px]";
                    let content = state.activeDocument === 'exams' 
                        ? (state.examRequest.length ? `<ul class="list-disc pl-8 space-y-2 font-serif text-slate-800">${state.examRequest.map((e,i) => `<li class="group relative pl-2"><span class="text-lg">${e.name}</span><button onclick="app.removeExamRequest(${i})" class="no-print absolute -left-6 top-1 text-slate-300 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button></li>`).join('')}</ul>` : '<div class="text-center text-slate-300 italic mt-10">Nenhum exame selecionado</div>') 
                        : (state.prescription.length ? state.prescription.map((m, i) => `<div class="mb-6 group relative border-l-2 border-transparent hover:border-slate-200 pl-4 transition-colors"><div class="flex justify-between items-baseline"><div class="font-bold text-lg text-slate-800 font-serif">${i+1}. ${m.name} ${m.dose}</div><button onclick="app.removePrescriptionItem('${m.uid}')" class="no-print text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div><div class="text-slate-600 mt-1 font-medium">${m.instruction}</div></div>`).join('') : '<div class="text-center text-slate-300 italic mt-10">Nenhum medicamento prescrito</div>');

                    paper.innerHTML = `
                        <div class="px-10 pt-10 pb-6 border-b-2 border-emerald-500/20 flex justify-between items-start"><div class="flex gap-4 items-center"><div class="w-16 h-16 bg-emerald-600 rounded-full flex items-center justify-center text-white font-bold text-2xl shadow-lg">${c.logoUrl ? `<img src="${c.logoUrl}" class="w-full h-full object-cover rounded-full">` : c.name[0]}</div><div><h1 class="text-xl font-bold text-slate-900 uppercase tracking-wide">${c.name}</h1><p class="text-xs text-slate-500 uppercase tracking-widest font-bold">${c.specialty}</p><p class="text-xs text-slate-400 mt-0.5">CRM: ${c.crm}</p></div></div><div class="text-right"><div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Emissão</div><div class="text-lg font-mono text-slate-700">${dateStr}</div></div></div>
                        <div class="px-12 py-8 flex-1"><div class="mb-10 pb-2 border-b border-dashed border-slate-200"><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Paciente</span><div class="text-xl font-serif text-slate-900 capitalize">${patientName}</div></div><div class="text-center mb-8"><span class="px-4 py-1 border border-slate-800 rounded-full text-xs font-bold uppercase tracking-widest">${state.activeDocument === 'exams' ? 'Pedido de Exames' : 'Receituário Médico'}</span></div><div>${content}</div></div>
                        <div class="mt-auto p-10 text-center border-t border-emerald-500/10 bg-emerald-50/30"><div class="w-48 h-px bg-slate-800 mx-auto mb-4"></div><p class="text-sm font-bold text-slate-900 uppercase">${c.name}</p><p class="text-[10px] text-slate-500 mt-1">${c.address} • ${c.phone}</p></div>`;
                }
                lucide.createIcons();
            }

            // --- UTILS & RENDERS ---
            function addToPrescription(id) { const m = state.meds.find(m => m.id === id); if(m) { state.prescription.push({ ...m, uid: crypto.randomUUID() }); const emptyIdx = state.hospitalLines.findIndex(l => l===""); if(emptyIdx!==-1) state.hospitalLines[emptyIdx] = `${m.name} ${m.dose} - ${m.instruction}`.toUpperCase(); updateDocumentView(); }}
            function removePrescriptionItem(uid) { state.prescription = state.prescription.filter(i => i.uid !== uid); updateDocumentView(); }
            function addToExamRequest(name) { state.examRequest.push({ name, uid: crypto.randomUUID() }); updateDocumentView(); }
            function removeExamRequest(index) { state.examRequest.splice(index, 1); updateDocumentView(); }

            // RENDER MEDS AGRUPADOS POR CLASSE
            function renderMeds() { 
                const s = document.getElementById('medSearch').value.toLowerCase();
                const container = document.getElementById('medicationList');
                
                const filtered = state.meds.filter(m => m.name.toLowerCase().includes(s) || m.category.toLowerCase().includes(s));
                
                // Agrupar
                const grouped = filtered.reduce((acc, med) => {
                    acc[med.category] = acc[med.category] || [];
                    acc[med.category].push(med);
                    return acc;
                }, {});

                container.innerHTML = Object.keys(grouped).sort().map(cat => `
                    <div class="sticky-header bg-slate-100/90 dark:bg-slate-800/90 backdrop-blur-sm p-2 text-[10px] font-black uppercase tracking-widest text-slate-500 dark:text-slate-400 mb-1 border-b border-slate-200 dark:border-slate-700">
                        ${cat}
                    </div>
                    <div class="space-y-1 mb-4">
                        ${grouped[cat].map(m => `
                            <button onclick="app.addToPrescription(${m.id})" class="w-full text-left px-3 py-2 rounded-lg bg-white dark:bg-slate-800/40 border border-slate-100 dark:border-slate-700/50 hover:border-emerald-500 hover:shadow-sm transition group">
                                <div class="font-bold text-sm text-slate-700 dark:text-slate-200 group-hover:text-emerald-600">${m.name}</div>
                                <div class="text-[10px] text-slate-400">${m.dose}</div>
                            </button>
                        `).join('')}
                    </div>
                `).join('');
            }

            // RENDER EXAMS HIERARQUIZADOS (PASTAS)
            function renderExams() { 
                const s = document.getElementById('examSearch').value.toLowerCase();
                const container = document.getElementById('examList');
                let html = '';

                // Se houver busca, mostra lista plana filtrada para agilidade
                if (s.length > 0) {
                     let results = [];
                     Object.keys(EXAM_CATALOG).forEach(mainCat => {
                        Object.keys(EXAM_CATALOG[mainCat]).forEach(subCat => {
                            EXAM_CATALOG[mainCat][subCat].forEach(exam => {
                                if(exam.toLowerCase().includes(s)) results.push({ name: exam, cat: `${mainCat} > ${subCat}` });
                            });
                        });
                     });
                     
                     html = results.map(r => `
                        <button onclick="app.addToExamRequest('${r.name}')" class="w-full text-left px-3 py-2.5 rounded-lg bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 hover:border-orange-500 hover:shadow-sm transition mb-2">
                             <div class="font-medium text-sm text-slate-700 dark:text-slate-200 group-hover:text-orange-600">${r.name}</div>
                             <div class="text-[10px] text-slate-400">${r.cat}</div>
                        </button>
                     `).join('');
                     if (results.length === 0) html = '<div class="text-center text-slate-400 text-xs py-4">Nenhum exame encontrado</div>';
                
                } else {
                    // Sem busca: Mostra estrutura de pastas hierárquica
                    Object.keys(EXAM_CATALOG).forEach(mainCat => {
                        html += `<div class="mb-4">
                            <h3 class="text-xs font-black uppercase text-slate-400 mb-2 px-1 flex items-center gap-2"><i data-lucide="folder" class="w-3 h-3"></i> ${mainCat}</h3>
                            <div class="space-y-3 pl-2 border-l border-slate-200 dark:border-slate-800 ml-1">`;
                            
                        Object.keys(EXAM_CATALOG[mainCat]).forEach(subCat => {
                            html += `
                                <div>
                                    <h4 class="text-[10px] font-bold text-slate-500 dark:text-slate-400 mb-1 px-2 uppercase tracking-wide">${subCat}</h4>
                                    <div class="grid grid-cols-1 gap-1">
                                        ${EXAM_CATALOG[mainCat][subCat].map(exam => `
                                            <button onclick="app.addToExamRequest('${exam}')" class="text-left px-3 py-1.5 rounded-md hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 text-xs transition truncate border border-transparent hover:border-slate-200 dark:hover:border-slate-700">
                                                ${exam}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    });
                }
                container.innerHTML = html;
                lucide.createIcons();
            }

            function searchPatient() { updateDocumentView(); }
            function clearPatientData() { document.getElementById('patientNameInput').value = ""; document.getElementById('soapS').value = ""; document.getElementById('soapO').value = ""; document.getElementById('soapA').value = ""; document.getElementById('soapP').value = ""; state.prescription = []; state.examRequest = []; state.hospitalLines = Array(15).fill(""); state.currentPatient.attachments = []; updateExamPreviewList(); updateDocumentView(); }
            
            function updateConfigUI() {
                document.getElementById('cfgName').value = state.config.name; document.getElementById('cfgSpec').value = state.config.specialty;
                document.getElementById('cfgCrm').value = state.config.crm; document.getElementById('cfgPhone').value = state.config.phone;
                document.getElementById('cfgAddress').value = state.config.address || ""; document.getElementById('cfgLogo').value = state.config.logoUrl || "";
                document.getElementById('apiKeyInput').value = state.config.apiKey || "";
                if(state.config.apiKey) document.getElementById('apiKeyStatus').classList.replace('bg-red-500', 'bg-emerald-500');
            }
            function saveConfig() {
                state.config = { name: document.getElementById('cfgName').value, specialty: document.getElementById('cfgSpec').value, crm: document.getElementById('cfgCrm').value, phone: document.getElementById('cfgPhone').value, address: document.getElementById('cfgAddress').value, logoUrl: document.getElementById('cfgLogo').value, apiKey: document.getElementById('apiKeyInput').value };
                localStorage.setItem('neuro_config', JSON.stringify(state.config)); updateConfigUI(); updateDocumentView(); closeModal('configModal');
            }
            function copyAIContent() { const r = document.createRange(); r.selectNode(document.getElementById('aiModalContent')); window.getSelection().removeAllRanges(); window.getSelection().addRange(r); document.execCommand('copy'); alert("Copiado!"); }
            function generatePDF() { const el = document.getElementById('prescriptionPaper'); let opt = { margin: 0, filename: 'documento.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: state.activeDocument === 'hospital' ? 'landscape' : 'portrait' } }; html2pdf().set(opt).from(el).save(); }
            function openConfigMedModal() { openModal('addMedModal'); }
            function addNewMedication() { const n = document.getElementById('newMedName').value; if(n) { state.meds.push({ id: Date.now(), name: n, dose: document.getElementById('newMedDose').value, instruction: document.getElementById('newMedInstr').value, category: document.getElementById('newMedCat').value }); localStorage.setItem('neuro_meds', JSON.stringify(state.meds)); renderMeds(); closeModal('addMedModal'); } }

            return {
                init, toggleTheme, openModal, closeModal, switchTab, setDocumentMode, toggleSidebar, updateHospitalLine, removeHospitalLine, addHospitalLine,
                openMagicSoap, generateMagicSoap, handleExamUpload, removeAttachment, clearExamImage, renderAITools, filterAITools, callAI,
                addToPrescription, removePrescriptionItem, renderMeds, renderExams, addToExamRequest, removeExamRequest, searchPatient, clearPatientData, saveConfig, copyAIContent, generatePDF, openConfigMedModal, addNewMedication, toggleMobileDoc
            };
        })();
        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
